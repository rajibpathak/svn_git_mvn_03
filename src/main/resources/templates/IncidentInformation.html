<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<title class="IncidentSidebar">Incident Information</title>
<div th:replace="~{fragments/head :: head}"></div>

<!-- <script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->



<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->

<body class="mod-bg-1 mod-nav-link">

	<!-- BEGIN Page Wrapper -->
	<div th:replace="~{fragments/header :: header}"></div>
	<div th:replace="~{fragments/navmenus :: navmenus}"></div>
	<div class="page-wrapper">
		<div class="page-inner">
			<!-- BEGIN Left Aside -->
			<div th:replace="~{fragments/sidebar :: sidebar}"></div>
			<!-- END Left Aside -->
			<div class="page-content-wrapper">
				<!-- BEGIN Page Content -->
				<!-- the #js-page-content id is needed for some plugins to initialize -->
				<main id="js-page-content" role="main" class="page-content">
					<!-- <ol class="breadcrumb page-breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0);">SmartAdmin</a></li>
                            <li class="breadcrumb-item">category_1</li>
                            <li class="breadcrumb-item">category_2</li>
                            <li class="breadcrumb-item active">Page Titile</li>
                            <li class="position-absolute pos-top pos-right d-none d-sm-block"><span class="js-get-date"></span></li>
                        </ol> -->
					<div class="subheader mb-1">
						<h1 class="subheader-title">

							<div th:replace="~{fragments/toggleMenu :: toggleMenu}"></div>
							<i class='subheader-icon fal fa-'></i> <span id="screenNameHolder"
								th:data-name="${screenCode}" th:text="${screenName}"></span></span>
							<!-- <i class='subheader-icon fal fa-'></i> INCIDENT INFORMATION - DIS_INCT</span> -->
						</h1>

						<div class="d-flex align-items-center topheadRightSideBlock">
							<div class="btn-group">
								<div class="mr-2 d-flex align-items-center">
									<div class="js-get-date">[your date here]</div>
								</div>
							</div>
							<a href="javascript:void(0);"
								class="btn btn-sm btn-primary btn-icon waves-effect waves-themed mr-2"
								data-toggle="tooltip" id="add" data-placement="top" data-original-title="Add">
								<i class="fal fa-plus"></i>
							</a>
							<a href="javascript:void(0);"
								class="btn btn-sm btn-primary btn-icon waves-effect waves-themed mr-2"
								data-toggle="tooltip" data-placement="top" data-original-title="Print">
								<i class="fal fa-print"></i>
							</a>
							<a href="javascript:void(0);"
								class="btn btn-sm btn-secondary btn-icon waves-effect waves-themed mr-2"
								data-toggle="tooltip" id="clear" data-placement="top" data-original-title="Clear">
								<i class="fal fa-times"></i>
							</a>
							<a href="javascript:void(0);"
								class="btn btn-sm btn-success btn-icon waves-effect waves-themed mr-2"
								data-toggle="tooltip" id="save" data-placement="top" data-original-title="OK/Save">
								<i class="fal fa-save"></i>
							</a>
							<a href="javascript:void(0);"
								class="btn btn-sm btn-danger btn-icon waves-effect waves-themed" data-toggle="tooltip"
								data-placement="top" data-original-title="Cancel/Exit">
								<i class="fal fa-sign-out"></i>
							</a>
						</div>

					</div>

					<div class="row">
						<div class="col-xl-12">
							<div class="panel mb-2">
								<div class="panel-container show">
									<div class="panel-content p-2">
										<form>
											<div class="row form-group mt-1">
												<div class="col-lg-9">
													<div class="row">
														<input type="hidden" id="typ_val">
														<input type="hidden" id="title_val">
														<input type="hidden" id="race_val">
														<input type="hidden" id="category_val">
														<input type="hidden" id="nature_inj_val">
														<input type="hidden" id="evidence_typ_val">
														<input type="hidden" id="indv_data">
														<input type="hidden" id="current_fld">
														<input type="hidden" id="curr_indv_fld">
														<input type="hidden" id="curr_vctm_fld">
														<input type="hidden" id="curr_eve_fld">
														<input type="hidden" id="curr_sup_fld">
														<input type="hidden" id="asn_curr_id">
														<input type="hidden" id="myTitle">


														<!--<div class="col-12 col-md-4 col-lg-3 col-xl-2 mt-xl-2 pr-0 selectFloatingLabel">
															<label class="form-label mr-2 mb-0 control-label selectFloating">Institution</label>
															<div class="search-box">
																<input type="text" class="autoCompleteInput"
																	placeholder="Search..." oninput="filterOptions(this)"
																	onclick="showDropdown(this)" onfocus="showDropdown(this)">
																
																<div class="autoCompleteDropdown" id="institution">
																	<div onclick="selectOption(this)" data-id="IN">Test</div>
																	<div onclick="selectOption(this)" data-id="TE">Test1</div>
																	<div onclick="selectOption(this)" data-id="T1">Test2</div>
																</div>
															</div>
														</div>-->

														<div
															class="col-12 col-md-4 pr-md-2 col-lg-4 pr-lg-3 col-xl-3 pr-xl-0 mt-xl-2 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="institution_val" name="" value=""
																data-fld="institution_val_fld" data-lbl="Institution"
																placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Institution</label>
															<input type="hidden" id="institution">
														</div>

														<!--<div
															class="col-12 col-md-4 col-lg-3 col-xl-2 mt-xl-2 pr-0 selectFloatingLabel">
															<label
																class="form-label mr-2 mb-0 control-label selectFloating">Institution</label>
															<input type="text"
																class="form-control w-100 floatingLableClick"
																id="institution" autocomplete="off">
															<select class="select2 form-control w-100 floatingLableClick"
																												id="institution">
																												<optgroup>
																													<option value="IN">Insitution</option>
																													<option value="TE">test</option>
																												</optgroup>
																											</select>-->
														<!--</div>-->

														<!--<div class="col-12 col-md-4 col-lg-3 col-xl-2 mt-xl-2 pr-0 selectFloatingLabel">
															<label class="form-label mr-2 mb-0 control-label selectFloating">Insitution</label>
															<select class="custom-select form-control typecontact d-block mb-1 floatingLableClick" id="selectCtrl">
																<option>Insitution</option> 
																<option value="Option 1">test</option>
																<option value="Option 2">test1</option>
															</select>
		                                                </div>-->
														<div
															class="col-12 col-md-4 col-lg-5 col-xl-4 mt-xl-2 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="incidentNo" name="" value=""
																data-fld="incidentNo_fld" data-lbl="Incident#"
																placeholder="" readonly>
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Incident#</label>
															<input type="hidden" id="incidentNoHide">
															<span data-toggle="modal" data-target="#selectIncidentModal"
																class="ml-2">
																<a href="javascript:void(0);"
																	class="btn btn-primary btn-sm btn-icon waves-effect waves-themed mr-2"
																	data-toggle="tooltip" data-placement="top"
																	data-original-title="Select Incident list"> <i
																		class="fa fa-download"></i>
																</a>
															</span>
															<span data-toggle="modal"
																data-target="#groupSupplementaryModal">
																<a href="javascript:void(0);"
																	class="btn btn-primary btn-sm btn-icon waves-effect waves-themed mr-2"
																	data-toggle="tooltip" data-placement="top"
																	data-original-title="Group / Supplementary">
																	<span>G</span>
																</a>
															</span>
															<!--<span data-toggle="modal" data-target="#groupSupplementaryModal" class="ml-2 d-flex">
																<button class="btn btn-primary btn-sm" style="font-size: 20px; padding: 0 5px; padding-left: 5px;">G</button>
															</span>-->
														</div>
														<div
															class="col-12 col-md-4 mt-md-3 pr-md-2 col-lg-4  mt-lg-3 pr-lg-2 col-xl-2 mt-xl-2 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="groupNo" name="" value=""
																data-fld="groupNo_fld" data-lbl="Group#" placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Group#</label>
														</div>
														<div
															class="col-12 col-md-4 mt-md-2 col-lg-3 col-xl-3 mt-xl-2 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="cellSrchNo" name="" value=""
																data-fld="cellSrchNo_fld" data-lbl="Cell Search#"
																placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Cell
																Search#</label>
															<span data-toggle="modal"
																data-target="#selectCellSearchModal" id="cellSrchBtn"
																class="ml-2">
																<a href="javascript:void(0);"
																	class="btn btn-primary btn-sm btn-icon waves-effect waves-themed mr-2"
																	data-toggle="tooltip" data-placement="top"
																	data-original-title="Cell Search list"> <i
																		class="fa fa-download"></i>
																</a>
															</span>
														</div>
														<div id="mdPicker"
															class="col-12 col-md-2 mt-md-2 col-lg-3 mt-lg-2 col-xl-2 mt-xl-3 pr-0 d-flex align-itens-center floatingFields w-100 input-append date">
															<input
																class="span2 form-control w-100 floatingLable dtfld rawField"
																autocomplete="off" size="16" type="text" aria-label=""
																data-fld="inciDt_fld" data-lbl="Date" name=""
																id="inciDt" value="" placeholder="">
															<label for="Name"
																class="form-label mr-2 text-nowrap mb-0">Date
															</label>
															<span class="add-on"></span>
														</div>
														<div
															class="col-12 col-md-2 mt-md-2 pr-md-0 col-lg-2 mt-lg-2 pr-lg-2 col-xl-1 pr-xl-0 mt-xl-3 d-flex align-items-center floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable tmfld rawField"
																aria-label="" id="inciTm" name="" value="" maxlength="5"
																data-fld="inciTm_fld" data-lbl="Time" placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Time
															</label>
														</div>
														<div
															class="col-12 col-md-4 pr-md-2 mt-md-2 col-lg-4 pr-lg-2 col-xl-3 pr-xl-0 mt-xl-3 d-flex align-items-center floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="supplimentTo" name="" value=""
																data-fld="supplimentTo_fld" data-lbl="Supplement To"
																placeholder="" readonly disabled>
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Supplement
																To</label>
														</div>
														<div
															class="col-12 col-md-4 col-lg-8 pr-lg-2 col-xl-6 mt-xl-3 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="shortDesc" name="" value=""
																maxlength="150" data-fld="shortDesc_fld"
																data-lbl="ShortDesc.">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">ShortDesc.</label>
														</div>

														<div
															class="col-12 col-md-4 pr-md-2 col-lg-4 pr-lg-2 col-xl-3 pr-xl-0 mt-xl-3 d-flex align-items-center floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="incident_tp_val" name="" value=""
																data-fld="incident_tp_val_fld" data-lbl="Incident Type"
																placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Incident Type
															</label>
															<input type="hidden" id="incident_tp">
														</div>


														<!--<div
															class="col-12 col-md-4 pr-md-0 col-lg-3 col-xl-2 pr-xl-2 mt-xl-3 d-flex align-items-center selectFloatingLabel">
															<label
																class="form-label mr-2 mb-0 control-label selectFloating">Incident
																Type <span class="text-danger">*</span></label>
															<select class="select2 form-control w-100 floatingLableClick"
																id="incident_tp">
																<optgroup>
																	<option value="">Incident Type</option>
																	<option value="01">Inmate Involved</option>
																	<option value="02">Civilian Involved</option>
																	<option value="03">Staff Involved</option>
																	<option value="04">Others Involved</option>
																	<option value="05">FYI</option>
																	<option value="06">QRT Escort</option>
																</optgroup>
															</select>
														</div>-->
														<!--<div class="col-12 col-md-4 col-lg-3 col-xl-2 mt-xl-3 pr-0 d-flex align-items-center floatingFields">
															<input type="text" class="form-control w-100 floatingLable"
																aria-label="" id="supple-ment" name="" value="" placeholder="">
															<label for="Name" class="form-label mr-1 text-nowrap mb-0">Supplement # <span class="text-danger">*</span></label>
															<input type="hidden" id="supple-ment">
														</div>-->

														<div
															class="col-12 col-md-4 pr-md-2 col-lg-4 pr-lg-2 col-xl-3 pr-xl-0 mt-xl-3 d-flex align-items-center pr-0 floatingFields">
															<input type="text"
																class="form-control w-100 floatingLable rawField"
																aria-label="" id="location_val" name="" value=""
																data-fld="location_val_fld"
																data-lbl="Location of Occurence" placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Location of
																Occurrence</label>
															<input type="hidden" id="location">
														</div>

														<!--<div
															class="col-12 col-md-3 col-lg-6 pr-lg-2 col-xl-3 mt-xl-3 d-flex align-items-center selectFloatingLabel">
															<label class="form-label mr-2 mb-0 control-label selectFloating"
																style="left: 5px;">Location of Occurrence<span
																	class="text-danger">*</span></label>
															<select class="select2 form-control w-100 floatingLableClick"
																id="location">
																<optgroup>
																	<option value="IN">Location of Occurrence</option>
																	<option value="TE">test</option>
																</optgroup>
															</select>
														</div>-->
														<div
															class="col-12 col-md-2 col-lg-4 pr-lg-2 col-xl-2 pr-xl-0 mt-xl-3 d-flex align-items-center floatingFields loactionDesc">
															<input type="text"
															    class="form-control w-100 floatingLable rawField"
															    aria-label="" id="locationDesc" name="" value=""
															    data-fld="locationDesc_fld" data-lbl="Location Desc."
															    maxlength="100" placeholder="">
															<label for="Name"
																class="form-label mr-1 text-nowrap mb-0">Location
																Desc.</label>
														</div>
														<!--<div class="col-12 col-md-3 col-lg-3 pr-lg-2 col-xl-2 pr-xl-0 mt-xl-3 d-flex align-items-center floatingFields">													 	
															<input type="text" class="form-control w-100 floatingLable"
																aria-label="" id="report-num" name="" value="" placeholder="">
															<label for="Name" class="form-label mr-1 text-nowrap mb-0">D Report Num</label>
														</div>-->
														<div
															class="col-12 col-md-4 col-lg-4 col-xl-3 mt-xl-3 d-flex align-items-center">
															<div
																class="custom-control custom-checkbox custom-control-inline ml-2">
																<input type="checkbox"
																    class="custom-control-input rawField"
																    id="defaultInline1" data-fld="defaultInline1_fld"
																    data-lbl="PREA">
																<label class="custom-control-label"
																	for="defaultInline1">PREA</label>
															</div>
															<div
																class="custom-control custom-checkbox custom-control-inline">
																<input type="checkbox"
																    class="custom-control-input rawField"
																    id="defaultInline2" data-fld="defaultInline2_fld"
																    data-lbl="Confidential">
																<label class="custom-control-label"
																	for="defaultInline2">Confidential</label>
															</div>
															<div
																class="custom-control custom-checkbox custom-control-inline">
																<input type="checkbox"
																    class="custom-control-input rawField"
																    id="defaultInlined" data-fld="defaultInlined"
																    data-lbl="STG">
																<label class="custom-control-label"
																	for="defaultInlined">STG</label>
															</div>
														</div>
													</div>
												</div>
												<div class="col-lg-3">
													<div class="row mx-1">
														<div class="col-lg-6 px-0">
															<div id="incidentHeader-table" class="w-100"></div>
														</div>
														<div class="col-lg-6 pr-0">
															<div id="incidentHeadernum-table" class="w-100"></div>
														</div>
													</div>
												</div>

											</div>
										</form>
									</div>
								</div>
							</div>
							<div class="panel">
								<div class="panel-content">
									<div class="d-flex align-items-center">
										<div id="innavleftArrow">
											<i class="fa fa-angle-left btn px-1" aria-hidden="true"
												style="font-size:25px;"></i>
										</div>
										<ul class="nav nav-tabs text-nowrap tabsBlock" role="tablist"
											style="flex-wrap: nowrap; overflow-y: hidden;">
											<li class="nav-item"><a class="nav-link active" id="gen_tab"
													data-toggle="tab" href="#General_Information" role="tab">General
													Information</a></li>
											<li class="nav-item"><a class="nav-link" id="ind_tab" data-toggle="tab"
													href="#Individuals_Involved" role="tab">Individuals Involved</a>
											</li>
											<li class="nav-item"><a class="nav-link" data-toggle="tab"
													href="#IncidentInfoIncidentDetailNew_Tab" role="tab">Incident
													Details</a></li>
											<li class="nav-item"><a class="nav-link" id="ref_tab" data-toggle="tab"
													href="#IncidentInfoRefferals_Tab12" role="tab">Referrals</a></li>
											<li class="nav-item"><a class="nav-link" data-toggle="tab"
													href="#IncidentInfofollowupinfo_Tab" role="tab">Follow-Up
													Information</a></li>
											<li class="nav-item"><a class="nav-link" id="sup_tab" data-toggle="tab"
													href="#IncidentInfoSupervisor_Tab" role="tab">Supervisor Details</a>
											</li>
											<li class="nav-item"><a class="nav-link" data-toggle="tab"
													href="#approval_Tab" role="tab">Approval</a>
											</li>
											<li class="nav-item nav-assign nav-disable"><a class="nav-link"
													data-toggle="tab" href="#assignInvestigator_Tab12" id="asn_tab"
													role="tab">Assign
													Investigator</a>
											</li>
											<li class="nav-item"><a class="nav-link" data-toggle="tab"
													href="#auditTrail_Tab" role="tab">Audit Trail</a>
											</li>
										</ul>
										<div id="innavRightArrow">
											<i class="fa fa-angle-right btn px-1 ml-auto" aria-hidden="true"
												style="font-size:25px;"></i>
										</div>
									</div>
									<div class="tab-content p-2">
										<div class="tab-pane fade show active" id="General_Information" role="tabpanel">
											<div id="generalinfoTable" class="panel mb-0">
												<div class="panel-hdr justify-content-end">
													<!--<h2>General Information</h2>-->
												</div>
												<div class="panel-container show">
													<div class="panel-content">
														<div id="js-checkbox-toggles">
															<div id="generalinfo-table"></div>
															<div class="form-group mt-3 floatingFieldsTextarea">

																<textarea
																	class="form-control floatingLabletextarea rawField"
																	id="inciDesc" placeholder="" 
																	rows="5" data-fld="inciDesc_fld"
																	data-lbl="Incident Description"></textarea>
																<label class="form-label" placeholder=""
																	for="example-textarea">Incident
																	Description </label>

																<!----	<div class="charCount"><span
																		id="inciCount">0</span>/2000 characters</div> -->
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="tab-pane fade" id="Individuals_Involved" role="tabpanel">
											<div id="individualsInfoblock" class="panel mb-0">
												<div class="panel-hdr justify-content-end">
													<!--<h2>Individuals Involved</h2>-->
													<div class="d-flex align-items-center justify-content-end">
														<span class="d-flex mr-2">
															<a href="javascript:void(0);" id="newInci"
																class="btn btn-primary btn-sm btn-icon waves-effect waves-themed headingIconsBlock mr-1"
																data-toggle="tooltip" data-placement="top"
																data-original-title="New">
																<i class="fa-solid fa-plus"></i>
															</a>
														</span>
														<span class="d-flex mr-2">
															<a href="javascript:void(0);" id="delInci"
																class="btn btn-danger btn-sm btn-icon waves-effect waves-themed headingIconsBlock mr-1"
																data-toggle="tooltip" data-placement="top"
																data-original-title="Delete"> <i
																	class="fa-solid fa-trash"></i>
															</a>
														</span>
														<span class="d-flex">
															<a href="javascript:void(0);"
																class="btn btn-primary btn-sm btn-icon waves-effect waves-themed headingIconsBlock mr-1"
																data-toggle="tooltip" data-placement="top"
																data-original-title="Disciplinary Information"> <i
																	class="fa-solid fa-info"></i>
															</a>
														</span>
													</div>
												</div>
												<div class="panel-container show">
													<div class="panel-content">
														<div id="js-checkbox-toggles">
															<div id="individualsInvolved-table"></div>
															<div class="panel-content px-0 pb-0">
																<form>
																	<div class="form-group row">
																		<div class="col-12 col-md-12 col-lg-4 pr-0">
																			<div id="typeforce-table"></div>
																		</div>
																		<div
																			class="col-12 col-md-12 mt-md-2 pr-md-0  col-lg-4 mt-lg-0 pr-0">
																			<div id="typerestraint-table"></div>
																		</div>
																		<div
																			class="col-12 col-md-12 mt-md-2 pr-md-0  col-lg-4 mt-lg-0 pr-lg-2">
																			<div id="actionTaken-table"></div>
																		</div>
																	</div>

																</form>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div id="panel-1" class="panel mb-0 mt-2">
												<div class="panel-hdr">
													<h2>
														Inmate Housing Details
													</h2>
												</div>
												<div class="panel-container show">
													<div class="panel-content">
														<div id="js-checkbox-toggles">
															<div>
																<div class="row">
																	<div
																		class="col-12 col-md-4 pr-md-0 col-lg-12 d-flex align-items-center floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled
																			id="houseDtlInsitution"
																			data-fld="houseDtlInsitution_fld"
																			data-lbl="Insitution">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Insitution</label>
																	</div>
																	<div
																		class="col-12 col-md-4 mt-md-0 col-lg-4 mt-lg-3 d-flex align-items-center pr-0 floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtBuilding"
																			data-fld="houseDtBuilding_fld"
																			data-lbl="Building">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Building</label>
																	</div>
																	<div
																		class="col-12 col-md-4 mt-md-0 col-lg-4 mt-lg-3 d-flex align-items-center pr-0 floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtFloor"
																			data-fld="houseDtFloor_fld"
																			data-lbl="Floor">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Floor</label>
																	</div>
																	<div
																		class="col-12 col-md-4 pr-md-0 col-lg-4 mt-lg-3 d-flex align-items-center floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtCell"
																			data-fld="houseDtCell_fld" data-lbl="Cell">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Cell</label>
																	</div>
																	<div
																		class="col-12 col-md-4 col-lg-4 mt-lg-3 d-flex align-items-center pr-0 floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtWing"
																			data-fld="houseDtWing_fld"
																			data-lbl="Wing/Unit">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Wing/Unit</label>
																	</div>
																	<div
																		class="col-12 col-md-4 col-lg-4 mt-lg-3 d-flex align-items-center pr-0 floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtTier"
																			data-fld="houseDtTier_fld"
																			data-lbl="Tier/Pod">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Tier/Pod</label>
																	</div>
																	<div
																		class="col-12 col-md-4 pr-md-0 col-lg-4 mt-lg-3 d-flex align-items-center floatingFields">
																		<input type="text"
																			class="form-control floatingLable hsdt rawField"
																			placeholder="" disabled id="houseDtBed"
																			data-fld="houseDtBed_fld" data-lbl="Bed">
																		<label for="Name"
																			class="form-label mr-1 text-nowrap mb-0">Bed</label>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="tab-pane fade" id="IncidentInfoIncidentDetailNew_Tab"
											role="tabpanel">
											<div
												th:replace="~{IncidentInfoIncidentDetailNewTab:: IncidentInfoIncidentDetailNewTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="IncidentInfoRefferals_Tab" role="tabpanel">
											<div th:replace="~{IncidentInfoRefferalsTab:: IncidentInfoRefferalsTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="IncidentInfofollowupinfo_Tab" role="tabpanel">
											<div
												th:replace="~{IncidentInfofollowupinfoTab:: IncidentInfofollowupinfoTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="IncidentInfoSupervisor_Tab" role="tabpanel">
											<div th:replace="~{IncidentInfoSupervisorTab:: IncidentInfoSupervisorTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="approval_Tab" role="tabpanel">
											<div th:replace="~{IncidentInfoApprovalTab:: IncidentInfoApprovalTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="assignInvestigator_Tab" role="tabpanel">
											<div
												th:replace="~{IncidentInfoAssignInvesTab:: IncidentInfoAssignInvesTab}">
											</div>
										</div>
										<div class="tab-pane fade" id="auditTrail_Tab" role="tabpanel">
											<div th:replace="~{IncidentInfoAuditTrailTab:: IncidentInfoAuditTrailTab}">
											</div>
										</div>
									</div>

									<div class="ml-1 mb-1">
										<!---	<button type="button" class="btn btn-sm btn-primary mr-2">New Incident</button> --->
										<button type="button" id="addSupplement" class="btn btn-sm btn-primary mr-2">Add
											Supplementary
											Incident</button>
										<button type="button" class="btn btn-sm btn-primary mr-2">Group
											Incident</button>
										<button type="button" class="btn btn-sm btn-primary mr-2">Investigation</button>
										<button type="button" class="btn btn-sm btn-primary">SSV-IA Form</button>
									</div>

								</div>
							</div>

						</div>
					</div>
					<div class="modal fade" id="selectIncidentModal" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header pt-3 pb-2">
									<h6 class="modal-title"> Select Incident# from the list </h6>
									<button id="closeBtn" type="button" class="close" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true"><i class="fal fa-times"></i></span>
									</button>
								</div>
								<div class="modal-body py-0">
									<div class="row form-group mx-1">
										<div class="d-flex align-items-center w-100 col-lg-2 px-0 floatingFields mt-1">
											<input type="text" class="form-control floatingLable rawField"
												aria-label="Security" placeholder="" name="Group" id="inciNoPop"
												value="" data-fld="inciNoPop_fld" data-lbl="Incident#">
											<label for="Security"
												class="form-label mr-2 mb-0 text-nowrap">Incident#</label>
										</div>
										<span class="text-nowrap mt-2 mx-2">(OR)</span>
										<div class="d-flex align-items-center w-100 col-lg-2 pl-0 floatingFields mt-1">
											<input type="text"
												class="date_field form-control floatingLable dtfld rawField"
												aria-label="Security" placeholder="" name="Group" id="fDtPop" value=""
												data-fld="fDtPop_fld" data-lbl="Date From">
											<label for="Security" class="form-label mr-2 mb-0 text-nowrap">Date
												From</label>
										</div>
										<div class="d-flex align-items-center w-100 col-lg-2 pl-0 floatingFields mt-1">
											<input type="text"
												class="date_field form-control floatingLable dtfld rawField"
												aria-label="Security" placeholder="" name="Group" id="tDtPop"
												data-fld="tDtPop_fld" data-lbl="To" value="">
											<label for="Security" class="form-label mr-2 mb-0 text-nowrap">To</label>
										</div>
										<div class="d-flex align-items-center w-100 col-lg-5 pl-0 selectFloatingLabel">
											<label class="form-label mr-2 mb-0 control-label selectFloating">Incident
												Location</label>
											<select id="inciLoc" data-fld="inciLoc_fld" data-lbl="Incident Location"
												class="custom-select form-control typecontact floatingLableClick rawField">
												<option value="">Incident Location</option>
												<option value="Option 1">test</option>
												<option value="Option 2">test1</option>
											</select>
											<button type="button" class="btn btn-primary btn-sm pl-2 ml-3"
												id="srchPop">Search</button>
										</div>
									</div>
									<div id="selectIncident-table"></div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-primary btn-sm" id="">Ok</button>
									<button type="button" class="btn btn-secondary btn-sm"
										data-dismiss="modal">Cancel</button>
								</div>
							</div>
						</div>
					</div>
					<span style="display:none;" id="myStaffPop" data-toggle="modal" data-target="#staffNameModal">
					</span>
					<div class="modal fade" id="staffNameModal" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header pt-3 pb-2">
									<h6 class="modal-title" id="staff_title"> Staff Name </h6>
									<button type="button" id="cancelOfcrPopup" class="close" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true"><i class="fal fa-times"></i></span>
									</button>
								</div>
								<div class="modal-body py-0">
									<div class="d-flex align-items-center mb-2">
										<label for="dob" class="form-label mb-0 mr-2 text-nowrap">Find</label>
										<input type="text" class="form-control" name="Find" id="srchBar">
										<button type="button" class="btn btn-primary btn-sm ml-2"
											id="searchUser">Find</button>
									</div>
									<div id="staffName-table"></div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-primary btn-sm" id="fetchDataBtn">Ok</button>
									<button type="button" class="btn btn-secondary btn-sm"
										data-dismiss="modal">Cancel</button>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="groupSupplementaryModal" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header pt-3 pb-2">
									<h6 class="modal-title"> Group / Supplementary Incident Details </h6>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true"><i class="fal fa-times"></i></span>
									</button>
								</div>
								<div class="modal-body py-0">
									<div id="groupSupplementary-table"></div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-primary btn-sm" id="">Ok</button>
									<button type="button" class="btn btn-secondary btn-sm"
										data-dismiss="modal">Cancel</button>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="selectCellSearchModal" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
							<div class="modal-content">
								<div class="modal-header pt-3 pb-2">
									<h6 class="modal-title"> Select Cell Search# from the list </h6>
									<button type="button" class="close" id="closeCellSrchPop" data-dismiss="modal"
										aria-label="Close">
										<span aria-hidden="true"><i class="fal fa-times"></i></span>
									</button>
								</div>
								<div class="modal-body py-0">
									<div class="row form-group mx-1">
										<div class="d-flex align-items-center w-100 col-lg-2 px-0 floatingFields mt-1">
											<input type="text" class="form-control floatingLable rawField"
												aria-label="Security" placeholder="" name="Group" id="cellNo" value=""
												data-fld="cellNo_fld" data-lbl="Cell Search#">
											<label for="Security" class="form-label mr-2 mb-0 text-nowrap">Cell
												Search#</label>
										</div>
										<span class="text-nowrap mt-2 mx-2">(OR)</span>
										<div class="d-flex align-items-center w-100 col-lg-2 pl-0 floatingFields mt-1">
											<input type="text" class="form-control floatingLable dtfld rawField"
												aria-label="Security" placeholder="" name="Group" id="cellDtFrom"
												value="" data-fld="cellDtFrom_fld" data-lbl="Date From">
											<label for="cellDtFrom" class="form-label mr-2 mb-0 text-nowrap">Date
												From</label>
										</div>
										<div class="d-flex align-items-center w-100 col-lg-2 pl-0 floatingFields mt-1">
											<input type="text" class="form-control floatingLable dtfld rawField"
												aria-label="Security" placeholder="" name="Group" id="cellDtTo"
												data-fld="cellDtTo_fld" data-lbl="To" value="">
											<label for="Security" class="form-label mr-2 mb-0 text-nowrap">To</label>
										</div>
										<div class="d-flex align-items-center w-100 col-lg-5 pl-0 selectFloatingLabel">
											<label class="form-label mr-2 mb-0 control-label selectFloating">Search
												Location</label>
											<select
												class="custom-select form-control typecontact floatingLableClick rawField"
												id="cellLoc" data-fld="cellLoc_fld" data-lbl="Search Location">
												<option value="">Search Location</option>
												<option value="Option 1">test</option>
												<option value="Option 2">test1</option>
											</select>
											<button type="button" class="btn btn-primary btn-sm pl-2 ml-3"
												id="cellSearch">Search</button>
										</div>
									</div>
									<div id="selectCellSearch-table"></div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-primary btn-sm" id="">Ok</button>
									<button type="button" class="btn btn-secondary btn-sm"
										data-dismiss="modal">Cancel</button>
								</div>
							</div>
						</div>
					</div>
				</main>
				<!-- this overlay is activated only when mobile menu is triggered -->
				<div class="page-content-overlay" data-action="toggle" data-class="mobile-nav-on"></div>
				<!-- END Page Content -->
				<!-- Modal Large -->
				<div class="modal fade" id="default-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
					<div class="modal-dialog modal-lg" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Staff Name</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true"><i class="fal fa-times"></i></span>
								</button>
							</div>
							<div class="modal-body">
								<div class="form-group row">
									<label class="col-form-label col-12 col-lg-1 form-label">Search</label>
									<div class="col-12 col-lg-11">
										<input type="text" class="form-control">
									</div>

								</div>
								<div class="table-responsive-lg">
									<table class="table table-bordered m-0">
										<thead>
											<tr>
												<th>Last Name</th>
												<th>First Name</th>
												<th>MI</th>
												<th>Suffix</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>14</td>
												<td>Staff</td>
												<td></td>
												<td></td>
											</tr>
											<tr>
												<td>14</td>
												<td>Staff</td>
												<td></td>
												<td></td>
											</tr>
											<tr>
												<td>14</td>
												<td>Staff</td>
												<td></td>
												<td></td>
											</tr>
											<tr>
												<td>14</td>
												<td>Staff</td>
												<td></td>
												<td></td>
											</tr>
											<tr>
												<td>14</td>
												<td>Staff</td>
												<td></td>
												<td></td>
											</tr>

										</tbody>
									</table>
								</div>
							</div>

						</div>
					</div>
				</div>
				<!-- BEGIN Shortcuts -->
				<!-- modal shortcut -->
				<div class="modal fade modal-backdrop-transparent" id="modal-shortcut" tabindex="-1" role="dialog"
					aria-labelledby="modal-shortcut" aria-hidden="true">
					<div class="modal-dialog modal-dialog-top modal-transparent" role="document">
						<div class="modal-content">
							<div class="modal-body">
								<ul class="app-list w-auto h-auto p-0 text-left">
									<li>
										<a href="intel_introduction.html" class="app-list-item text-white border-0 m-0">
											<div class="icon-stack">
												<i class="base base-7 icon-stack-3x opacity-100 color-primary-500 "></i>
												<i class="base base-7 icon-stack-2x opacity-100 color-primary-300 "></i>
												<i class="fal fa-home icon-stack-1x opacity-100 color-white"></i>
											</div>
											<span class="app-list-name">
												Home
											</span>
										</a>
									</li>
									<li>
										<a href="page_inbox_general.html" class="app-list-item text-white border-0 m-0">
											<div class="icon-stack">
												<i class="base base-7 icon-stack-3x opacity-100 color-success-500 "></i>
												<i class="base base-7 icon-stack-2x opacity-100 color-success-300 "></i>
												<i class="ni ni-envelope icon-stack-1x text-white"></i>
											</div>
											<span class="app-list-name">
												Inbox
											</span>
										</a>
									</li>
									<li>
										<a href="intel_introduction.html" class="app-list-item text-white border-0 m-0">
											<div class="icon-stack">
												<i class="base base-7 icon-stack-2x opacity-100 color-primary-300 "></i>
												<i class="fal fa-plus icon-stack-1x opacity-100 color-white"></i>
											</div>
											<span class="app-list-name">
												Add More
											</span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div> <!-- END Shortcuts -->
			</div>
		</div>
	</div>
	<!-- END Page Wrapper -->
	<!-- BEGIN Quick Menu -->
	<!-- to add more items, please make sure to change the variable '$menu-items: number;' in your _page-components-shortcut.scss -->
	<nav class="shortcut-menu d-none d-sm-block">
		<input type="checkbox" class="menu-open" name="menu-open" id="menu_open" />
		<label for="menu_open" class="menu-open-button ">
			<span class="app-shortcut-icon d-block"></span>
		</label>
		<a href="#" class="menu-item btn" data-toggle="tooltip" data-placement="left" title="Scroll Top">
			<i class="fal fa-arrow-up"></i>
		</a>
		<a href="page_login-alt.html" class="menu-item btn" data-toggle="tooltip" data-placement="left" title="Logout">
			<i class="fal fa-sign-out"></i>
		</a>
		<a href="#" class="menu-item btn" data-action="app-fullscreen" data-toggle="tooltip" data-placement="left"
			title="Full Screen">
			<i class="fal fa-expand"></i>
		</a>
		<a href="#" class="menu-item btn" data-action="app-print" data-toggle="tooltip" data-placement="left"
			title="Print page">
			<i class="fal fa-print"></i>
		</a>
		<a href="#" class="menu-item btn" data-action="app-voice" data-toggle="tooltip" data-placement="left"
			title="Voice command">
			<i class="fal fa-microphone"></i>
		</a>
	</nav>
	<!-- END Quick Menu -->
	<!-- BEGIN Messenger -->
	<div class="modal fade js-modal-messenger modal-backdrop-transparent" tabindex="-1" role="dialog"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-right">
			<div class="modal-content h-100">
				<div class="dropdown-header bg-trans-gradient d-flex align-items-center w-100">
					<div class="d-flex flex-row align-items-center mt-1 mb-1 color-white">
						<span class="mr-2">
							<span class="rounded-circle profile-image d-block"
								style="background-image:url('img/demo/avatars/avatar-d.png'); background-size: cover;"></span>
						</span>
						<div class="info-card-text">
							<a href="javascript:void(0);" class="fs-lg text-truncate text-truncate-lg text-white"
								data-toggle="dropdown" aria-expanded="false">
								Tracey Chang
								<i class="fal fa-angle-down d-inline-block ml-1 text-white fs-md"></i>
							</a>
							<div class="dropdown-menu">
								<a class="dropdown-item" href="#">Send Email</a>
								<a class="dropdown-item" href="#">Create Appointment</a>
								<a class="dropdown-item" href="#">Block User</a>
							</div>
							<span class="text-truncate text-truncate-md opacity-80">IT Director</span>
						</div>
					</div>
					<button type="button" class="close text-white position-absolute pos-top pos-right p-2 m-1 mr-2"
						data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true"><i class="fal fa-times"></i></span>
					</button>
				</div>
				<div class="modal-body p-0 h-100 d-flex">
					<!-- BEGIN msgr-list -->
					<div
						class="msgr-list d-flex flex-column bg-faded border-faded border-top-0 border-right-0 border-bottom-0 position-absolute pos-top pos-bottom">
						<div>
							<div
								class="height-4 width-3 h3 m-0 d-flex justify-content-center flex-column color-primary-500 pl-3 mt-2">
								<i class="fal fa-search"></i>
							</div>
							<input type="text" class="form-control bg-white" id="msgr_listfilter_input"
								placeholder="Filter contacts" aria-label="FriendSearch"
								data-listfilter="#js-msgr-listfilter">
						</div>
						<div class="flex-1 h-100 custom-scroll">
							<div class="w-100">
								<ul id="js-msgr-listfilter" class="list-unstyled m-0">
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="tracey chang online">
											<div class="d-table-cell align-middle status status-success status-sm ">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-d.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													Tracey Chang
													<small class="d-block font-italic text-success fs-xs">
														Online
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="oliver kopyuv online">
											<div class="d-table-cell align-middle status status-success status-sm ">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-b.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													Oliver Kopyuv
													<small class="d-block font-italic text-success fs-xs">
														Online
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="dr john cook phd away">
											<div class="d-table-cell align-middle status status-warning status-sm ">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-e.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													Dr. John Cook PhD
													<small class="d-block font-italic fs-xs">
														Away
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="ali amdaney online">
											<div class="d-table-cell align-middle status status-success status-sm ">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-g.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													Ali Amdaney
													<small class="d-block font-italic fs-xs text-success">
														Online
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="sarah mcbrook online">
											<div class="d-table-cell align-middle status status-success status-sm">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-h.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													Sarah McBrook
													<small class="d-block font-italic fs-xs text-success">
														Online
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="ali amdaney offline">
											<div class="d-table-cell align-middle status status-sm">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-a.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													oliver.kopyuv@gotbootstrap.com
													<small class="d-block font-italic fs-xs">
														Offline
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="ali amdaney busy">
											<div class="d-table-cell align-middle status status-danger status-sm">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-j.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													oliver.kopyuv@gotbootstrap.com
													<small class="d-block font-italic fs-xs text-danger">
														Busy
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="ali amdaney offline">
											<div class="d-table-cell align-middle status status-sm">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-c.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													oliver.kopyuv@gotbootstrap.com
													<small class="d-block font-italic fs-xs">
														Offline
													</small>
												</div>
											</div>
										</a>
									</li>
									<li>
										<a href="#" class="d-table w-100 px-2 py-2 text-dark hover-white"
											data-filter-tags="ali amdaney inactive">
											<div class="d-table-cell align-middle">
												<span class="profile-image-md rounded-circle d-block"
													style="background-image:url('img/demo/avatars/avatar-m.png'); background-size: cover;"></span>
											</div>
											<div class="d-table-cell w-100 align-middle pl-2 pr-2">
												<div class="text-truncate text-truncate-md">
													+714651347790
													<small class="d-block font-italic fs-xs opacity-50">
														Missed Call
													</small>
												</div>
											</div>
										</a>
									</li>
								</ul>
								<div class="filter-message js-filter-message"></div>
							</div>
						</div>
						<div>
							<a class="fs-xl d-flex align-items-center p-3">
								<i class="fal fa-cogs"></i>
							</a>
						</div>
					</div>
					<!-- END msgr-list -->
					<!-- BEGIN msgr -->
					<div class="msgr d-flex h-100 flex-column bg-white">
						<!-- BEGIN custom-scroll -->
						<div class="custom-scroll flex-1 h-100">
							<div id="chat_container" class="w-100 p-4">
								<!-- start .chat-segment -->
								<div class="chat-segment">
									<div class="time-stamp text-center mb-2 fw-400">
										Jun 19
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-sent">
									<div class="chat-message">
										<p>
											Hey Ching, did you get my files?
										</p>
									</div>
									<div class="text-right fw-300 text-muted mt-1 fs-xs">
										3:00 pm
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-get">
									<div class="chat-message">
										<p>
											Hi
										</p>
										<p>
											Sorry going through a busy time in office. Yes I analyzed the solution.
										</p>
										<p>
											It will require some resource, which I could not manage.
										</p>
									</div>
									<div class="fw-300 text-muted mt-1 fs-xs">
										3:24 pm
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-sent chat-start">
									<div class="chat-message">
										<p>
											Okay
										</p>
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-sent chat-end">
									<div class="chat-message">
										<p>
											Sending you some dough today, you can allocate the resources to this
											project.
										</p>
									</div>
									<div class="text-right fw-300 text-muted mt-1 fs-xs">
										3:26 pm
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-get chat-start">
									<div class="chat-message">
										<p>
											Perfect. Thanks a lot!
										</p>
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-get">
									<div class="chat-message">
										<p>
											I will have them ready by tonight.
										</p>
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment -->
								<div class="chat-segment chat-segment-get chat-end">
									<div class="chat-message">
										<p>
											Cheers
										</p>
									</div>
								</div>
								<!--  end .chat-segment -->
								<!-- start .chat-segment for timestamp -->
								<div class="chat-segment">
									<div class="time-stamp text-center mb-2 fw-400">
										Jun 20
									</div>
								</div>
								<!--  end .chat-segment for timestamp -->
							</div>
						</div>
						<!-- END custom-scroll  -->
						<!-- BEGIN msgr__chatinput -->
						<div class="d-flex flex-column">
							<div
								class="border-faded border-right-0 border-bottom-0 border-left-0 flex-1 mr-3 ml-3 position-relative shadow-top">
								<div class="pt-3 pb-1 pr-0 pl-0 rounded-0" tabindex="-1">
									<div id="msgr_input" contenteditable="true"
										data-placeholder="Type your message here..."
										class="height-10 form-content-editable"></div>
								</div>
							</div>
							<div class="height-8 px-3 d-flex flex-row align-items-center flex-wrap flex-shrink-0">
								<a href="javascript:void(0);" class="btn btn-icon fs-xl width-1 mr-1"
									data-toggle="tooltip" data-original-title="More options" data-placement="top">
									<i class="fal fa-ellipsis-v-alt color-fusion-300"></i>
								</a>
								<a href="javascript:void(0);" class="btn btn-icon fs-xl mr-1" data-toggle="tooltip"
									data-original-title="Attach files" data-placement="top">
									<i class="fal fa-paperclip color-fusion-300"></i>
								</a>
								<a href="javascript:void(0);" class="btn btn-icon fs-xl mr-1" data-toggle="tooltip"
									data-original-title="Insert photo" data-placement="top">
									<i class="fal fa-camera color-fusion-300"></i>
								</a>
								<div class="ml-auto">
									<a href="javascript:void(0);" class="btn btn-info">Send</a>
								</div>
							</div>
						</div>
						<!-- END msgr__chatinput -->
					</div>
					<!-- END msgr -->
				</div>
			</div>
		</div>
	</div>
	<!-- END Messenger -->
	<!-- BEGIN Page Settings -->
	<div class="modal fade js-modal-settings modal-backdrop-transparent" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-dialog-right modal-md">
			<div class="modal-content">
				<div class="dropdown-header bg-trans-gradient d-flex justify-content-center align-items-center w-100">
					<h4 class="m-0 text-center color-white">
						Layout Settings
						<small class="mb-0 opacity-80">User Interface Settings</small>
					</h4>
					<button type="button" class="close text-white position-absolute pos-top pos-right p-2 m-1 mr-2"
						data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true"><i class="fal fa-times"></i></span>
					</button>
				</div>
				<div class="modal-body p-0">
					<div class="settings-panel">
						<div class="mt-4 d-table w-100 px-5">
							<div class="d-table-cell align-middle">
								<h5 class="p-0">
									App Layout
								</h5>
							</div>
						</div>
						<div class="list" id="fh">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="header-function-fixed"></a>
							<span class="onoffswitch-title">Fixed Header</span>
							<span class="onoffswitch-title-desc">header is in a fixed at all times</span>
						</div>
						<div class="list" id="nff">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="nav-function-fixed"></a>
							<span class="onoffswitch-title">Fixed Navigation</span>
							<span class="onoffswitch-title-desc">left panel is fixed</span>
						</div>
						<div class="list" id="nfm">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="nav-function-minify"></a>
							<span class="onoffswitch-title">Minify Navigation</span>
							<span class="onoffswitch-title-desc">Skew nav to maximize space</span>
						</div>
						<div class="list" id="nfh">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="nav-function-hidden"></a>
							<span class="onoffswitch-title">Hide Navigation</span>
							<span class="onoffswitch-title-desc">roll mouse on edge to reveal</span>
						</div>
						<div class="list" id="nft">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="nav-function-top"></a>
							<span class="onoffswitch-title">Top Navigation</span>
							<span class="onoffswitch-title-desc">Relocate left pane to top</span>
						</div>
						<div class="list" id="mmb">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-main-boxed"></a>
							<span class="onoffswitch-title">Boxed Layout</span>
							<span class="onoffswitch-title-desc">Encapsulates to a container</span>
						</div>
						<div class="expanded">
							<ul class="">
								<li>
									<div class="bg-fusion-50" data-action="toggle" data-class="mod-bg-1"></div>
								</li>
								<li>
									<div class="bg-warning-200" data-action="toggle" data-class="mod-bg-2"></div>
								</li>
								<li>
									<div class="bg-primary-200" data-action="toggle" data-class="mod-bg-3"></div>
								</li>
								<li>
									<div class="bg-success-300" data-action="toggle" data-class="mod-bg-4"></div>
								</li>
							</ul>
							<div class="list" id="mbgf">
								<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
									data-class="mod-fixed-bg"></a>
								<span class="onoffswitch-title">Fixed Background</span>
							</div>
						</div>
						<!-- <div class="mt-4 d-table w-100 px-5">
                            <div class="d-table-cell align-middle">
                                <h5 class="p-0">
                                    Mobile Menu
                                </h5>
                            </div>
                        </div>
                        <div class="list" id="nmp">
                            <a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
                                data-class="nav-mobile-push"></a>
                            <span class="onoffswitch-title">Push Content</span>
                            <span class="onoffswitch-title-desc">Content pushed on menu reveal</span>
                        </div>
                        <div class="list" id="nmno">
                            <a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
                                data-class="nav-mobile-no-overlay"></a>
                            <span class="onoffswitch-title">No Overlay</span>
                            <span class="onoffswitch-title-desc">Removes mesh on menu reveal</span>
                        </div>
                        <div class="list" id="sldo">
                            <a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
                                data-class="nav-mobile-slide-out"></a>
                            <span class="onoffswitch-title">Off-Canvas <sup>(beta)</sup></span>
                            <span class="onoffswitch-title-desc">Content overlaps menu</span>
                        </div> -->
						<div class="mt-4 d-table w-100 px-5">
							<div class="d-table-cell align-middle">
								<h5 class="p-0">
									Accessibility
								</h5>
							</div>
						</div>
						<div class="list" id="mbf">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-bigger-font"></a>
							<span class="onoffswitch-title">Bigger Content Font</span>
							<span class="onoffswitch-title-desc">content fonts are bigger for readability</span>
						</div>
						<div class="list" id="mhc">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-high-contrast"></a>
							<span class="onoffswitch-title">High Contrast Text (WCAG 2 AA)</span>
							<span class="onoffswitch-title-desc">4.5:1 text contrast ratio</span>
						</div>
						<div class="list" id="mcb">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-color-blind"></a>
							<span class="onoffswitch-title">Daltonism <sup>(beta)</sup> </span>
							<span class="onoffswitch-title-desc">color vision deficiency</span>
						</div>
						<div class="list" id="mpc">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-pace-custom"></a>
							<span class="onoffswitch-title">Preloader Inside</span>
							<span class="onoffswitch-title-desc">preloader will be inside content</span>
						</div>
						<div class="mt-4 d-table w-100 px-5">
							<div class="d-table-cell align-middle">
								<h5 class="p-0">
									Global Modifications
								</h5>
							</div>
						</div>
						<div class="list" id="mcbg">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-clean-page-bg"></a>
							<span class="onoffswitch-title">Clean Page Background</span>
							<span class="onoffswitch-title-desc">adds more whitespace</span>
						</div>
						<div class="list" id="mhni">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-hide-nav-icons"></a>
							<span class="onoffswitch-title">Hide Navigation Icons</span>
							<span class="onoffswitch-title-desc">invisible navigation icons</span>
						</div>
						<div class="list" id="dan">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-disable-animation"></a>
							<span class="onoffswitch-title">Disable CSS Animation</span>
							<span class="onoffswitch-title-desc">Disables CSS based animations</span>
						</div>
						<div class="list" id="mhic">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-hide-info-card"></a>
							<span class="onoffswitch-title">Hide Info Card</span>
							<span class="onoffswitch-title-desc">Hides info card from left panel</span>
						</div>
						<div class="list" id="mlph">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-lean-subheader"></a>
							<span class="onoffswitch-title">Lean Subheader</span>
							<span class="onoffswitch-title-desc">distinguished page header</span>
						</div>
						<div class="list" id="mnl">
							<a href="#" onclick="return false;" class="btn btn-switch" data-action="toggle"
								data-class="mod-nav-link"></a>
							<span class="onoffswitch-title">Hierarchical Navigation</span>
							<span class="onoffswitch-title-desc">Clear breakdown of nav links</span>
						</div>
						<div class="list mt-1">
							<span class="onoffswitch-title">Global Font Size <small>(RESETS ON REFRESH)</small> </span>
							<div class="btn-group btn-group-sm btn-group-toggle my-2" data-toggle="buttons">
								<label class="btn btn-default btn-sm" data-action="toggle-swap"
									data-class="root-text-sm" data-target="html">
									<input type="radio" name="changeFrontSize"> SM
								</label>
								<label class="btn btn-default btn-sm" data-action="toggle-swap" data-class="root-text"
									data-target="html">
									<input type="radio" name="changeFrontSize" checked=""> MD
								</label>
								<label class="btn btn-default btn-sm" data-action="toggle-swap"
									data-class="root-text-lg" data-target="html">
									<input type="radio" name="changeFrontSize"> LG
								</label>
								<label class="btn btn-default btn-sm" data-action="toggle-swap"
									data-class="root-text-xl" data-target="html">
									<input type="radio" name="changeFrontSize"> XL
								</label>
							</div>
							<span class="onoffswitch-title-desc d-block mb-g">Change <strong>root</strong> font size to
								effect rem values</span>
						</div>
						<div class="mt-2 d-table w-100 pl-5 pr-3">
							<div class="d-table-cell align-middle">
								<h5 class="p-0">
									Theme colors <small>(overlays base css)</small>
								</h5>
								<!-- <div class="fs-xs text-muted p-2 alert alert-warning mt-3 mb-0">
                                    <i class="fal fa-exclamation-triangle text-warning mr-2"></i>Due to network latency
                                    and CPU utilization, you may experience a brief flickering effect on page load which
                                    may show the intial applied theme for a split second. Setting the prefered
                                    style/theme in the header will prevent this from happening.
                                </div> -->
							</div>
						</div>
						<div class="expanded theme-colors pl-5 pr-3">
							<ul class="m-0">
								<li><a href="#" id="myapp-0" data-action="theme-update" data-themesave data-theme=""
										data-toggle="tooltip" data-placement="top" title="Wisteria (base css)"
										data-original-title="Wisteria (base css)"></a></li>
								<li><a href="#" id="myapp-1" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-1.css" data-toggle="tooltip"
										data-placement="top" title="Tapestry" data-original-title="Tapestry"></a></li>
								<li><a href="#" id="myapp-2" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-2.css" data-toggle="tooltip"
										data-placement="top" title="Atlantis" data-original-title="Atlantis"></a></li>
								<li><a href="#" id="myapp-3" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-3.css" data-toggle="tooltip"
										data-placement="top" title="Indigo" data-original-title="Indigo"></a></li>
								<li><a href="#" id="myapp-4" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-4.css" data-toggle="tooltip"
										data-placement="top" title="Dodger Blue" data-original-title="Dodger Blue"></a>
								</li>
								<li><a href="#" id="myapp-5" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-5.css" data-toggle="tooltip"
										data-placement="top" title="Tradewind" data-original-title="Tradewind"></a></li>
								<li><a href="#" id="myapp-6" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-6.css" data-toggle="tooltip"
										data-placement="top" title="Cranberry" data-original-title="Cranberry"></a></li>
								<li><a href="#" id="myapp-7" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-7.css" data-toggle="tooltip"
										data-placement="top" title="Oslo Gray" data-original-title="Oslo Gray"></a></li>
								<li><a href="#" id="myapp-8" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-8.css" data-toggle="tooltip"
										data-placement="top" title="Chetwode Blue"
										data-original-title="Chetwode Blue"></a></li>
								<li><a href="#" id="myapp-9" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-9.css" data-toggle="tooltip"
										data-placement="top" title="Apricot" data-original-title="Apricot"></a></li>
								<li><a href="#" id="myapp-10" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-10.css" data-toggle="tooltip"
										data-placement="top" title="Blue Smoke" data-original-title="Blue Smoke"></a>
								</li>
								<li><a href="#" id="myapp-11" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-11.css" data-toggle="tooltip"
										data-placement="top" title="Green Smoke" data-original-title="Green Smoke"></a>
								</li>
								<li><a href="#" id="myapp-12" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-12.css" data-toggle="tooltip"
										data-placement="top" title="Wild Blue Yonder"
										data-original-title="Wild Blue Yonder"></a></li>
								<li><a href="#" id="myapp-13" data-action="theme-update" data-themesave
										data-theme="css/themes/cust-theme-13.css" data-toggle="tooltip"
										data-placement="top" title="Emerald" data-original-title="Emerald"></a></li>
							</ul>
						</div>
						<hr class="mb-0 mt-4">
						<div class="pl-5 pr-3 py-3 bg-faded">
							<div class="row no-gutters">
								<div class="col-6 pr-1">
									<a href="#" class="btn btn-outline-danger fw-500 btn-block"
										data-action="app-reset">Reset Settings</a>
								</div>
								<div class="col-6 pl-1">
									<a href="#" class="btn btn-danger fw-500 btn-block"
										data-action="factory-reset">Factory Reset</a>
								</div>
							</div>
						</div>
					</div>
					<span id="saving"></span>
				</div>
			</div>
		</div>
	</div>
	<!-- END Page Settings -->
	<style>
		.form-group.focused .selectFloating {
			background: #fff;
		}

		.form-group.focused .selectFloating {
			z-index: 9999 !important;
		}

		.floatingFields label {
			left: 20px;
		}

		.loactionDesc input:focus+label {
			top: 1px;
		}

		#generalinfo-table .tabulator-tableholder, #typerestraint-table .tabulator-tableholder, #actionTaken-table .tabulator-tableholder{
			overflow-x: hidden;
		}

		.floatingFields label {
			top: unset;
		}

		#selectIncidentModal .floatingFields label {
			left: 10px;
		}

		#selectIncidentModal .selectFloatingLabel .form-label {
			left: -10px;
		}

		#selectIncidentModal .form-group.focused .selectFloating {
			top: -13px;
		}

		@media screen and (max-width: 1350px) {
			.nav-function-fixed .page-sidebar {
				top: 21.5% !important;
			}
		}

		@media screen and (max-width: 1200px) {
			.subheader-title {
				font-size: 18px;
			}
		}

		@media screen and (max-width: 1024px) {
			.nav-function-fixed .page-sidebar {
				top: 32% !important;
			}

			.page-content-wrapper {
				margin-top: 0rem !important;
			}

			.subheader {
				display: block;
			}

			.topheadRightSideBlock {
				justify-content: end;
			}

			.panel .nav-tabs .nav-link {
				font-size: 11px !important;
			}
		}

		@media screen and (max-width: 992px) {
			.page-content-wrapper {
				padding-left: 0 !important;
			}

			#mdPicker {
				top: 2px;
			}

			.subheader-title {
				color: #7a59ae !important;
				font-weight: 500 !important;
			}



		}

		.search-box {
			position: relative;
			width: 250px;
		}

		/*the container must be positioned relative:*/
		.autocomplete {
			position: relative;
			display: inline-block;
		}

		.autocomplete-items {
			position: absolute;
			border: 1px solid #d4d4d4;
			border-bottom: none;
			border-top: none;
			z-index: 99;
			/*position the autocomplete items to be the same width as the container:*/
			top: 100%;
			left: 0;
			right: 0;
		}

		.autocomplete-items div {
			padding: 10px;
			cursor: pointer;
			background-color: #fff;
			border-bottom: 1px solid #d4d4d4;
		}

		/*when hovering an item:*/
		.autocomplete-items div:hover {
			background-color: #e9e9e9;
		}

		/*when navigating through the items using the arrow keys:*/
		.autocomplete-active {
			background-color: DodgerBlue !important;
			color: #ffffff;
		}

		/*.autoCompleteInput {
			width: 100%;
			padding: 8px;
			box-sizing: border-box;
		}*/

		/*.autoCompleteDropdown {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			border: 1px solid #ccc;
			background: #fff;
			max-height: 150px;
			overflow-y: auto;
			display: none;
			/* Hidden by default */
		/*z-index: 1000;
		}

		/*.autoCompleteDropdown div {
			padding: 8px;
			cursor: pointer;
		}

		.autoCompleteDropdown div:hover {
			background-color: #f0f0f0;
		}*/

		.nav-disable {
			color: #aaa !important;
			pointer-events: none !important;
		}

		#innavleftArrow,
		#innavRightArrow {
			height: 100%;
			display: flex;
			align-items: center;
			background: #fff !important;
			position: relative;
			z-index: 9;
		}
		
		.floatingFieldsTextarea {
		    position: relative;
		}
		#inline-hint {
		    position: absolute;
		    top: 10px; /* fine-tune based on your layout */
		    left: 14px;
		    color: #aaa;
		    font-size: 14px;
		    font-family: inherit;
		    pointer-events: none;
		    white-space: nowrap;
		    z-index: 5;
		}

		.tabulator-row.tabulator-selected-row {
			background-color: #a8d4ff !important; 
		}
		
		
		
	</style>
	<div th:replace="~{fragments/script :: script}"></div>
	<script src="js/staticjs.js"></script>
	<script>


		const shortDescInput = $('#shortDesc');
		const maxLength = 100;
		let lastLength = 0;

		shortDescInput.on('input', function () {
			let currentLength = $(this).val().length;

			if (currentLength === maxLength && lastLength < maxLength) {
				message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
			}

			lastLength = currentLength;
		});


		const userId = localStorage.getItem('userId');

		var injuredPersons = [];

		function commaName(x) {
			x = x.trim();
			if (x != '') {
				x = x.split(' ').join(', ');
			}
			return x;
		}

		function formatDateTimeFromRow(dateStr, timeStr) {
			if (!dateStr || !dateStr.includes('/')) return null; // Handle empty/invalid date
			if (!timeStr || !timeStr.includes(':')) timeStr = '00:00'; // Default time if missing

			const dateParts = dateStr.split('/'); // mm/dd/yyyy
			const timeParts = timeStr.split(':');   // hh:mm

			const year = dateParts[2];
			const month = String(dateParts[0]).padStart(2, '0');
			const day = String(dateParts[1]).padStart(2, '0');

			const hours = String(timeParts[0]).padStart(2, '0');
			const minutes = String(timeParts[1]).padStart(2, '0');
			const seconds = '00';

			return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
		}
		
		$("#inciDt").datepicker({
			dateFormat: "mm/dd/yy",
			changeMonth: true,
			changeYear: true,
			maxDate: 0, // disable future dates
			yearRange: (function () {
				var currentYear = new Date().getFullYear();
				return (currentYear - 20) + ":" + currentYear;
			})()
		});
		
		
		$("#inciDt").on("change", function() {
		    var inputDate = $(this).val();
		    if (!inputDate) return;

		    var parts = inputDate.split('/');
		    if (parts.length !== 3) return;

		    var mm = parseInt(parts[0], 10);
		    var dd = parseInt(parts[1], 10);
		    var yyyy = parseInt(parts[2], 10);

		    var dateVal = new Date(yyyy, mm - 1, dd);
		    var today = new Date();
		    today.setHours(0, 0, 0, 0);

		    // ⛔ If user manually enters a future date, just clear it (no alert)
		    if (dateVal > today) {
		        $(this).val('');
		    }
		});

		

		function updateCharCount(textareaElement) {
			const $textarea = $(textareaElement);
			const maxLength = $textarea.data('maxlength') || 2000;
			const $counter = $textarea.next('.char-counter');
			if (!$counter.length) return;
			let currentLength = $textarea.val().length;
			if (currentLength > maxLength) {
				$textarea.val($textarea.val().substring(0, maxLength));
				currentLength = maxLength;
				if (typeof message === 'function') {
					const fieldName = $textarea.attr('aria-label') || $textarea.attr('placeholder') || 'The field';
					message('CUW', `Maximum character length reached.! You cannot paste more text or You cannot able to type `, 0);

				}
			}
			$counter.text(currentLength + '/' + maxLength + ' characters');
		}


		$(document).on('input keyup paste', 'textarea.rawField', function () {
			updateCharCount(this);
		});

		function formatDate(dateString) {
			if (!dateString) return 'N/A';
			try {
				const date = new Date(dateString);
				if (isNaN(date.getTime())) {
					const parts = dateString.split(/[-T]/);
					if (parts.length >= 3) return `${parts[1]}/${parts[2].substr(0, 2)}/${parts[0]}`;
					return dateString;
				}
				return date.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'});
			} catch {
				return dateString;
			}
		}

		function highlightTabulatorRow(row) {
			var table = row.getTable();
			table.getRows().forEach(function(r) {
				if (r.getElement()) {
					r.getElement().classList.remove('tabulator-selected-row');
				}
			});
			if (row.getElement()) {
				row.getElement().classList.add('tabulator-selected-row');
			}
		}

		$(document).on('keydown', '#locationDesc', function(e) {
		    if (e.key === 'Tab' && !e.shiftKey) {
		        console.log("Tab key pressed on #locationDesc. Moving focus to #defaultInline1.");
		        e.preventDefault();
		        $('#defaultInline1').focus();
		    }
		});

		/*Autocomplete Dropdown function*/

		const dropdown = document.querySelector('.autoCompleteDropdown');

		function showDropdown(input) {
			// Show dropdown when input is focused or clicked
			filterOptions(input); // Optionally filter options based on current input
			dropdown.style.display = 'block';
		}

		function filterOptions(input) {
			const filter = input.value.toLowerCase();
			const options = dropdown.children;
			let matchFound = false;

			for (let i = 0; i < options.length; i++) {
				const optionText = options[i].textContent.toLowerCase();
				if (optionText.startsWith(filter)) {
					options[i].style.display = 'block';
					matchFound = true;
				} else {
					options[i].style.display = 'none';
				}
			}

			// Show the dropdown if there's a match or if input is empty
			dropdown.style.display = (filter === "" || matchFound) ? 'block' : 'none';
		}

		function selectOption(optionDiv) {
			const input = document.querySelector('.autoCompleteInput');
			input.value = optionDiv.textContent; // set the input value
			dropdown.style.display = 'none'; // hide dropdown after selection
		}

		// Optional: hide dropdown when clicking outside
		document.addEventListener('click', (e) => {
			const searchBox = document.querySelector('.search-box');
			if (!searchBox.contains(e.target)) {
				dropdown.style.display = 'none';
			}
		});

		function getCurrentDateTime() {
			const now = new Date();
			// Get the components of the date
			const year = now.getFullYear();
			const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are zero-based
			const day = String(now.getDate()).padStart(2, '0');

			// Get the components of the time
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const seconds = String(now.getSeconds()).padStart(2, '0');
			// Format the date and time
			return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
		}

		function formatDateWithCurrentTime(inputDate) {
			// Parse input date string mm/dd/yyyy
			const [month, day, year] = inputDate.split('/').map(Number);

			// Get current time components from now
			const now = new Date();
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const seconds = String(now.getSeconds()).padStart(2, '0');

			// Create a Date object for the input date with the current time
			const dateWithCurrentTime = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds());

			// Format the date part as yyyy-mm-dd
			const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

			// Combine date and time
			return `${formattedDate} ${hours}:${minutes}:${seconds}`;
		}

		var dateEditor = function (cell, onRendered, success, cancel) {
			var input = document.createElement("input");
			input.type = "text";
			input.value = cell.getValue() || "";
			input.setAttribute("maxlength", "10");
			input.style.padding = "4px";
			input.style.width = "100%";

			$(input).datepicker({
				dateFormat: "mm/dd/yy",
				changeMonth: true,
				changeYear: true,
				yearRange: (function () {
					var currentYear = new Date().getFullYear();
					return (currentYear - 20) + ":" + (currentYear + 20);
				})(),
				onSelect: function (dateText) {
					success(dateText);

					if (getHeaderAttribute(cell, 'data-check') != null) {
						var dataCheck = getHeaderAttribute(cell, 'data-check');
						var dataValid = getHeaderAttribute(cell, 'data-valid');
						datePickerCheck(cell, dateText, dataCheck, dataValid);
					}

					$(input).datepicker("hide");
				}
			});



			// Automatically insert slashes
			input.addEventListener("input", function (e) {
				let value = input.value.replace(/\D/g, ""); // Remove all non-digits
				if (value.length > 2 && value.length <= 4) {
					value = value.slice(0, 2) + "/" + value.slice(2);
				} else if (value.length > 4) {
					value = value.slice(0, 2) + "/" + value.slice(2, 4) + "/" + value.slice(4, 8);
				}
				input.value = value;
			});

			input.addEventListener("keydown", function (e) {
				const dateText = input.value.trim();
				const isValid = /^\d{2}\/\d{2}\/\d{4}$/.test(dateText);

				if (e.key === "Enter" || e.key === "Tab") {
					e.preventDefault();
					if (isValid) {
						success(dateText);
					} else {
						cancel();
					}
				} else if (e.key === "Escape") {
					cancel();
				}
			});

			onRendered(function () {
				input.focus();
				input.select();
			});

			return input;
		};

		function getCellByFieldAndRowId(table, fieldName, rowId) {
			// Get the row by its ID
			var row = table.getRow(rowId);

			// Check if the row exists
			if (row) {
				// Get the cell by field name
				var cell = row.getCell(fieldName);

				// Return the cell object
				return cell;
			} else {
				console.error("Row with ID " + rowId + " not found.");
				return null; // Return null if the row does not exist
			}
		}

		function clearFieldValues(table, field) {
			// Get all rows in the table
			const rows = table.getRows();
			// Loop through each row and set the specified field to an empty value
			rows.forEach(row => {
				row.update({[field]: ""}); // Set the field to an empty string
			});
		}

		function setNames2xx(userid, field) {
			$.ajax({
				method: "POST",
				url: contextPath + 'getNames',
				dataType: "json",
				data: {
					userid: userid
				},
				success: function (response) {
					var lname = nullhandlerx(response[0]['USER_LAST_NAME']) + ' ';
					var fname = nullhandlerx(response[0]['USER_FIRST_NAME']) + ' ';
					var mname = nullhandlerx(response[0]['USER_MID_NAME']) + ' ';
					var sname = nullhandlerx(response[0]['USER_SUFFIX_NAME']) + ' ';

					var nam = lname + fname + mname + sname;
					$('#' + field).val(nam);
				},
				error: function (error) {
					console.error('Error:', error);
					console.log(error.responseText);
				}
			});
		}

		function setNames3xx(userid, field) {
			$.ajax({
				method: "POST",
				url: contextPath + 'getNames',
				dataType: "json",
				data: {
					userid: userid
				},
				success: function (response) {
					var lname = nullhandlerx(response[0]['USER_LAST_NAME']) + ' ';
					var fname = nullhandlerx(response[0]['USER_FIRST_NAME']) + ' ';
					var mname = nullhandlerx(response[0]['USER_MID_NAME']) + ' ';
					var sname = nullhandlerx(response[0]['USER_SUFFIX_NAME']) + ' ';

					var nam = lname + fname + mname + sname;
					$('#' + field).val(nam);
					var title = field.split('name').join('title');
					$('#' + title).val(response[0]['TITLE']);
				},
				error: function (error) {
					console.error('Error:', error);
					console.log(error.responseText);
				}
			});
		}

		function nullhandlerx(str) {
			if (str == 'null' || str == null) {
				return '';
			} else {
				return str;
			}
		}

		$(document).ready(function () {
			$(function () {
				$('.select2').select2();

				$(".select2-placeholder-multiple").select2(
					{
						placeholder: "Select State"
					});
				$(".js-hide-search").select2(
					{
						minimumResultsForSearch: 1 / 0
					});
				$(".js-max-length").select2(
					{
						maximumSelectionLength: 2,
						placeholder: "Select maximum 2 items"
					});
				$(".select2-placeholder").select2(
					{
						placeholder: "Select a state",
						allowClear: true
					});



				$(".js-select2-icons").select2(
					{
						minimumResultsForSearch: 1 / 0,
						templateResult: icon,
						templateSelection: icon,
						escapeMarkup: function (elm) {
							return elm
						}
					});

				function icon(elm) {
					elm.element;
					return elm.id ? "<i class='" + $(elm.element).data("icon") + " mr-2'></i>" + elm.text : elm.text
				}

				$(".js-data-example-ajax").select2(
					{
						ajax:
						{
							url: "https://api.github.com/search/repositories",
							dataType: 'json',
							delay: 250,
							data: function (params) {
								return {
									q: params.term, // search term
									page: params.page
								};
							},
							processResults: function (data, params) {
								// parse the results into the format expected by Select2
								// since we are using custom formatting functions we do not need to
								// alter the remote JSON data, except to indicate that infinite
								// scrolling can be used
								params.page = params.page || 1;

								return {
									results: data.items,
									pagination:
									{
										more: (params.page * 30) < data.total_count
									}
								};
							},
							cache: true
						},
						placeholder: 'Search for a repository',
						escapeMarkup: function (markup) {
							return markup;
						}, // let our custom formatter work
						minimumInputLength: 1,
						templateResult: formatRepo,
						templateSelection: formatRepoSelection
					});

				function formatRepo(repo) {
					if (repo.loading) {
						return repo.text;
					}

					var markup = "<div class='select2-result-repository clearfix d-flex'>" +
						"<div class='select2-result-repository__avatar mr-2'><img src='" + repo.owner.avatar_url + "' class='width-2 height-2 mt-1 rounded' /></div>" +
						"<div class='select2-result-repository__meta'>" +
						"<div class='select2-result-repository__title fs-lg fw-500'>" + repo.full_name + "</div>";

					if (repo.description) {
						markup += "<div class='select2-result-repository__description fs-xs opacity-80 mb-1'>" + repo.description + "</div>";
					}

					markup += "<div class='select2-result-repository__statistics d-flex fs-sm'>" +
						"<div class='select2-result-repository__forks mr-2'><i class='fal fa-lightbulb'></i> " + repo.forks_count + " Forks</div>" +
						"<div class='select2-result-repository__stargazers mr-2'><i class='fal fa-star'></i> " + repo.stargazers_count + " Stars</div>" +
						"<div class='select2-result-repository__watchers mr-2'><i class='fal fa-eye'></i> " + repo.watchers_count + " Watchers</div>" +
						"</div>" +
						"</div></div>";

					return markup;
				}

				function formatRepoSelection(repo) {
					return repo.full_name || repo.text;
				}

			});

			function autocomplete(inp, arr) {
				/*the autocomplete function takes two arguments,
				the text field element and an array of possible autocompleted values:*/
				var currentFocus;
				/*execute a function when someone writes in the text field:*/
				inp.addEventListener("input", function (e) {
					var a, b, i, val = this.value;
					/*close any already open lists of autocompleted values*/
					closeAllLists();
					if (!val) {return false;}
					currentFocus = -1;
					/*create a DIV element that will contain the items (values):*/
					a = document.createElement("DIV");
					a.setAttribute("id", this.id + "autocomplete-list");
					a.setAttribute("class", "autocomplete-items");
					/*append the DIV element as a child of the autocomplete container:*/
					this.parentNode.appendChild(a);
					/*for each item in the array...*/
					for (i = 0; i < arr.length; i++) {
						/*check if the item starts with the same letters as the text field value:*/
						if (arr[i].toUpperCase().includes(val.toUpperCase())) {
							/*create a DIV element for each matching element:*/
							b = document.createElement("DIV");
							/*make the matching letters bold:*/
							b.innerHTML = "<strong>" + arr[i] + "</strong>";
							//b.innerHTML += arr[i].substr(val.length);
							/*insert a input field that will hold the current array item's value:*/
							b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
							/*execute a function when someone clicks on the item value (DIV element):*/
							b.addEventListener("click", function (e) {
								/*insert the value for the autocomplete text field:*/
								inp.value = this.getElementsByTagName("input")[0].value;
								/*close the list of autocompleted values,
								(or any other open lists of autocompleted values:*/
								closeAllLists();
							});
							a.appendChild(b);
						}
					}
				});
				/*execute a function presses a key on the keyboard:*/
				inp.addEventListener("keydown", function (e) {
					var x = document.getElementById(this.id + "autocomplete-list");
					if (x) x = x.getElementsByTagName("div");
					if (e.keyCode == 40) {
						/*If the arrow DOWN key is pressed,
						increase the currentFocus variable:*/
						currentFocus++;
						/*and and make the current item more visible:*/
						addActive(x);
					} else if (e.keyCode == 38) { //up
						/*If the arrow UP key is pressed,
						decrease the currentFocus variable:*/
						currentFocus--;
						/*and and make the current item more visible:*/
						addActive(x);
					} else if (e.keyCode == 13) {
						/*If the ENTER key is pressed, prevent the form from being submitted,*/
						e.preventDefault();
						if (currentFocus > -1) {
							/*and simulate a click on the "active" item:*/
							if (x) x[currentFocus].click();
						}
					}
				});
				function addActive(x) {
					/*a function to classify an item as "active":*/
					if (!x) return false;
					/*start by removing the "active" class on all items:*/
					removeActive(x);
					if (currentFocus >= x.length) currentFocus = 0;
					if (currentFocus < 0) currentFocus = (x.length - 1);
					/*add class "autocomplete-active":*/
					x[currentFocus].classList.add("autocomplete-active");
				}
				function removeActive(x) {
					/*a function to remove the "active" class from all autocomplete items:*/
					for (var i = 0; i < x.length; i++) {
						x[i].classList.remove("autocomplete-active");
					}
				}
				function closeAllLists(elmnt) {
					/*close all autocomplete lists in the document,
					except the one passed as an argument:*/
					var x = document.getElementsByClassName("autocomplete-items");
					for (var i = 0; i < x.length; i++) {
						if (elmnt != x[i] && elmnt != inp) {
							x[i].parentNode.removeChild(x[i]);
						}
					}
				}
				/*execute a function when someone clicks in the document:*/
				document.addEventListener("click", function (e) {
					closeAllLists(e.target);
				});
			}

			getInstitution();

			var myInst = [];
			var myInstNo = [];
			var myLoc = [];
			var myLocNo = [];
			var myTyp = ["01", "02", "03", "04", "05", "06"];
			var myTypDesc = ["Inmate Involved", "Civilian Involved", "Staff Involved", "Others Involved", "FYI", "QRT Escort"];
			var myTypNo = [];

			function getValueFromArray(array, word) {
				// Extract the first two letters of the word
				var firstTwoLetters = word.substring(0, 4).toLowerCase();
				// Find the value in the array that starts with the first two letters
				var value = array.find(item => item.toLowerCase().startsWith(firstTwoLetters));
				return value || null;
				// Return the found value or null if not found
			}

			function getDescValueArray(array, word) {
				var value = array.find(item => item.toLowerCase().includes(word.toLowerCase()));
				value = value.split("--")[0];
				return value;
			}

			function getValueArray(array, word) {
				var value = array.find(item => item.toLowerCase().includes(word.toLowerCase()));
				value = value.split("--")[1];
				return value;
			}

			getInciType();

			function getInciType() {
				for (var i = 0; i < myTyp.length; i++) {
					myTypNo.push(myTyp[i] + '--' + myTypDesc[i]);
				}

				autocomplete(document.getElementById("incident_tp_val"), myTypDesc);
			}

			// Function to retrieve Institution value
			function getInstitution() {
				$.ajax({
					method: "POST",
					url: contextPath + 'getInst4Inci',
					contentType: 'application/json',
					success: function (response) {
						//var options = '<option value="">Location</option>';
						for (var i = 0; i < response.length; i++) {
							//options += '<option value="' + response[i]['INST_NUM'] + '">' + response[i]['INST_NAME'] + '</option>';
							myInst.push(response[i]['INST_NAME']);
							myInstNo.push(response[i]['INST_NUM'] + '--' + response[i]['INST_NAME']);
						}
						//$('#institution').html(options);
					},
					complete: function (response) {
						var inst = '03';
						autocomplete(document.getElementById("institution_val"), myInst);
						$('#institution').val(inst.trim());
						$('#institution_val').val(getValueFromArray(myInstNo, '03--', 0).split('--')[1]);
						//$('#institution').trigger('change');
						getBuilding('03');
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			$('#institution_val').on('change', function () {
				$('#institution').val(getDescValueArray(myInstNo, $(this).val()));
			});

			$('#location_val').on('change', function () {
				$('#location').val(getDescValueArray(myLocNo, $(this).val()));
			});

			$('#incident_tp_val').on('change', function () {
				$('#incident_tp').val(getDescValueArray(myTypNo, $(this).val()));
			});

			function getBuilding(instNumber) {
				$.ajax({
					method: "POST",
					url: contextPath + 'getBuildingMOAM',
					contentType: 'application/json',
					data: instNumber,
					success: function (response) {
						//alert(response);
						populateDropdown(response, $('#location'));
						populateDropdown2(response, $('#inciLoc'));
						populateDropdown2(response, $('#cellLoc'));
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			function setUpdate(tbl, id) {
				//alert(id);
				//$('#drugdna_table').find('.tabulator-row').eq(id).addClass('allow_update');
				//$('#drugdna_table').find('.tabulator-row').eq(id).attr('allow_id', id);
				var row = tbl.getRow(id); // Get the row by ID
				if (row) {
					var rowElement = row.getElement(); // Get the row element
					rowElement.classList.add('allow_update'); // Add the class to the row element
					rowElement.setAttribute('allow_id', id);
				} else {
					console.error("Row not found for rowId:", rowId);
				}
			}

			function focusCell(tbl, rowId, field) {
				var row = tbl.getRow(rowId); // Get the row by ID
				if (row) {
					var cell = row.getCell(field); // Get the cell from the row
					if (cell) {
						cell.edit(); // Open the editor for the cell
						// Wait for the editor to be created before focusing
						/*setTimeout(function () {
							var input = cell.getElement().querySelector("input");
							if (input) {
								input.focus(); // Focus the input element
							}
						}, 0);*/
					} else {
						console.error("Cell not found for field:", field);
					}
				} else {
					console.error("Row not found for rowId:", rowId);
				}
			}

			function getCurrentDate() {
				const today = new Date();
				const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
				const day = String(today.getDate()).padStart(2, '0');
				const year = today.getFullYear();

				return `${month}/${day}/${year}`;
			}

			function getDateOneMonthAgo() {
				const today = new Date();
				const lastMonthDate = new Date(today);

				// Subtract one month
				lastMonthDate.setMonth(today.getMonth() - 1);

				// Format the date to mm/dd/yyyy
				const month = String(lastMonthDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based
				const day = String(lastMonthDate.getDate()).padStart(2, '0');
				const year = lastMonthDate.getFullYear();

				return `${month}/${day}/${year}`;
			}

			function convertDateFormat(dateString) {
				// Split the input date string by '/'
				const parts = dateString.split('/');

				// Check if the input is valid
				if (parts.length !== 3) {
					throw new Error("Invalid date format. Please use mm/dd/yyyy.");
				}

				const month = parts[0]; // mm
				const day = parts[1];   // dd
				const year = parts[2];  // yyyy

				// Get the last two digits of the year
				const shortYear = year.slice(-2);

				// Return the formatted date as dd-mm-yy
				return `${day}-${month}-${shortYear}`;
			}

			$('#fDtPop').val(getDateOneMonthAgo());
			$('#tDtPop').val(getCurrentDate());

			function resetTable(tabulator, n) {
				// Clear the existing data
				tabulator.setData([]);

				// Add 4 empty rows
				for (var i = 0; i < n; i++) {
					tabulator.addRow({id: i});
				}
			}

			function setValueForRowAndColumn(table, rowNumber, columnField, valueToSet) {
				// Get the row by its index (rowNumber - 1 because rowNumber is 1-based)

				//console.log('Here final check : ' + rowNumber + ' || ' + columnField + ' || ' + valueToSet);

				if (valueToSet == null) {
					valueToSet = '';
				}

				var row = table.getRow(rowNumber);

				// Check if the row exists
				if (row) {
					// Update the specific field in the row
					row.update({[columnField]: valueToSet});
				} else {
					console.error("Row not found");
				}
			}

			function getOptionText(selectId, value) {
				// Get the select element by ID
				const selectElement = document.getElementById(selectId);

				// Find the option with the specified value
				const option = Array.from(selectElement.options).find(opt => opt.value === value);

				// Check if the option exists and return its text
				if (option) {
					return option.text; // Get the text of the option
				} else {
					return 'Option not found';
				}
			}

			popUpTable.on("rowClick", function (e, row) {
				var incidentNo = row.getData().incident;
				
				clearAllFieldsAndTables();
				
				$('#incidentNo').val(incidentNo);
				//alert('here');
				selData();
				$('.modal-backdrop').hide();
				$('#closeBtn').trigger('click');

				$('#inciNoPop').val('');
				$('#inciLoc').val('');
				$('#fDtPop').val(getDateOneMonthAgo());
				$('#tDtPop').val(getCurrentDate());
				$('#srchPop').trigger('click');
			});

			$('#supplimentTo').css('color', '#d00');

			$('#addSupplement').on('click', function () {

				if ($('#incidentNo').val() == '') {
					message('CUW', 'Please enter incident number', 0);
					return;
				}

				$('#supplimentTo').val($('#incidentNo').val());
				$('#incidentNo').val('');
				$('#incidentNoHide').val('');
			});

			$('.dtfld').datepicker({
				dateFormat: "mm/dd/yy", // Set the date format
				/*onSelect: function (dateText) {
					cell.setValue(dateText); // Set the cell value when a date is selected
				}*/
			});

			$('#entered_inc_comp').on('change', function () {
				if ($(this).prop('checked')) {
					if ($('#ref_name').val() == '') {
						$(this).prop('checked', false);
						message('CUW', 'Please select the referral information', 0);
					} else {
						$('.ref_btn').removeAttr('disabled');
					}
				} else {
					$('.ref_btn').attr('disabled', true);
					$('input[name="ApproveddRadio"]').prop('checked', false);
					$('#approval_info').val('');
				}
			});

			$('input[name="ApproveddRadio"]').change(function () {
				if (!$('#entered_inc_comp').prop('checked')) {
					$('input[name="ApproveddRadio"]').prop('checked', false);
					$('#ok_info').val('move::ref_tab');
					$('#approve_given').val('N');
					$('#approval_info').val('');
					message('CUW', 'Please select Incident Completed check box before approving an incident.', 0);
				} else {
					setNames3xx(userId, 'approve_name');
					$('#approve_id').val(userId);
					$('#approve_dt').val(getCurrentDt());
					$('#approve_given').val('Y');
				}
			});

			$('#ok_btn').on('click', function () {
				if ($('#ok_info').val() != '') {
					var info = $('#ok_info').val();
					if (info.split('::')[0] == 'move') {
						$('#' + info.split('::')[1]).trigger('click');
					}
					$('#ok_info').val('');
				}
			});

			$('#delInci').on('click', function () {
				var combinedData = {};

				//alert(delData.length);

				if (dataToShow1.length > 0) {
					combinedData.tab0 = dataToShow1;
				}

				$.ajax({
					url: contextPath + "delIncident",
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(combinedData),
					success: function (response) {
						//alert('Data sent');
						message('CUS', 'Deleted Successfully', 0);
						selData();
					},
				});
			});

			$('#delInj').on('click', function () {
				var combinedData = {};

				//alert(delInjData.length);

				if (dataToShow2.length > 0) {
					combinedData.tab0 = dataToShow2;
				}

				$.ajax({
					url: contextPath + "delInjured",
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(combinedData),
					success: function (response) {
						//alert('Data sent');
						message('CUS', 'Deleted Successfully', 0);
						selData();
					},
				});
			});

			$('#newInci').on('click', function () {
			    const newRowData = {
			        id: Date.now(), // Use a unique ID like timestamp
			        INDV_DEL_FLG: "N",
			        rowid: "",
			        LI_INDIVIDUAL_NUM: "",
			        upd: "Y",
			        sbi_no: "",
			        INDV_SEQ_NUM: "",
			        COMMIT_NO: "",
			        NAME_LAST: "",
			        NAME_FIRST: "",
			        NAME_MIDDLE: "",
			        NAME_SUFFIX: "",
			        TITLE_PRSN: "",
			        SEX: "",
			        AGE: "",
			        RACE: "",
			        INDIVIDUAL_CATEGORY: "",
			        isNewlyAdded: true 
			    };
			    individualsInvolvedTbl.addData([newRowData], true); // Add as an array at the top
			});

			$('#newInj').on('click', function () {

				var rowCount = injuredTable.getData().length;
				//return;

				const newRowData = {
					id: rowCount,
					upd: "Y",
					INCD_VCTM_SEQ_NO: "",
					checkbox: "",
					injuredPerson: "",
					checkbox1: "",
					checkbox2: "",
					location: "",
					natureInjury: "",
				}; // Example new row data
				injuredTable.addData(newRowData, true); // true for adding at the top*/
				//setUpdate(individualsInvolvedTbl, rowCount);

			});

			$('#newEve').on('click', function () {

				var rowCount = evidenceTable.getData().length;
				//return;

				const newRowData = {
					id: rowCount,
					upd: "Y",
					INCD_EVDN_SEQ_NO: "",
					INCD_EVDN_TP: "",
					evidenceType: "",
					dateCollected: "",
					collectedName: "",
					securedName: "",
				}; // Example new row data
				evidenceTable.addData(newRowData, true); // true for adding at the top*/
				//setUpdate(individualsInvolvedTbl, rowCount);

			});

			$('#newCheckList').on('click', function () {

				var rowCount = standardCheckTbl.getData().length;
				//return;

				const newRowData = {
					id: rowCount,
					upd: "Y",
					QUES_CODE: "",
					checkbox: "",
					description: "",
					date: "",
					completedBy: "",
					completedFullName: "",
					comments: "",
				}; // Example new row data
				standardCheckTbl.addData(newRowData, true); // true for adding at the top*/
				//setUpdate(individualsInvolvedTbl, rowCount);

			});

			getLov('getType', individualsInvolvedTbl, 'LI_INDIVIDUAL_NUM', 'typ_val');
			getLov('getTitle', individualsInvolvedTbl, 'TITLE_PRSN', 'title_val');
			getLov('getRace', individualsInvolvedTbl, 'RACE', 'race_val');
			getLov('getCategory', individualsInvolvedTbl, 'INDIVIDUAL_CATEGORY', 'category_val');
			getLov('getEvType', evidenceTable, 'evidenceType', 'evidence_typ_val');
			getLov('getNatInj', injuredTable, 'natureInjury', 'nature_inj_val');

			function getLov(ws, tbl, field, hide_field) {
				$.ajax({
					url: contextPath + ws,
					method: 'POST',
					dataType: "json",
					success: function (response) {
						var jsonData = [];
						var jsonData2 = [];
						var entry = [];
						var content = '<option value="">Title</option>';
						for (var i = 0; i < response.length; i++) {

							if (response[i]['VAL'] != undefined) {
								content += '<option value="' + response[i]['VAL'] + '">' + response[i]['OPT'] + '</option>';
								entry = {
									value: response[i]['VAL'].trim(),
									label: response[i]['OPT'].trim()
								};
							} else {
								content += '<option value="' + response[i]['OPT'] + '">' + response[i]['OPT'] + '</option>';
								entry = {
									value: response[i]['OPT'].trim(),
									label: response[i]['OPT'].trim()
								};
							}

							if (ws == 'getTitle') {
								$('.titleFields').html(content);
							}

							jsonData.push(response[i]['OPT'].trim());
							jsonData2.push(entry);

						}

						const src1 = tbl.getColumn(field);
						src1.getDefinition().editorParams.values = jsonData; // Update the editorParams directly
						$('#' + hide_field).val(JSON.stringify(jsonData2));

					},
					error: function (error) {
						//console.error("Error getting table names:", error);
					}
				});
			}

			getNormLov('getWarrantType', 'warrentType', 'Warrant Type');
			getNormLov('getLocationCategory', 'locationCategory', 'Location Category');
			getNormLov('getTitle', 'approve_title', 'Title');

			function getNormLov(ws, field, lbl) {
				$.ajax({
					url: contextPath + ws,
					method: 'POST',
					dataType: "json",
					success: function (response) {
						var content = '<option value="">' + lbl + '</option>';
						for (var i = 0; i < response.length; i++) {

							if (response[i]['VAL'] != undefined) {
								content += '<option value="' + response[i]['VAL'] + '">' + response[i]['OPT'] + '</option>';
							} else {
								content += '<option value="' + response[i]['OPT'] + '">' + response[i]['OPT'] + '</option>';
							}

						}

						$('#' + field).html(content);

					},
					error: function (error) {
						//console.error("Error getting table names:", error);
					}
				});
			}


			$('#cellSearch').on('click', function () {

				//alert('start cell search');

				var fromDt = '';
				if ($('#cellDtFrom').val() != '') {
					fromDt = convertDateFormat($('#cellDtFrom').val());
				}

				var toDt = '';
				if ($('#cellDtTo').val() != '') {
					toDt = convertDateFormat($('#cellDtTo').val());
				}

				//alert($('#cellNo').val() + ' and ' + $('#institution').val() + ' and ' + fromDt + ' and ' + toDt + ' and ' + $('#cellLoc').val());

				$.ajax({
					method: "POST",
					url: contextPath + 'getCellSearch',
					dataType: "json",
					data: {
						irhSeq: $('#cellNo').val(),
						instNum: $('#institution').val(),
						dtFrom: fromDt,
						dtTo: toDt,
						srchLoc: $('#cellLoc').val(),
						instLoc: ''
					},

					success: function (response) {

						//alert(response.length);

						resetTable(cellTable, response.length);

						for (var i = 0; i < response.length; i++) {
							setValueForRowAndColumn(cellTable, i, 'cellSearch', response[i]['IRH_SEQ_NUM']);

							var dt = nullhandler(response[i]['REPORT_DATE']);
							var tm = '';

							if (dt != '' && dt != null) {
								tm = dt.split("T")[1];
								var hr = tm.split(":")[0];
								var mn = tm.split(":")[1];
								tm = hr + ":" + mn;
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(cellTable, i, 'reportdate', dt);
							setValueForRowAndColumn(cellTable, i, 'reporttime', tm);
							setValueForRowAndColumn(cellTable, i, 'searchlocation', response[i]['SEARCH_LOCATION']);
							setValueForRowAndColumn(cellTable, i, 'incident', response[i]['INCIDENT_SEQ_NUM']);

						}

					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			});

			$('#srchPop').on('click', function () {

				var fromDt = '';
				if ($('#fDtPop').val() != '') {
					fromDt = convertDateFormat($('#fDtPop').val());
				}

				var toDt = '';
				if ($('#fDtPop').val() != '') {
					toDt = convertDateFormat($('#tDtPop').val());
				}

				$.ajax({
					method: "POST",
					url: contextPath + 'getIncidents',
					dataType: "json",
					data: {
						incidentNo: $('#inciNoPop').val(),
						fromDt: fromDt,
						toDt: toDt,
						locCode: $('#inciLoc').val()
					},
					success: function (response) {
						resetTable(popUpTable, response.length);

						for (var i = 0; i < response.length; i++) {
							setValueForRowAndColumn(popUpTable, i, 'incident', response[i]['INCIDENT_SEQ_NUM']);

							var dt = nullhandler(response[i]['INCIDENT_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(popUpTable, i, 'date', dt);
							setValueForRowAndColumn(popUpTable, i, 'location', getOptionText('inciLoc', response[i]['COUNT_LOC_CODE']));

							console.log('status is ' + response[i]['SHIFT_COMMANDER_APR_FLAG']);

							if (response[i]['SHIFT_COMMANDER_APR_FLAG'] == 'A') {
								setValueForRowAndColumn(popUpTable, i, 'status', 'Approved');
							}

							if (response[i]['SHIFT_COMMANDER_APR_FLAG'] == 'D') {
								setValueForRowAndColumn(popUpTable, i, 'status', 'Disapproved');
							}

							if (response[i]['SHIFT_COMMANDER_APR_FLAG'] == null || response[i]['SHIFT_COMMANDER_APR_FLAG'] == 'N') {
								setValueForRowAndColumn(popUpTable, i, 'status', 'Open');
							}

						}

					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			});

			function generateGrpPop(grpSeq) {

				$.ajax({
					method: "POST",
					url: contextPath + 'getGropDtls',
					dataType: "json",
					data: {
						grpSeq: grpSeq
					},
					success: function (response) {
						resetTable(groupSuppTable, response.length);

						for (var i = 0; i < response.length; i++) {
							//setValueForRowAndColumn(groupSuppTable, i, 'incident', response[i]['INCIDENT_SEQ_NUM']);
							setValueForRowAndColumn(groupSuppTable, i, 'incident', response[i]['INCIDENT_SEQ_NUM']);

							var dt = nullhandler(response[i]['INCIDENT_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(groupSuppTable, i, 'date', dt);
							setValueForRowAndColumn(groupSuppTable, i, 'time', response[i]['INCIDENT_TIME']);
							setValueForRowAndColumn(groupSuppTable, i, 'loc', response[i]['INST'].split(' ')[0]);
							setValueForRowAndColumn(groupSuppTable, i, 'shortDescription', response[i]['SHORT_DESCRIPTION']);

						}

					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			/*setTimeout(function () {
				//getUserInst();
				var inst = '03';
				$('#institution').val(inst.trim());
				$('#institution').trigger('change');
			}, 2000);*/

			setTimeout(function () {
				$('#srchPop').trigger('click');
				$('#cellSearch').trigger('click');
			}, 4000);

			$('#cellSrchBtn').on('click', function () {
				$('#cellNo').val('');
				$('#cellDtFrom').val('');
				$('#cellDtTo').val('');
				$('#cellLoc').val('');
				$('#cellSearch').trigger('click');
			});

			$('#institution').on('change', function () {
				getBuilding($(this).val());
			});

			function nullhandler(str) {
				if (str == 'null' || str == null) {
					return '';
				} else {
					return str;
				}
			}

			$('#incidentNo').on('keyup', function (e) {
				if (e.which == 13) {
					selData();
				}
			});

			function setupTrimmedTextarea(fieldSelector, counterSelector, maxLen, label) {
				// Get initial text safely
				var text = ($(fieldSelector).val() || '').toString();

				// Trim on load if needed
				if (text.length > maxLen) {
					message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
					text = text.substring(0, maxLen);
					$(fieldSelector).val(text);
				}

				// ✅ Update counter immediately
				$(counterSelector).text($(fieldSelector).val().length);

				// ✅ Live input listener
				$(fieldSelector).off('input.trimCounter').on('input.trimCounter', function () {
					var val = $(this).val() || '';

					if (val.length > maxLen) {
						message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
						val = val.substring(0, maxLen); // Trim immediately
						$(this).val(val);
					}

					$(counterSelector).text(val.length);
				});
			}



			function setupCharacterLimitedTextarea(textareaSelector, counterSelector, maxLength, initialText) {
				const $textarea = $(textareaSelector);
				const $counter = $(counterSelector);
				let text = (initialText || '').toString();
				if (text.length > maxLength) {
					text = text.substring(0, maxLength);
				}
				$textarea.val(text);
				$counter.text(text.length);
				$textarea.off('input.charLimit').on('input.charLimit', function () {
					let currentVal = $(this).val();
					if (currentVal.length > maxLength) {
						message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
						currentVal = currentVal.substring(0, maxLength);
						$(this).val(currentVal);
					}
					$counter.text(currentVal.length);
				});
			}


			function selData() {
				// ----------- PRE-AJAX DATE VALIDATION -----------
				var inciDateStr = $('#inciDt').val();
				if (inciDateStr) {
					var parts = inciDateStr.split('/');
					if (parts.length === 3) {
						var mm = parseInt(parts[0], 10);
						var dd = parseInt(parts[1], 10);
						var yyyy = parseInt(parts[2], 10);
						var dateVal = new Date(yyyy, mm - 1, dd);
						var today = new Date();
						today.setHours(0, 0, 0, 0);

						if (dateVal > today) {
							message('CER', 'Incident Date cannot be in the future.', 0);
							return; // Stop execution if future date
						}
					} else {
						message('CER', 'Invalid Incident Date format.', 0);
						return; // Stop execution if invalid format
					}
				}
				// -----------------------------------------------

				$('#cellSrchNo').val('');
				var incidentNo = $('#incidentNo').val();
				if (!incidentNo) return;

				$('#gen_tab').trigger('click');

				$.ajax({
					method: "POST",
					url: contextPath + 'fetchIncidentInfo',
					dataType: "json",
					data: { incidentNo: incidentNo },
					success: function (response) {
						if (!response || !response.length) {
							console.warn('selData: no response or empty array', response);
							message('CUW', 'No incident data found.', 0);
							return;
						}

						var r = response[0];
						console.log('selData response[0]:', r);

						$('#groupNo').val(r.INCIDENT_GRP_SEQ_NO || '');
						if ($('#groupNo').val() !== '') {
							generateGrpPop(r.INCIDENT_GRP_SEQ_NO);
						}

						$('#incident_tp').val(r.INCIDENT_TP || '');
						$('#incident_tp_val').val(getValueArray(myTypNo, r.INCIDENT_TP || ''));
						$('#institution').val(r.INST_NUM || '');
						$('#institution_val').val(getValueArray(myInstNo, r.INST_NUM || ''));
						$('#supplimentTo').val(r.INITIAL_INCIDENT_SEQ_NUM || '');

						function isoToMmDdY(iso) {
							if (!iso) return '';
							var parts = (iso.split('T')[0] || '').split('-');
							if (parts.length !== 3) return '';
							return parts[1] + '/' + parts[2] + '/' + parts[0];
						}

						// ------------------ INCIDENT DATE ------------------
						var inciDate = isoToMmDdY(r.INCIDENT_DATE);
						$('#inciDt').val(inciDate || '');
						// ---------------------------------------------------

						$('#inciTm').val(r.INCIDENT_TIME || '');
						$('#shortDesc').val(r.SHORT_DESCRIPTION || '');

						if (r.COUNT_LOC_CODE && r.COUNT_LOC_CODE !== 'SCI000087') {
							$('#location').val(r.COUNT_LOC_CODE);
							$('#location_val').val(getValueArray(myLocNo, r.COUNT_LOC_CODE));
						} else {
							$('#location').val('');
							$('#location_val').val('');
						}

						$('#locationDesc').val(r.INCIDENT_LOCATION || '');
						$('#entered_dt').val(isoToMmDdY(r.INCIDENT_DATE_ENTER));
						$('#entered_title').val(r.TITLE_ENTER || '');

						// ----------------- COMMENTS FIELDS -----------------
						$('#entered_cmt').val(r.INCIDENT_COMNT_ENTER || '');
						setupCharacterLimitedTextarea('#entered_cmt', '#enterdcmt', 2000, r.INCIDENT_COMNT_ENTER);
						$('#doc_cmt').val(r.INCIDENT_COMNT_REPORTER || '');
						setupCharacterLimitedTextarea('#doc_cmt', '#doccmts', 2000, r.INCIDENT_COMNT_REPORTER);

						$('#doc_cmt').val(r.INCIDENT_COMNT_REPORTER || '');
						setupTrimmedTextarea('#doc_cmt', '#docCount', 2000, 'Reporter Comments');

						$('#ref_cmt').val(r.REFERRED_TO_COMMENTS || '');
						setupTrimmedTextarea('#ref_cmt', '#refcmts', 2000, 'Referred Comments');

						$('#follow_outcome_cmt').val(r.INCIDENT_OUTCOME || '');
						setupTrimmedTextarea('#follow_outcome_cmt', '#followout_cmt', 2000, 'Incident Outcome');

						$('#follow_cmt').val(r.INCIDENT_COMNT || '');
						setupTrimmedTextarea('#follow_cmt', '#followcmt', 2000, 'Follow-up Comments');

						$('#inciDesc').val(r.INCIDENT_DESC || '');
						setupTrimmedTextarea('#inciDesc', '#inciCount', 32000, 'Incident Description');

						$('#InjComments').val(r.INJ_COMMENTS || '');
						setupTrimmedTextarea('#InjComments', '#injCount', 1000, 'Injured Comments');

						$('#EveComments').val(r.EVE_COMMENTS || '');
						setupTrimmedTextarea('#EveComments', '#eviCount', 100, 'Evidence Comments');
						// ---------------------------------------------------

						$('#doc_dt').val(isoToMmDdY(r.INCIDENT_DATE_REVIEW));
						$('#doc_title').val(r.TITLE_REPORTED || '');
						$('#doc_check').prop('checked', r.SOURCE_TYPE === 'Y');
						$('#defaultInline1').prop('checked', r.PREA_FLAG === 'Y');
						$('#defaultInline2').prop('checked', r.CONFIDENTIAL_FLAG === 'Y');
						$('#defaultInlined').prop('checked', r.STG_FLAG === 'Y');

						if (r.SEND_NOTIFICATION_FLAG === 'Y') {
							$('#entered_inc_comp').prop('checked', true);
							$('.ref_btn').removeAttr('disabled');
						} else {
							$('#entered_inc_comp').prop('checked', false);
							$('.ref_btn').attr('disabled', true);
							$('input[name="ApproveddRadio"]').prop('checked', false);
							$('#approval_info').val('');
						}

						$('#ref_dt').val(isoToMmDdY(r.REFERRED_TO_DATE));
						$('#ref_title').val(r.TITLE_REFER || '');

						$('#entered_id').val(r.USER_ID_ENTERED_BY || '');
						$('#doc_id').val(r.USER_ID_REPORTED_BY || '');
						$('#ref_id').val(r.USER_ID_REFERRED || '');

						$('#warrentType').val(r.WARRANT_TYPE || '');
						$('#warrantNumber').val(r.WARRANT_NUMBER || '');
						$('#sexAllegation').val(r.SEXUAL_ALLEG_REF_CODE || '');
						$('#locationCategory').val(r.LOCATION_CATEGORY || '');
						$('#offenderRape').prop('checked', r.OFFENDER_STATES_RAPE === 'Y');

						setNames(nullhandler(r.USER_ID_ENTERED_BY), 'entered_name');
						setNames(nullhandler(r.USER_ID_REPORTED_BY), 'doc_name');
						setNames(nullhandler(r.USER_ID_REFERRED), 'ref_name');

						genInfoTable.setData("fetchIncidentGenInfo?incidentNo=" + (r.INCIDENT_SEQ_NUM || '') + "&instNum=" + (r.INST_NUM || ''));
						setSuppliemt(r.INCIDENT_SEQ_NUM);
						setDNum(r.INCIDENT_SEQ_NUM);

						$('.hsdt').val('');
						setIndividualsInvolved(r.INCIDENT_SEQ_NUM, r.INST_NUM);
						setFetchStandardCheckList(r.INCIDENT_SEQ_NUM, r.INST_NUM);

						setInjuredPerson(r.INCIDENT_SEQ_NUM);
						setEvidence(r.INCIDENT_SEQ_NUM);
						setApproval(r.INCIDENT_SEQ_NUM);
						setRefHistory(r.INCIDENT_SEQ_NUM);

						var typeAction = "UPDATE";
						$('.auditCheck:checked').each(function () {
							typeAction = $(this).val();
						});

						setAudit(r.INCIDENT_SEQ_NUM, r.INST_NUM, typeAction);
						setAssignInvestigator(r.INCIDENT_SEQ_NUM, r.INST_NUM, r.INCIDENT_GRP_SEQ_NO);
						setAssignLeadInv(r.INCIDENT_SEQ_NUM, r.INST_NUM);
						setAsnMoreRev(r.INCIDENT_SEQ_NUM, r.INST_NUM);
					},
					error: function (error) {
						console.error('selData error:', error);
						message('CER', 'Error fetching incident data', 0);
					}
				});
			}

			// Radio change handling
			$('.auditCheck').on('change', function () {
				$('.auditCheck').prop('checked', false);
				$(this).prop('checked', true);
				var incident = $('#incidentNo').val();
				var inst = $('#institution').val();
				setAudit(incident, inst, $(this).val());
			});

			// Set name fields
			function setNames(userid, field) {
				$.ajax({
					method: "POST",
					url: contextPath + 'getNames',
					dataType: "json",
					data: {userid: userid},
					success: function (response) {
						var lname = nullhandler(response[0]['USER_LAST_NAME']) + ' ';
						var fname = nullhandler(response[0]['USER_FIRST_NAME']) + ' ';
						var mname = nullhandler(response[0]['USER_MID_NAME']) + ' ';
						var sname = nullhandler(response[0]['USER_SUFFIX_NAME']) + ' ';

						var nam = lname + fname + mname + sname;
						nam = commaName(nam);
						$('#' + field).val(nam);
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}
			function setSuppliemt(incident_seq) {
				clearFunc2(supplimentTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'getSuppliment',
					dataType: "json",
					data: {
						incidentNo: incident_seq
					},
					success: function (response) {
						console.log(response.length);
						//alert(response.length);
						for (var i = 0; i < response.length; i++) {
							setValueForRowAndColumn(supplimentTbl, i, "supplementary", response[i]['INCIDENT_SEQ_NUM']);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			function setDNum(incident_seq) {
				clearFunc2(dnumTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'getDReport',
					dataType: "json",
					data: {
						incidentNo: incident_seq
					},
					success: function (response) {
						console.log(response.length);
						//alert(response.length);
						for (var i = 0; i < response.length; i++) {
							setValueForRowAndColumn(dnumTbl, i, "dReportNum", response[i]['D_REPORT_NUM']);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			function setIndividualsInvolved(incident_seq, inst_num) {
			    clearFunc(individualsInvolvedTbl);
			    var currentInstitution = $('#institution').val();
			    if (currentInstitution) {
			        tblTypForce.setData("fetchTypForce?incidentNo=&instNum=" + currentInstitution + "&indSeq=");
			        tblTypRestraint.setData("fetchTypRestraint?incidentNo=&instNum=" + currentInstitution + "&indSeq=");
			        tblActionTaken.setData("fetchActionTaken?incidentNo=&instNum=" + currentInstitution + "&indSeq=");
			    } else {
			        tblTypForce.clearData();
			        tblTypRestraint.clearData();
			        tblActionTaken.clearData();
			    }
			    $('.hsdt').val('');
			    $('#curr_indv_fld').val('');
			    $('#current_fld').val('');
			    $.ajax({
			        method: "POST",
			        url: contextPath + 'fetchIncidentIndivdualInfo',
			        dataType: "json",
			        data: {
			            incidentNo: incident_seq,
			            instNum: inst_num
			        },
			        success: function (response) {
			            console.log("Individual : " + response.length);
			            injuredPersons = [];
			            for (var i = 0; i < response.length; i++) {
			                var rowNum = i + 1;
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "upd", "N");
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "sbi_no", response[i]['sbi_no']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "NAME_LAST", response[i]['NAME_LAST']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "NAME_FIRST", response[i]['NAME_FIRST']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "NAME_MIDDLE", response[i]['NAME_MIDDLE']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "NAME_SUFFIX", response[i]['NAME_SUFFIX']);
			                var person = (response[i]['NAME_LAST'] != null ? response[i]['NAME_LAST'] : "") + " ";
			                person += (response[i]['NAME_FIRST'] != null ? response[i]['NAME_FIRST'] : "") + " ";
			                person += (response[i]['NAME_MIDDLE'] != null ? response[i]['NAME_MIDDLE'] : "") + " ";
			                person += (response[i]['NAME_SUFFIX'] != null ? response[i]['NAME_SUFFIX'] : "") + " ";
			                person = commaName(person);
			                if (person.trim() !== '') {
			                    injuredPersons.push(person);
			                }
			                var sex = '';
			                if (response[i]['SEX'] == 'M') {
			                    sex = 'Male';
			                }
			                if (response[i]['SEX'] == 'F') {
			                    sex = 'Female';
			                }
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "SEX", sex);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "AGE", response[i]['AGE']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "rowid", response[i]['ROWIDTOCHAR(A.ROWID)']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "INDV_SEQ_NUM", response[i]['INDV_SEQ_NUM']);
			                setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "COMMIT_NO", response[i]['COMMIT_NO']);
			                if (response[i]['LI_INDIVIDUAL_NUM'] != null) {
			                    var dynamic_Array1 = JSON.parse($('#typ_val').val());
			                    const selectedOption1 = dynamic_Array1.find(option => option.value === response[i]['LI_INDIVIDUAL_NUM']);
			                    if (selectedOption1) setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "LI_INDIVIDUAL_NUM", selectedOption1.label);
			                }
			                if (response[i]['TITLE_PRSN'] != null) {
			                    var dynamic_Array2 = JSON.parse($('#title_val').val());
			                    const selectedOption2 = dynamic_Array2.find(option => option.value === response[i]['TITLE_PRSN']);
			                    if (selectedOption2) setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "TITLE_PRSN", selectedOption2.label);
			                }
			                if (response[i]['RACE'] != null) {
			                    var dynamic_Array3 = JSON.parse($('#race_val').val());
			                    const selectedOption3 = dynamic_Array3.find(option => option.value === response[i]['RACE']);
			                    if (selectedOption3) setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "RACE", selectedOption3.label);
			                }
			                if (response[i]['INDIVIDUAL_CATEGORY'] != null) {
			                    var dynamic_Array4 = JSON.parse($('#category_val').val());
			                    const selectedOption4 = dynamic_Array4.find(option => option.value === response[i]['INDIVIDUAL_CATEGORY']);
			                    if (selectedOption4) setValueForRowAndColumn(individualsInvolvedTbl, rowNum, "INDIVIDUAL_CATEGORY", selectedOption4.label);
			                }
			            }
			            const column = injuredTable.getColumn("injuredPerson");
			            column.updateDefinition({
			                editorParams: {
			                    allowEmpty: true,
			                    listOnEmpty: true,
			                    valuesLookup: true,
			                    autocomplete: true,
			                    values: injuredPersons
			                }
			            });
			        },
			        error: function (error) {
			            console.error('Error fetching individuals involved:', error);
			            console.log(error.responseText);
			        }
			    });
			}

			//Define Table
			var cellTable = new Tabulator("#selectCellSearch-table", {
				layout: "fitColumns",
				data: tabledataselectCellSearch,
				height: '200px',
				printAsHtml: true,
				printStyled: true,
				columns: [
					{title: "id", field: "id", visible: false},
					{title: "upd", field: "upd", visible: false},
					{title: "seqno", field: "seqno", visible: false},

					{
						title: "cell Search#",
						titleFormatter: (column) => setTitleDesc(column, 'Re_Search#', 'cell Search#'),
						field: "cellSearch",
					},
					{
						title: "Report Date",
						titleFormatter: (column) => setTitleDesc(column, 'Re_Report_Date', 'Report Date'),
						field: "reportdate",
					},
					{
						field: "reporttime",
						visible: false
					},
					{
						title: "Search location",
						titleFormatter: (column) => setTitleDesc(column, 'Re_Search location', 'Search location'),
						field: "searchlocation",
					},
					{
						title: "Incident#",
						titleFormatter: (column) => setTitleDesc(column, 'Re_Incident#1', 'Incident#'),
						field: "incident",
					},
				]
			});

			tabulatorRegistry["selectCellSearch-table"] = {
				varName: "cellTable",
				instance: cellTable
			};

			cellTable.on("rowClick", function (e, row) {
				//alert("Row " + row.getData().user_name + " Clicked!!!!");
				var CurrInst = $('#institution_val').val();
				$('.form-control').val('');
				
					$('#institution_val').val(CurrInst);

					var incidentNo = row.getData().incident;

					if (incidentNo != null && incidentNo != '') {

						$('#incidentNo').val(incidentNo);
						selData();

					} else {

						$('#cellSrchNo').val(row.getData().cellSearch);
						$('#inciDt').val(row.getData().reportdate);
						$('#inciTm').val(row.getData().reporttime);
						$('#shortDesc').val('Cell Search Report');
						$('#locationDesc').val(row.getData().searchlocation);
						$('#incident_tp_val').val('Inmate Involved');
						var cellNo = row.getData().cellSearch;

						setIndividualsInvolvedByCell(cellNo);
						setEvidenceByCell(cellNo);

					}
					
					$('.modal-backdrop').hide();
					document.getElementById("closeCellSrchPop").click();
			});

			function setIndividualsInvolvedByCell(cellNo) {
				clearFunc(individualsInvolvedTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'getInciIndvInfoByCell',
					dataType: "json",
					data: {cellNo: cellNo},
					success: function (response) {
						console.log("Individual from cell : " + response.length);
						$('#current_fld').val('1');

						//alert(response.length);
						for (var i = 0; i < response.length; i++) {

							console.log(i + ' & a');

							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "upd", "N");
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "sbi_no", response[i]['SBI_NO']);
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "NAME_LAST", response[i]['USER_LAST_NAME']);
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "NAME_FIRST", response[i]['USER_FIRST_NAME']);
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "NAME_MIDDLE", response[i]['USER_MID_NAME']);
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "NAME_SUFFIX", response[i]['USER_SUFFIX_NAME']);

							var person = (response[i]['USER_LAST_NAME'] != null ? response[i]['USER_LAST_NAME'] : "") + " ";
							person += (response[i]['USER_FIRST_NAME'] != null ? response[i]['USER_FIRST_NAME'] : "") + " ";
							person += (response[i]['USER_MID_NAME'] != null ? response[i]['USER_MID_NAME'] : "") + " ";
							person += (response[i]['USER_SUFFIX_NAME'] != null ? response[i]['USER_SUFFIX_NAME'] : "") + " ";
							person = commaName(person);

							/*var sex = '';

							if (response[i]['SEX'] == 'M') {
								sex = 'Male';
							}

							if (response[i]['SEX'] == 'F') {
								sex = 'Female';
							}

							console.log(i + ' & b');*/

							//setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "SEX", sex);
							//setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "AGE", response[i]['AGE']);
							//setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "rowid", response[i]['ROWIDTOCHAR(A.ROWID)']);
							//setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "INDV_SEQ_NUM", response[i]['INDV_SEQ_NUM']);
							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "COMMIT_NO", response[i]['COMMIT_NO']);

							console.log(i + ' & c');

							var person_type = '';

							if (response[i]['PERSON_TYPE'] == 'I') {
								person_type = 'INMATE';
							}

							if (response[i]['PERSON_TYPE'] == 'S') {
								person_type = 'STAFF';
							}

							setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "LI_INDIVIDUAL_NUM", person_type);

							if (response[i]['SBI_NO'] != null) {
								var row = individualsInvolvedTbl.getRow(i + 1);
								var cell = row.getCell('sbi_no');
								fetchInmateNames(response[i]['SBI_NO'], i + 1, cell);
							}

							/*if (response[i]['PERSON_TYPE'] != null) {
								var dynamic_Array1 = JSON.parse($('#typ_val').val());
								alert($('#typ_val').val());
								alert(response[i]['PERSON_TYPE']);
								const selectedOption1 = dynamic_Array1.find(option => option.value === response[i]['PERSON_TYPE']); // Find the corresponding option
								setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "LI_INDIVIDUAL_NUM", selectedOption1.label);
							}*/

							/*if (response[i]['TITLE_PRSN'] != null) {
								var dynamic_Array2 = JSON.parse($('#title_val').val());
								const selectedOption2 = dynamic_Array2.find(option => option.value === response[i]['PERSON_TYPE']); // Find the corresponding option
								setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "TITLE_PRSN", selectedOption2.label);
							}*/

							/*if (response[i]['RACE'] != null) {
								var dynamic_Array3 = JSON.parse($('#race_val').val());
								const selectedOption3 = dynamic_Array3.find(option => option.value === response[i]['RACE']); // Find the corresponding option
								setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "RACE", selectedOption3.label);
							}

							if (response[i]['INDIVIDUAL_CATEGORY'] != null) {
								var dynamic_Array4 = JSON.parse($('#category_val').val());
								const selectedOption4 = dynamic_Array4.find(option => option.value === response[i]['INDIVIDUAL_CATEGORY']); // Find the corresponding option
								setValueForRowAndColumn(individualsInvolvedTbl, i + 1, "INDIVIDUAL_CATEGORY", selectedOption4.label);
							}*/

							console.log(i + ' & d');

							//alert($('#title_val').val());
							//getValueArray(myTypNo, response[0]['TITLE_PRSN']);
							//setValueForRowAndColumn(individualsInvolvedTbl, i+1, "TITLE_PRSN", response[i]['INDIVIDUAL_CATEGORY']); 
							//!@#$
						}

					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			function setFetchStandardCheckList(incident_seq, inst_num) {
				clearFunc2(standardCheckTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchStandardCheckList',
					dataType: "json",
					data: {incidentNo: incident_seq, instNum: inst_num},
					success: function (response) {
						console.log(response.length);
						//alert(response.length);
						for (var i = 0; i < response.length; i++) {

							var dt = nullhandler(response[i]['CHKLIST_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(standardCheckTbl, i, "date", dt);
							setValueForRowAndColumn(standardCheckTbl, i, "checkbox", response[i]['CB_COMPLETED']);
							setValueForRowAndColumn(standardCheckTbl, i, "description", response[i]['QUES_DESC']);
							setValueForRowAndColumn(standardCheckTbl, i, "completedBy", response[i]['COMPLETED_BY']);
							setValueForRowAndColumn(standardCheckTbl, i, "comments", response[i]['COMMENTS']);
							setValueForRowAndColumn(standardCheckTbl, i, "QUES_CODE", response[i]['QUES_CODE']);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}


			function setAssignInvestigator(incidentNo, instNum, grpNo) {
				if (!incidentNo || !instNum) {
					$('#invg_seq_num_hide').val('');
					$('#inv_off_id').val('');
					$('#inv_off').val('');
					$('#inv_dt').val('');
					$('#inv_tm').val('');
					$('#inv_notes').val('');
					$('#invCount').text(0);
					setForwardedTo(null);
					return;
				}
				$.ajax({
					method: "GET",
					url: contextPath + 'fetchAssignInvestigator',
					dataType: "json",
					data: {
						incidentNo: incidentNo,
						instNum: instNum,
						grpSeqNo: grpNo || ''
					},
					success: function (response) {
						if (response && response.length > 0) {
							var leadInvestigator = response[0];

							$('#invg_seq_num_hide').val(leadInvestigator.INVG_SEQ_NUM);
							$('#inv_dt').val(formatDate(leadInvestigator.INVSTGR_ASSIGNED_DATE));
							$('#inv_tm').val(leadInvestigator.INVSTGR_ASSIGEND_TIME);

							// Handle inv_notes with max 2000 characters
							var maxLen = 2000;
							var notes = (leadInvestigator.INVSTGR_ASSIGNED_COMMENT || '').toString();
							if (notes.length > maxLen) {
								message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
								notes = notes.substring(0, maxLen);
							}
							$('#inv_notes').val(notes);
							$('#invCount').text(notes.length);

							// Update counter on typing/pasting
							var $notesField = $('#inv_notes');
							$notesField.off('input.inv_notes').on('input.inv_notes', function () {
								var val = $(this).val() || '';
								if (val.length > maxLen) {
									message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
									val = val.substring(0, maxLen);
									$(this).val(val);
								}
								$('#invCount').text(val.length);
							});

							var investigatorUserId = leadInvestigator.USER_ID_INVSTGR_ASSIGNED;
							if (investigatorUserId) {
								$('#inv_off_id').val(investigatorUserId);
								setNames(investigatorUserId, 'inv_off');
							}

							setForwardedTo(leadInvestigator.INVG_SEQ_NUM);

						} else {
							$('#invg_seq_num_hide').val('');
							$('#inv_off_id').val('');
							$('#inv_off').val('');
							$('#inv_dt').val('');
							$('#inv_tm').val('');
							$('#inv_notes').val('');
							$('#invCount').text(0);
							setForwardedTo(null);
						}
					},
					error: function (error) {
						console.error('Error fetching investigator data:', error);
						$('#invCount').text(0);
						setForwardedTo(null);
					}
				});
			}

			function setAssignLeadInv(incidentNo, instNum) {
				clearFunc2(assignLeadTable);
				if (!incidentNo || !instNum) {
					return;
				}
				$.ajax({
					method: "GET",
					url: contextPath + 'fetchAssignLeadInv',
					dataType: "json",
					data: {
						incidentNo: incidentNo,
						instNum: instNum
					},
					success: function (response) {
						for (var i = 0; i < response.length; i++) {
							var item = response[i];
							setValueForRowAndColumn(assignLeadTable, i, "incident", nullhandler(item['INCIDENT_SEQ_NUM']));
							setValueForRowAndColumn(assignLeadTable, i, "firstname", "");
							setValueForRowAndColumn(assignLeadTable, i, "date", formatDate(item['INCIDENT_DATE']));
							setValueForRowAndColumn(assignLeadTable, i, "time", nullhandler(item['INCIDENT_TIME']));
							setValueForRowAndColumn(assignLeadTable, i, "shortDescription", nullhandler(item['SHORT_DESCRIPTION']));
						}
					},
					error: function (error) {
						console.error('Error fetching related incidents data:', error);
					}
				});
			}

			function setForwardedTo(invgSeqNum) {
				var maxLen = 500;
				var $reasonField = $('#reasonForForwarding');
				var $reasonCount = $('#reasonCount');
				$reasonField.val('');
				$reasonCount.text('0');
				if (!invgSeqNum) {
					otherInvestTable.setData(otherInvest);
					return;
				}
				$.ajax({
					method: "GET",
					url: contextPath + 'fetchForwardedTo',
					dataType: "json",
					data: {invgSeqNum: invgSeqNum},
					success: function (response) {
						let finalData = [];
						if (response && response.length > 0) {
							finalData = response.map(function (item, index) {
								var reason = nullhandler(item.REASON_FOR_FORWARD) || "";
								if (reason.length > maxLen) {
									reason = reason.substring(0, maxLen);
								}
								return {
									id: index,
									assignedTo: nullhandler(item.INVG_FORWARD_TO_USER_NM),
									date: formatDate(item.INVG_FORWARD_DATE),
									time: nullhandler(item.INVG_FORWARD_TIME),
									reasonForForward: reason,
									invg_forward_seq_num: nullhandler(item.INVG_FORWARD_SEQ_NUM),
									user_id: nullhandler(item.INVG_FORWARD_TO_USER_ID)
								};
							});
						}
						while (finalData.length < 5) {
							finalData.push({
								id: finalData.length,
								assignedTo: "",
								date: "",
								time: "",
								reasonForForward: ""
							});
						}
						otherInvestTable.setData(finalData);
						if (finalData[0] && finalData[0].reasonForForward) {
							var initialReason = finalData[0].reasonForForward;
							$reasonField.val(initialReason);
							$reasonCount.text(initialReason.length);
						} else {
							$reasonField.val('');
							$reasonCount.text('0');
						}
						$reasonField.off('input.reasonForForwarding').on('input.reasonForForwarding', function () {
							var $this = $(this);
							var val = $this.val() || '';
							var currentLength = val.length;
							if (currentLength > maxLen) {
								message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
								val = val.substring(0, maxLen);
								$this.val(val);
								currentLength = maxLen;
							}
							$reasonCount.text(currentLength);
							if (activeOtherInvestRowId !== null) {
								var row = otherInvestTable.getRow(activeOtherInvestRowId);
								if (row) {
									row.update({reasonForForward: val});
								}
							}
						});
					},
					error: function (error) {
						console.error('Error fetching forwarded-to data:', error);
						otherInvestTable.setData(otherInvest);
					}
				});
			}			//!@#$
			$('#InvestigatorDetailsModal').on('shown.bs.modal', function () {
				investigatorDetailsTable.clearData();
				$('#InvestigatorDetailsModal #Find').val('');
				investigatorDetailsTable.setData(contextPath + 'getIncidentStaff?srchkey=');
				setTimeout(function () {
					$('#InvestigatorDetailsModal #Find').focus();
				}, 100);
			});

			$('#staffNameModal').on('shown.bs.modal', function () {
				staffTable.clearData();
				$('#staffNameModal #srchBar').val('');
				staffTable.setData(contextPath + 'getIncidentStaff?srchkey=');
				setTimeout(function () {
					$('#staffNameModal #srchBar').focus();
				}, 100);
			});

			$('#InvestigatorDetailsModal #fetchDataBtn').on('click', function () {
				var searchTerm = $('#InvestigatorDetailsModal #Find').val().toLowerCase();
				investigatorDetailsTable.setData('getIncidentStaff?srchkey=' + searchTerm);
			});

			$('#InvestigatorDetailsModal #Find').on('keydown', function (e) {
				if (e.key === 'Enter' || e.keyCode === 13) {
					e.preventDefault();
					$('#InvestigatorDetailsModal #fetchDataBtn').trigger('click');
				}
			});

			function getCurrentTime24() {
				const now = new Date();
				const hours = now.getHours().toString().padStart(2, '0');
				const minutes = now.getMinutes().toString().padStart(2, '0');
				return `${hours}:${minutes}`;
			}

			investigatorDetailsTable.on("rowClick", function (e, row) {
				var rowData = row.getData();
				var fullName = (nullhandler(rowData.USER_LAST_NAME) + ' ' + nullhandler(rowData.USER_FIRST_NAME)).trim();
				$('#inv_off').val(fullName);
				$('#inv_off_id').val(rowData.USER_ID);
				$('#inv_dt').val(getCurrentDt());
				$('#inv_tm').val(getCurrentTime24());
				$('#InvestigatorDetailsModal').modal('hide');
			});

			$('#InvestigatorDetailsModal #okInvestigator').on('click', function () {
				var selectedRows = investigatorDetailsTable.getSelectedRows();
				if (selectedRows.length > 0) {
					var selectedData = selectedRows[0].getData();
					var fullName = (nullhandler(selectedData.USER_LAST_NAME) + ' ' + nullhandler(selectedData.USER_FIRST_NAME)).trim();
					$('#inv_off').val(fullName);
					$('#inv_off_id').val(selectedData.USER_ID);
					$('#InvestigatorDetailsModal').modal('hide');
				} else {
					message('CUW', 'Please select an investigator.', 0);
				}
			});

			$('#InvestigatorDetailsModal').on('hidden.bs.modal', function () {
				$('.modal-backdrop').remove();
				$('body').removeClass('modal-open');
			});

			var activeOtherInvestRowId = null;

			otherInvestTable.on("rowClick", function (e, row) {
				otherInvestTable.getRows().forEach(function (r) {
					r.getElement().classList.remove('active-row-highlight');
				});
				row.getElement().classList.add('active-row-highlight');

				activeOtherInvestRowId = row.getData().id;
				var comment = row.getData().reasonForForward || "";
				$('#reasonForForwarding').val(comment);
				$('#reasonCount').text(comment.length);
			});


			$('#reasonForForwarding').on('keyup', function () {
				if (activeOtherInvestRowId !== null) {
					var row = otherInvestTable.getRow(activeOtherInvestRowId);
					if (row) {
						row.update({reasonForForward: $(this).val()});
					}
				}
			});

			$('#investigatorModal').on('shown.bs.modal', function () {
				investigatorStaffTable.clearData();
				$('#investigatorModal #Find').val('');
				investigatorStaffTable.setData(contextPath + 'getIncidentStaff?srchkey=');
				setTimeout(function () {
					$('#investigatorModal #Find').focus();
				}, 100);
			});

			$('#investigatorModal #fetchDataBtn').on('click', function () {
				var searchTerm = $('#investigatorModal #Find').val().trim().toLowerCase();
				investigatorStaffTable.setData(contextPath + 'getIncidentStaff?srchkey=' + searchTerm);
			});

			$('#investigatorModal #Find').on('keydown', function (e) {
				if (e.key === 'Enter' || e.keyCode === 13) {
					e.preventDefault();
					$('#investigatorModal #fetchDataBtn').trigger('click');
				}
			});

			investigatorStaffTable.on("rowClick", function (e, row) {
				var selectedUser = row.getData();
				var targetRowId = $('#investigatorModal').data('row-id');

				if (targetRowId !== undefined) {
					var fullName = (nullhandler(selectedUser.USER_LAST_NAME) + ' ' + nullhandler(selectedUser.USER_FIRST_NAME)).trim();
					var targetRow = otherInvestTable.getRow(targetRowId);
					const currentDate = getCurrentDate();
					const now = new Date();
					const currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

					if (targetRow) {
						targetRow.update({
							assignedTo: fullName,
							user_id: selectedUser.USER_ID,
							date: currentDate,
							time: currentTime
						});
					}
				}
				$('#investigatorModal').modal('hide');
			});

			$('#investigatorModal #okInvestigatorDetails').on('click', function () {
				var selectedRows = investigatorStaffTable.getSelectedRows();
				if (selectedRows.length > 0) {
					var selectedData = selectedRows[0].getData();
					var targetRowId = $('#investigatorModal').data('row-id');
					if (targetRowId !== undefined) {
						var fullName = (nullhandler(selectedData.USER_LAST_NAME) + ' ' + nullhandler(selectedData.USER_FIRST_NAME)).trim();
						var targetRow = otherInvestTable.getRow(targetRowId);
						const currentDate = getCurrentDate();
						const now = new Date();
						const currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
						if (targetRow) {
							targetRow.update({
								assignedTo: fullName,
								date: currentDate,
								time: currentTime
							});
						}
					}
					$('#investigatorModal').modal('hide');
				} else {
					message('CUW', 'Please select an investigator.', 0);
				}
			});

			$('#investigatorModal').on('hidden.bs.modal', function () {
				$('.modal-backdrop').remove();
				$('body').removeClass('modal-open');
			});


			function setFetchStandardCheckList(incident_seq, inst_num) {
				clearFunc2(standardCheckTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchStandardCheckList',
					dataType: "json",
					data: {incidentNo: incident_seq, instNum: inst_num},
					success: function (response) {
						console.log(response.length);
						//alert(response.length);
						for (var i = 0; i < response.length; i++) {

							var dt = nullhandler(response[i]['CHKLIST_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(standardCheckTbl, i, "date", dt);
							setValueForRowAndColumn(standardCheckTbl, i, "checkbox", response[i]['CB_COMPLETED']);
							setValueForRowAndColumn(standardCheckTbl, i, "description", response[i]['QUES_DESC']);
							setValueForRowAndColumn(standardCheckTbl, i, "completedBy", response[i]['COMPLETED_BY']);
							setValueForRowAndColumn(standardCheckTbl, i, "comments", response[i]['COMMENTS']);
							setValueForRowAndColumn(standardCheckTbl, i, "QUES_CODE", response[i]['QUES_CODE']);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			$('#ApproveddRadio').on('click', function () {
				$('#approval_info').val('A');
			});

			$('#DisapprovedRadio').on('click', function () {
				$('#approval_info').val('D');
			});


		
			
			// Helper to get caret position
			//$(document).ready(function() {
			  // Define your getCaretCoordinates, fetchSuggestions, and other functions here
			  // Make sure to include the previous code snippets, cleaned up and integrated.

			  // Helper to get caret position
			  function getCaretCoordinates(el, position) {
			  		    const div = document.createElement('div');
			  		    const style = getComputedStyle(el);
			  		    [...style].forEach(name => div.style[name] = style[name]);
			  		    div.style.position = 'absolute';
			  		    div.style.visibility = 'hidden';
			  		    div.style.whiteSpace = 'pre-wrap';
			  		    div.style.wordWrap = 'break-word';
			  		    div.textContent = el.value.substring(0, position);
			  		    const span = document.createElement('span');
			  		    span.textContent = el.value.substring(position) || '.';
			  		    div.appendChild(span);
			  		    document.body.appendChild(div);
			  		    const { offsetLeft: left, offsetTop: top } = span;
			  		    document.body.removeChild(div);
			  		    return { left, top };
			  		}

			  		// Suggestions array
			  		const suggestions = [
			  		    "offender","bed escape","declaration","escape","resolution",
			  		    "offender arrival","offender details and history","offender education",
			  		    "offender grievance","offender request for program","offender without bed",
			  		    "office","offer","omnet","crime","criminal"
			  		];

			  		let selectedIndex = -1; // for keyboard navigation

			  		const textarea = $('#approve_cmt');
			  		const counterSpan = $('#appcmt');

			  		// Create hint box
			  		let hintBox = $('#inline-hint');
			  		if (!hintBox.length) {
			  		    hintBox = $('<div id="inline-hint"></div>').css({
			  		        position: 'absolute',
			  		        background: '#fff',
			  		        color: '#333',
			  		        border: '1px solid #ccc',
			  		        'border-radius': '4px',
			  		        'font-size': '14px',
			  		        'font-family': 'inherit',
			  		        'z-index': 1000,
			  		        display: 'none'
			  		    });
			  		    $('body').append(hintBox); // append to body for proper positioning
			  		}

			  		// Function to update suggestions
			  		function updateSuggestions() {
			  		    const currentVal = textarea.val();
			  		    const words = currentVal.split(/\s+/);
			  		    const lastWord = words[words.length - 1].toLowerCase();

			  		    if (!lastWord) { hintBox.hide(); return; }

			  		    const matches = suggestions.filter(w => w.toLowerCase().startsWith(lastWord)).slice(0,3);
			  		    if (!matches.length) { hintBox.hide(); return; }

			  		    hintBox.html('');
			  		    matches.forEach((match, index) => {
			  		        const item = $('<div></div>').text(match).css({
			  		            padding: '2px 4px',
			  		            cursor: 'pointer',
			  		            background: index === selectedIndex ? '#e6f0ff' : '#fff'
			  		        });

			  		        item.on('mousedown', function(e){
			  		            e.preventDefault();
			  		            words.pop();
			  		            words.push(match);
			  		            textarea.val(words.join(' ') + ' ');
			  		            hintBox.hide();
			  		            counterSpan.text(textarea.val().length);
			  		            textarea.focus();
			  		            selectedIndex = -1;
			  		        });

			  		        hintBox.append(item);
			  		    });

			  		    const caretPos = getCaretCoordinates(textarea[0], textarea[0].selectionStart);
			  		    const offset = textarea.offset();
			  		    hintBox.css({
			  		        top: offset.top + caretPos.top + 20,
			  		        left: offset.left + caretPos.left,
			  		        display: 'block',
			  		        width: '200px'
			  		    });
			  		}

			  		// Input event
			  		textarea.on('input', function(){
			  		    const maxLength = 1000;
			  		    let currentText = $(this).val();
			  		    if(currentText.length > maxLength){
			  		        $(this).val(currentText.substring(0,maxLength));
			  		        message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
			  		    }
			  		    counterSpan.text($(this).val().length);
			  		    selectedIndex = -1;
			  		    updateSuggestions();
			  		});

			  		// Keyboard navigation
			  		textarea.on('keydown', function(e){
			  		    const items = hintBox.children();
			  		    if(!items.length) return;

			  		    if(e.key === "ArrowDown"){
			  		        e.preventDefault();
			  		        selectedIndex = (selectedIndex + 1) % items.length;
			  		        items.css('background','#fff');
			  		        $(items[selectedIndex]).css('background','#e6f0ff');
			  		    } else if(e.key === "ArrowUp"){
			  		        e.preventDefault();
			  		        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
			  		        items.css('background','#fff');
			  		        $(items[selectedIndex]).css('background','#e6f0ff');
			  		    } else if(e.key === "Enter" || e.key === "ArrowRight"){
			  		        if(selectedIndex >=0){
			  		            e.preventDefault();
			  		            const words = textarea.val().split(/\s+/);
			  		            words.pop();
			  		            words.push($(items[selectedIndex]).text());
			  		            textarea.val(words.join(' ') + ' ');
			  		            hintBox.hide();
			  		            counterSpan.text(textarea.val().length);
			  		            selectedIndex = -1;
			  		        }
			  		    }
			  		});

			  		// Hide suggestions if click outside
			  		$(document).on('click', function(e){
			  		    if(!$(e.target).closest('#approve_cmt,#inline-hint').length){
			  		        hintBox.hide();
			  		        selectedIndex = -1;
			  		    }
			  		});

			//});			
			
			function setApproval(incident_seq) {
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchApproval',
					dataType: "json",
					data: {incidentNo: incident_seq},
					success: function (response) {
						console.log(response.length);

						setNames(nullhandler(response[0]['USER_ID']), 'approve_name');
						$('#approve_id').val(response[0]['USER_ID']);
						$('#approve_title').val(response[0]['TITLE_REVIEW']);
						$('#approve_cmt').val(response[0]['INCIDENT_COMNT_REVIEWR']);
						$('#appcmt').text($('#approve_cmt').val().length);
						$('#approval_info').val('');
						$('.nav-assign').addClass('nav-disable');
						$('#approve_declared').val('N');

						if (nullhandler(response[0]['SHIFT_COMMANDER_APR_FLAG']) == 'A') {
							$('#ApproveddRadio').trigger('click');
							$('.nav-assign').removeClass('nav-disable');
							$('#approve_declared').val('Y');
						} else if (nullhandler(response[0]['SHIFT_COMMANDER_APR_FLAG']) == 'D') {
							$('#DisapprovedRadio').trigger('click');
							$('#approve_declared').val('Y');
						}

						$('#approval_info').val(nullhandler(response[0]['SHIFT_COMMANDER_APR_FLAG']));

						var dt = nullhandler(response[0]['INCIDENT_DATE_REVIEW']);

						if (dt != '' && dt != null) {
							dt = dt.split("T")[0];
							dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
						}

						$('#approve_dt').val(dt);

						if (nullhandler(response[0]['INCIDENT_FOLOW_REQ_FLG']) == 'Y') {
							$('#approve_check').prop('checked', true);
						} else {
							$('#approve_check').prop('checked', false);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}
			// 🔹 Load injured persons for incident
			// 🔹 Fetch Injured Person Records
			function setInjuredPerson(incident_seq) {
				clearFunc(injuredTable);
				if (!incident_seq) return;

				$.ajax({
					method: "POST",
					url: contextPath + 'fetchInjuredPersons',
					dataType: "json",
					data: { incidentNo: incident_seq },
					success: function (response) {
						if (!response || response.length === 0) {
							console.log("No injured person records found.");
							return;
						}

						response.sort((a, b) => (parseInt(b.INCD_VCTM_SEQ_NO) || 0) - (parseInt(a.INCD_VCTM_SEQ_NO) || 0));
						const tableRows = injuredTable.getRows();

						for (let i = 0; i < response.length; i++) {
							const item = response[i];

							const lname = nullhandler(item['INCD_VCTM_LST_NM']);
							const fname = nullhandler(item['INCD_VCTM_FST_NM']);
							const mname = nullhandler(item['INCD_VCTM_MID_NM']);
							const sname = nullhandler(item['INCD_VCTM_SFX_NM']);

							const fullName = commaName(`${lname} ${fname} ${mname} ${sname}`.trim());

							let locationVal = nullhandler(item['INCD_VCTM_HSP_LOCN']) || "";
							if (locationVal.length > 100) locationVal = locationVal.substring(0, 100);

							let natureLabel = "";
							if (fullName !== '' && nullhandler(item['NATURE_OF_INJURY']) !== '') {
								try {
									const dynamic_Array1 = JSON.parse($('#nature_inj_val').val() || "[]");
									const selectedOption1 = dynamic_Array1.find(opt => opt.value === item['NATURE_OF_INJURY']);
									natureLabel = selectedOption1 ? selectedOption1.label : "";
								} catch (e) {
									console.warn("Nature of injury JSON parse failed", e);
								}
							}

							const rowData = {
								upd: "N",
								INCD_VCTM_SEQ_NO: item['INCD_VCTM_SEQ_NO'],
								checkbox: item['INCD_VCTM_DEL_FLG'],
								injuredPerson: fullName,
								INCD_VCTM_LST_NM: lname,
								INCD_VCTM_FST_NM: fname,
								INCD_VCTM_MID_NM: mname,
								INCD_VCTM_SFX_NM: sname,
								checkbox1: item['INCD_VCTM_HSP_FLG'],
								checkbox2: item['MED_TREATMENT_PROVIDED'],
								location: locationVal,
								natureInjury: natureLabel,
								injuredDesc: item['INCD_VCTM_INJR_DESC'],
								editable: true // ✅ all rows editable
							};

							if (i < tableRows.length) tableRows[i].update(rowData);
							else injuredTable.addData([rowData], true);
						}
					},
					error: function (error) {
						console.error("Error fetching injured persons:", error);
						console.log(error.responseText);
					}
				});
			}

			$('#delInj').on('click', function () {
			    const rowsToDelete = injuredTable.getRows().filter(row => {
			        const data = row.getData();
			        return (data.checkbox === 'Y' || data.checkbox === true) && data.INCD_VCTM_SEQ_NO;
			    });

			    if (rowsToDelete.length === 0) {
			        message('CUW', 'Please select a record to delete.', 0);
			        return;
			    }

			    const incidentNo = $('#incidentNo').val();
			    if (!incidentNo) {
			        message('CUW', 'Incident number is missing.', 0);
			        return;
			    }

			    const payload = rowsToDelete.map(row => {
			        return {
			            VICTIM_SEQ_NUM: row.getData().INCD_VCTM_SEQ_NO,
			            INCIDENT_SEQ_NUM: incidentNo,
			            inst_num: $('#institution').val(),
			            USER: localStorage.getItem('userId'),
			            DATE_TIME: getCurrentDateTime(),
			            delete_flag: 'Y'
			        };
			    });

			    if (payload.length === 0) {
			        message('CUW', 'No valid records to delete.', 0);
			        return;
			    }

			    var combinedData = { tab0: payload };

			    $.ajax({
			        url: contextPath + "delInjured",
			        type: 'POST',
			        contentType: 'application/json',
			        data: JSON.stringify(combinedData),
			        success: function (response) {
			            console.log("Server deletion response:", response);
			            message('CUS', 'Deleted Successfully', 0);
			            rowsToDelete.forEach(function(row) {
			                row.delete();
			            });
			            setTimeout(function() {
			                $('.modal-backdrop').remove();
			                $('body').removeClass('modal-open');
			            }, 500);
			        },
			        error: function (jqXHR, textStatus, errorThrown) {
			            console.error("Deletion failed:", textStatus, errorThrown);
			            message('CER', 'An error occurred during deletion.', 0);
			        }
			    });
			});// 🔹 Add New Row (Editable)
			$('#newInj').off('click').on('click', function () {
				const newRowData = {
					id: Date.now(),
					upd: "Y",
					INCD_VCTM_SEQ_NO: "",
					checkbox: "",
					injuredPerson: "",
					INCD_VCTM_LST_NM: "",
					INCD_VCTM_FST_NM: "",
					INCD_VCTM_MID_NM: "",
					INCD_VCTM_SFX_NM: "",
					checkbox1: "",
					checkbox2: "",
					location: "",
					natureInjury: "",
					injuredDesc: "",
					editable: true // ✅ editable
				};
				injuredTable.addData([newRowData], true);
			});

			// 🔹 Save Injured Persons
			$('#saveInj').off('click').on('click', function () {
				const incidentNo = $('#incidentNo').val();
				if (!incidentNo) {
					message('CUW', 'Incident number is missing.', 0);
					return;
				}

				const allRows = injuredTable.getRows().map(row => row.getData());
				const payload = [];

				allRows.forEach(data => {
					if (!data.injuredPerson && !data.location && !data.natureInjury && !data.injuredDesc) return;

					let lastName = data.INCD_VCTM_LST_NM || "";
					let firstName = data.INCD_VCTM_FST_NM || "";
					let midName = data.INCD_VCTM_MID_NM || "";
					let suffix = data.INCD_VCTM_SFX_NM || "";

					// Split combined name if needed
					if ((!lastName && !firstName) && data.injuredPerson) {
						const parts = data.injuredPerson.trim().split(/\s+/);
						lastName = parts[0] || "";
						firstName = parts[1] || "";
						midName = parts[2] || "";
						suffix = parts[3] || "";
					}

					payload.push({
						INCIDENT_SEQ_NUM: incidentNo,
						INCD_VCTM_SEQ_NO: data.INCD_VCTM_SEQ_NO || "",
						INCD_VCTM_LST_NM: lastName,
						INCD_VCTM_FST_NM: firstName,
						INCD_VCTM_MID_NM: midName,
						INCD_VCTM_SFX_NM: suffix,
						INCD_VCTM_HSP_LOCN: data.location || "",
						NATURE_OF_INJURY: data.natureInjury || "",
						INCD_VCTM_INJR_DESC: data.injuredDesc || "",
						INCD_VCTM_HSP_FLG: data.checkbox1 || "",
						MED_TREATMENT_PROVIDED: data.checkbox2 || "",
						INCD_VCTM_DEL_FLG: data.checkbox || "N",
						UPD: data.upd || "N"
					});
				});

				if (payload.length === 0) {
					message('CUW', 'No valid records to save.', 0);
					return;
				}

				console.log("Payload for Save:", payload);

				$.ajax({
					url: contextPath + "saveInjuredPersons",
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify(payload),
					success: function (response) {
						console.log("Save response:", response);
						message('CUS', 'Saved Successfully', 0);
						setInjuredPerson(incidentNo); // refresh table after save
					},
					error: function (jqXHR, textStatus, errorThrown) {
						console.error("Save failed:", textStatus, errorThrown);
						console.error("Server response:", jqXHR.responseText);
						message('CER', 'An error occurred while saving injured persons.', 0);
					}
				});
			});

			// 🔹 Location Field Character Limit
			injuredTable.on("cellEditing", function (cell) {
				if (cell.getField() !== "location") return;

				setTimeout(function () {
					var input = cell.getElement().querySelector('input, textarea');
					if (!input) return;

					input.setAttribute('maxlength', '100');

					input.addEventListener('input', function () {
						if (this.value.length > 100) {
							this.value = this.value.slice(0, 100);
							message('CUW', 'Location limited to 100 characters', 0);
						}
					});

					input.addEventListener('paste', function (e) {
						e.preventDefault();
						var paste = (e.clipboardData || window.clipboardData).getData('text') || '';
						var current = this.value || '';
						var spaceLeft = 100 - current.length;
						if (spaceLeft <= 0) return;
						this.value = current + paste.slice(0, spaceLeft);
						var ev = new Event('input', { bubbles: true });
						this.dispatchEvent(ev);
					});
				}, 5);
			});

			// 🔹 Allow Editing Only When Editable
			injuredTable.on("cellEditing", function (cell) {
				const rowData = cell.getRow().getData();
				if (!rowData.editable) cell.cancelEdit();
			});

			// ✅ Preserve existing value in injuredPerson dropdown if not changed
			injuredTable.on("cellEdited", function (cell) {
				if (cell.getField() === "injuredPerson") {
					const newValue = cell.getValue();
					const oldValue = cell.getOldValue();

					// If user opened dropdown but didn’t select anything
					if (newValue === "" || newValue == null) {
						cell.setValue(oldValue); // restore previous value
						return;
					}

					// Update hidden name parts when changed
					const parts = newValue.trim().split(/\s+/);
					cell.getRow().update({
						INCD_VCTM_LST_NM: parts[0] || "",
						INCD_VCTM_FST_NM: parts[1] || "",
						INCD_VCTM_MID_NM: parts[2] || "",
						INCD_VCTM_SFX_NM: parts[3] || ""
					});
				}
			});
			

			function setEvidence(incident_seq) {
				clearFunc(evidenceTable);
				if (!incident_seq) return;

				$.ajax({
					method: "POST",
					url: contextPath + 'fetchEvidence',
					dataType: "json",
					data: { incidentNo: incident_seq },
					success: function (response) {
						let rows = [];

						// 🔹 If DB has records, fill them as editable
						if (response && response.length > 0) {
							rows = response.map((item) => {
								let evidenceLabel = "";
								if (item['EVIDENCE_CODE']) {
									try {
										const dynamic_Array1 = JSON.parse($('#evidence_typ_val').val() || "[]");
										const selectedOption1 = dynamic_Array1.find(opt => opt.value === item['EVIDENCE_CODE']);
										evidenceLabel = selectedOption1 ? selectedOption1.label : "";
									} catch (e) {
										console.warn("Evidence type JSON parse failed", e);
									}
								}

								let dt = nullhandler(item['INCD_EVDN_COLT_DT']);
								if (dt) {
									dt = dt.split("T")[0];
									dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
								}

								const cname = commaName(
									nullhandler(item['INCD_EVDN_DSCV_LST_NM']) + " " +
									nullhandler(item['INCD_EVDN_DSCV_FST_NM']) + " " +
									nullhandler(item['INCD_EVDN_DSCV_MID_NM']) + " " +
									nullhandler(item['INCD_EVDN_DSCV_SFX_NM'])
								);

								const sname = commaName(
									nullhandler(item['INCD_EVDN_SECR_LST_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_FST_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_MID_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_SFX_NM'])
								);

								return {
									upd: "N",
									INCD_EVDN_SEQ_NO: nullhandler(item['INCD_EVDN_SEQ_NO']),
									INCD_EVDN_TP: nullhandler(item['INCD_EVDN_TP']),
									evidenceType: evidenceLabel,
									dateCollected: dt,
									collectedName: cname,
									securedName: sname,
									evidenceDesc: nullhandler(item['INCD_EVDN_TP']),
									EveComments: nullhandler(item['EVE_COMMENTS']),
									editable: true   // ✅ DB records are editable now
								};
							});
						}

						// 🔹 Always show fixed size table (e.g. 10 rows total)
						const tableSize = 10;
						while (rows.length < tableSize) {
							rows.push({
								upd: "N",
								INCD_EVDN_SEQ_NO: "",
								INCD_EVDN_TP: "",
								evidenceType: "",
								dateCollected: "",
								collectedName: "",
								securedName: "",
								evidenceDesc: "",
								EveComments: "",
								editable: false   // 🔒 empty rows locked
							});
						}

						evidenceTable.setData(rows);
					},
					error: function (error) {
						console.error("Error fetching evidence:", error);
						console.log(error.responseText);
					}
				});
			}

			// 🔹 Add new evidence row (only one editable)
			$('#newEve').off('click').on('click', function () {
				evidenceTable.getRows().forEach(row => row.update({ editable: false }));

				const newRowData = {
					id: Date.now(),
					upd: "Y",
					INCD_EVDN_SEQ_NO: "",
					INCD_EVDN_TP: "",
					evidenceType: "",
					dateCollected: "",
					collectedName: "",
					securedName: "",
					evidenceDesc: "",
					EveComments: "",
					editable: true
				};

				evidenceTable.addData([newRowData], true);
			});

			// 🔹 Prevent editing for non-editable rows
			evidenceTable.on("cellEditing", function (cell) {
				const rowData = cell.getRow().getData();
				if (!rowData.editable) cell.cancelEdit();
			});

			// 🔹 Preserve dropdown value when user clicks but doesn’t select
			evidenceTable.on("cellEdited", function (cell) {
				if (cell.getField() === "evidenceType") {
					const newValue = cell.getValue();
					const oldValue = cell.getOldValue();
					if (newValue === "" || newValue === null || newValue === undefined) {
						cell.setValue(oldValue);
					}
				}
			});

			// 🔹 Enforce 40-char limit on collectedName & securedName with live message
			evidenceTable.on("cellEditing", function (cell) {
				const field = cell.getField();
				if (field !== "collectedName" && field !== "securedName") return;

				setTimeout(() => {
					const input = cell.getElement().querySelector('input');
					if (!input) return;

					input.setAttribute('maxlength', '16');

					input.addEventListener('input', function () {
						if (this.value.length > 16) {
							message('CUW', 'Excess characters must be trimmed to 16.', 0);
							this.value = this.value.slice(0, 40);
						}
					});

					input.addEventListener('paste', function (e) {
						e.preventDefault();
						let paste = (e.clipboardData || window.clipboardData).getData('text');
						let current = this.value || '';
						let spaceLeft = 16 - current.length;
						if (spaceLeft <= 0) return;
						this.value = current + paste.slice(0, spaceLeft);
						message('CUW', 'Excess characters must be trimmed to 16.', 0);
					});
				}, 5);
			});


			function setEvidenceByCell(cellNo) {
				clearFunc(evidenceTable);
				//if (!incident_seq) return;

				$.ajax({
					method: "POST",
					url: contextPath + 'getEviInfoByCell',
					dataType: "json",
					data: {cellNo: cellNo},
					success: function (response) {
						let rows = [];
						//alert(response.length);

						// 🔹 If DB has records, fill them as non-editable
						if (response && response.length > 0) {
							rows = response.map((item) => {
								let evidenceLabel = "";
								if (item['EVIDENCE_TP']) {
									try {
										const dynamic_Array1 = JSON.parse($('#evidence_typ_val').val() || "[]");
										const selectedOption1 = dynamic_Array1.find(opt => opt.value === item['EVIDENCE_TP']);
										evidenceLabel = selectedOption1 ? selectedOption1.label : "";
									} catch (e) {
										console.warn("Evidence type JSON parse failed", e);
									}
								}

								let dt = nullhandler(item['REPORT_DATE']);
								if (dt) {
									dt = dt.split("T")[0];
									dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
								}

								const cname = commaName(
									nullhandler(item['USER_LAST_NAME']) + " " +
									nullhandler(item['USER_FIRST_NAME']) + " " +
									nullhandler(item['USER_MID_NAME']) + " " +
									nullhandler(item['USER_SUFFIX_NAME'])
								);

								/*const sname = commaName(
									nullhandler(item['INCD_EVDN_SECR_LST_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_FST_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_MID_NM']) + " " +
									nullhandler(item['INCD_EVDN_SECR_SFX_NM'])
								);*/

								return {
									upd: "N",
									INCD_EVDN_SEQ_NO: '',
									INCD_EVDN_TP: '',
									evidenceType: evidenceLabel,
									dateCollected: dt,
									collectedName: cname,
									securedName: 'N/A',
									evidenceDesc: nullhandler(item['EVIDENCE_TYPE_DESC']),
									EveComments: nullhandler(item['EVIDENCE_TYPE_DESC']),
									editable: true   // 🔒 existing rows locked
								};
							});
						}

						// 🔹 Always show fixed size table (e.g. 10 rows total)
						const tableSize = 10;
						while (rows.length < tableSize) {
							rows.push({
								upd: "N",
								INCD_EVDN_SEQ_NO: "",
								INCD_EVDN_TP: "",
								evidenceType: "",
								dateCollected: "",
								collectedName: "",
								securedName: "",
								evidenceDesc: "",
								EveComments: "",
								editable: true   // 🔒 empty rows locked
							});
						}

						evidenceTable.setData(rows);
					},
					error: function (error) {
						console.error("Error fetching evidence:", error);
						console.log(error.responseText);
					}
				});
			}

			// 🔹 Add new evidence row (only one editable)
			$('#newEve').off('click').on('click', function () {
				// Lock all existing rows
				evidenceTable.getRows().forEach(row => row.update({editable: false}));

				const newRowData = {
					id: Date.now(),
					upd: "Y",
					INCD_EVDN_SEQ_NO: "",
					INCD_EVDN_TP: "",
					evidenceType: "",
					dateCollected: "",
					collectedName: "",
					securedName: "",
					evidenceDesc: "",
					EveComments: "",
					editable: true   // ✅ only this row editable
				};

				evidenceTable.addData([newRowData], true); // add at top
			});

			// 🔹 Prevent editing for non-editable rows
			evidenceTable.on("cellEditing", function (cell) {
				const rowData = cell.getRow().getData();
				if (!rowData.editable) {
					cell.cancelEdit();
				}
			});

			function setRefHistory(incident_seq) {
				clearFunc2(refHistoryTable);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchRefferalHistory',
					dataType: "json",
					data: {incidentNo: incident_seq},
					success: function (response) {
						console.log(response.length);
						for (var i = 0; i < response.length; i++) {

							var dt = nullhandler(response[i]['MODIFIED_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(refHistoryTable, i, "modifiedDate", dt);
							setValueForRowAndColumn(refHistoryTable, i, "referredUser", response[i]['OLD_REFERRED_USER_NM']);
							setValueForRowAndColumn(refHistoryTable, i, "modifiedBy", response[i]['MODIFIED_BY_NM']);
						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			function setAudit(incident_seq, inst_num, type_action) {
				clearFunc2(auditTable);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchAuditTrial',
					dataType: "json",
					data: {incidentNo: incident_seq, instNum: inst_num, typeAction: type_action},
					success: function (response) {
						console.log(response.length);
						//alert(response.length);
						for (var i = 0; i < response.length; i++) {
							auditTable.addRow({id: i});
						}

						for (var i = 0; i < response.length; i++) {

							var dt = nullhandler(response[i]['AT_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(auditTable, i, "auditDate", dt);
							setValueForRowAndColumn(auditTable, i, "auditTime", nullhandler(response[i]['AT_TIME']));
							setValueForRowAndColumn(auditTable, i, "auditTypeofAct", nullhandler(response[i]['AT_TYPE']));
							setValueForRowAndColumn(auditTable, i, "auditFName", nullhandler(response[i]['AT_USER_FNAME']));
							setValueForRowAndColumn(auditTable, i, "auditLName", nullhandler(response[i]['AT_USER_LNAME']));
							setValueForRowAndColumn(auditTable, i, "auditSName", nullhandler(response[i]['AT_USER_SNAME']));
							setValueForRowAndColumn(auditTable, i, "auditMName", nullhandler(response[i]['AT_USER_MNAME']));

						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			var ofcList = [];

			function setAsnMoreRev(incident_seq, inst_num) {

				if ($('#ref_id').val() != '') {
					var item = $('#ref_id').val();
					if (ofcList.indexOf(item) === -1) {  // -1 means not found
						ofcList.push(item);
					}
				}

				clearFunc2(asnMoreRevTbl);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchAsnMoreRevs',
					dataType: "json",
					data: {incidentNo: incident_seq, instNum: inst_num},
					success: function (response) {
						//alert(response.length);

						for (var i = 0; i < response.length; i++) {

							var dt = nullhandler(response[i]['REFR_ASSIGNED_DATE']);

							if (dt != '' && dt != null) {
								dt = dt.split("T")[0];
								dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
							}

							setValueForRowAndColumn(asnMoreRevTbl, i, "date", dt);
							setValueForRowAndColumn(asnMoreRevTbl, i, "time", nullhandler(response[i]['REFR_ASSIGNED_TIME']));
							setValueForRowAndColumn(asnMoreRevTbl, i, "lastname", nullhandler(response[i]['USER_LAST_NAME']));
							setValueForRowAndColumn(asnMoreRevTbl, i, "firstname", nullhandler(response[i]['USER_FIRST_NAME']));
							setValueForRowAndColumn(asnMoreRevTbl, i, "mi", nullhandler(response[i]['USER_MID_NAME']));
							setValueForRowAndColumn(asnMoreRevTbl, i, "suffix", nullhandler(response[i]['USER_SUFFIX_NAME']));
							setValueForRowAndColumn(asnMoreRevTbl, i, "refr_user_id", nullhandler(response[i]['REFR_USER_ID']));

							if (ofcList.indexOf(response[i]['REFR_USER_ID']) === -1) {  // -1 means not found
								ofcList.push(response[i]['REFR_USER_ID']);
							}

							setValueForRowAndColumn(asnMoreRevTbl, i, "checkbox", nullhandler(response[i]['NOTIFY_FLAG']));

						}
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}

			var officerInfoModalTable = new Tabulator("#officerInfoModal-table", {
				layout: "fitColumns",
				height: '200px',
				selectable: 1,
				columns: [
					{title: "User ID", field: "USER_ID", visible: false},
					{title: "Last Name", field: "USER_LAST_NAME"},
					{title: "First Name", field: "USER_FIRST_NAME"},
					{title: "MI", field: "USER_MID_NAME", width: 80},
					{title: "Suffix", field: "USER_SUFFIX_NAME", width: 100},
				]
			});

			$('#officeInformation').on('shown.bs.modal', function () {
				officerInfoModalTable.clearData();
				$('#officeInformation #Find').val('');
				officerInfoModalTable.setData(contextPath + 'getIncidentStaff?srchkey=');
				setTimeout(function () {$('#officeInformation #Find').focus();}, 100);
			});

			$('#officeInformation .modal-body button').on('click', function () {
				var searchTerm = $('#officeInformation #Find').val().trim().toLowerCase();
				officerInfoModalTable.setData(contextPath + 'getIncidentStaff?srchkey=' + searchTerm);
			});

			$('#officeInformation #Find').on('keydown', function (e) {
				if (e.key === 'Enter' || e.keyCode === 13) {
					e.preventDefault();
					$('#officeInformation .modal-body button').trigger('click');
				}
			});

			function getCurrentTime24F() {
				const now = new Date();
				const hours = now.getHours().toString().padStart(2, '0');
				const minutes = now.getMinutes().toString().padStart(2, '0');
				return `${hours}:${minutes}`;
			}

			officerInfoModalTable.on("rowClick", function (e, row) {

				if ($('#ref_id').val() != '') {
					var item = $('#ref_id').val();
					if (ofcList.indexOf(item) === -1) {  // -1 means not found
						ofcList.push(item);
					}
				}

				var curr_fld = $('#asn_curr_id').val();
				$('#asn_curr_id').val('');
				document.getElementById("closeAsnOfc").click();

				if (ofcList.indexOf(row.getData().USER_ID) === -1) {  // -1 means not found
					ofcList.push(row.getData().USER_ID);

					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "lastname", nullhandler(row.getData().USER_LAST_NAME));
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "firstname", nullhandler(row.getData().USER_FIRST_NAME));
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "mi", nullhandler(row.getData().USER_MID_NAME));
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "suffix", nullhandler(row.getData().USER_SUFFIX_NAME));
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "refr_user_id", nullhandler(row.getData().USER_ID));
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "date", getCurrentDt());
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "time", getCurrentTime24F());
					setValueForRowAndColumn(asnMoreRevTbl, curr_fld, "upd", "Y");
				} else {
					message('CUW', "You cannot refer same officer more than one time.", 0);
				}

			});

			/*function setAsnMoreRev(incident_seq, inst_num) {
				asnMoreRevTbl.setData(assignMoreReviewers);
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchAsnMoreRevs',
					dataType: "json",
					data: { incidentNo: incident_seq, instNum: inst_num },
					success: function (response) {
						if (response && response.length > 0) {
							for (var i = 0; i < response.length; i++) {
								if (i >= assignMoreReviewers.length) break;
								var dt = nullhandler(response[i]['REFR_ASSIGNED_DATE']);
								if (dt) {
									dt = dt.split("T")[0];
									dt = dt.split('-')[1] + '/' + dt.split('-')[2] + '/' + dt.split('-')[0];
								}
								var rowToUpdate = asnMoreRevTbl.getRows()[i];
								if (rowToUpdate) {
									rowToUpdate.update({
										date: dt,
										time: nullhandler(response[i]['REFR_ASSIGNED_TIME']),
										lastname: nullhandler(response[i]['USER_LAST_NAME']),
										firstname: nullhandler(response[i]['USER_FIRST_NAME']),
										mi: nullhandler(response[i]['USER_MID_NAME']),
										suffix: nullhandler(response[i]['USER_SUFFIX_NAME']),
										checkbox: nullhandler(response[i]['NOTIFY_FLAG']) === 'Y'
									});
								}
							}
						}
					},
					error: function (error) {
						console.error('Error fetching "Assign More Reviewers" data:', error);
						console.log(error.responseText);
					}
				});
			}*/
			/*$('.hospital').on('change', function() {
				alert(0);
				var idx = $('.hospital').index();
				alert(idx);
				if(!$('.med').eq(idx).prop('checked')) {
					$('.med').eq(idx).prop('checked',true);
					$('.med').eq(idx).trigger('change');
				}
			});*/

			function clearFunc(tbl) {
				var idx = 1;
				tbl.getRows().forEach(function (row) {
					// Iterate through each field in the row
					Object.keys(row.getData()).forEach(function (field) {
						// Check if the field is not in the fieldsToKeep array
						if (field != 'id') {
							// Set the cell value to an empty string
							if (field == 'INDV_DEL_FLG') {
								row.update({[field]: "N"}); // or use null if you prefer
							} else {
								row.update({[field]: ""}); // or use null if you prefer	
							}

						} else {
							row.update({[field]: idx}); // or use null if you prefer
							idx++;
						}
					});
				});
				//addClassToRows(tbl, "mydisabled");
			}

			function clearFunc2(tbl) {
				var idx = 0;
				tbl.getRows().forEach(function (row) {
					// Iterate through each field in the row
					Object.keys(row.getData()).forEach(function (field) {
						// Check if the field is not in the fieldsToKeep array
						if (field != 'id') {
							// Set the cell value to an empty string
							row.update({[field]: ""});

						} else {
							row.update({[field]: idx}); // or use null if you prefer
							idx++;
						}
					});
				});
				//addClassToRows(tbl, "mydisabled");
			}



			/*$('#entered_inc_comp').on('change', function () {
				if ($(this).prop('checked')) {
					$('#assignMore').removeAttr('disabled');
				} else {
					$('#assignMore').attr('disabled', true);
				}
			});*/

			var isSaving = false;

			$('#save').on('click', function () {

						if (isSaving) {
							return;
						}

						if ($('#inciDt').val() == '') {
							message('CUW', 'Need to enter date', 0);
							return;
						}

						if ($('#inciTm').val() == '') {
							message('CUW', 'Need to enter time', 0);
							return;
						}

						if ($('#incident_tp').val() == '') {
							message('CUW', 'Need to enter incident type', 0);
							return;
						}

						if ($('#location').val() == '') {
							message('CUW', 'Need to enter location of occurrence', 0);
							return;
						}

						isSaving = true;
						$(this).prop('disabled', true);

						if ($('#incidentNo').val().trim() != '') {
							console.log('Updated Save');
							console.log($('#incidentNo').val());
							preChecks();
						} else {
							$.ajax({
								method: "POST",
								url: contextPath + 'genSeq',
								dataType: "json",
								success: function (response) {
									$('#incidentNo').val(response[0]['AUTOSEQ']);
									console.log('New Save');
									preChecks();
								},
								error: function (error) {
									console.error('Error:', error);
									console.log(error.responseText);
									
									isSaving = false;
									$('#save').prop('disabled', false);
								}
							});
						}

					});


			$('#add').on('click', function (e) {
				e.preventDefault();
				clearAllFieldsAndTables();
			});

			$('#clear').on('click', function (e) {
				e.preventDefault();
				clearAllFieldsAndTables();
			});


			function clearTabulatorValues(table) {
				if (!table) return;
				const rows = table.getRows();
				if (rows.length === 0) return;
				const fieldsToClear = table.getColumnDefinitions()
					.map(col => col.field)
					.filter(field => field && field !== 'id');
				const emptyRowObject = {};
				fieldsToClear.forEach(field => {
					if (field.toLowerCase().includes('del_flg') || field.toLowerCase().includes('check_box') || field.toLowerCase().includes('cb_select')) {
						emptyRowObject[field] = 'N';
					} else {
						emptyRowObject[field] = '';
					}
				});
				rows.forEach(row => {
					row.update(emptyRowObject);
				});
			}

			function refreshStandardChecklist() {
				var institution = $('#institution').val();
				if (!institution || typeof standardCheckTbl === 'undefined') {
					return;
				}
				$.ajax({
					method: "POST",
					url: contextPath + 'fetchStandardCheckList',
					dataType: "json",
					data: {incidentNo: '', instNum: institution},
					success: function (data) {
						const cleanedData = data.map(function (row) {
							let newRow = {
								QUES_CODE: row.QUES_CODE,
								description: row.QUES_DESC
							};
							newRow.checkbox = 'N';
							newRow.date = '';
							newRow.completedBy = '';
							newRow.completedFullName = '';
							newRow.comments = '';
							newRow.upd = 'N';
							return newRow;
						});
						standardCheckTbl.setData(cleanedData);
					},
					error: function (error) {
						console.error("Failed to refresh standard checklist:", error);
						standardCheckTbl.clearData();
					}
				});
			}

			function clearAllFieldsAndTables() {
			    const instVal = $('#institution_val').val();
			    const instId = $('#institution').val();
			    const institution = $('#institution').val();
			    $('#js-page-content').find('input[type="text"], input[type="hidden"], textarea, select')
			        .not('#institution_val, #institution, .auditCheck, #typ_val, #title_val, #race_val, #category_val, #nature_inj_val, #evidence_typ_val')
			        .val('');
			    $('#js-page-content').find('input[type="checkbox"], input[type="radio"]').not('.auditCheck').prop('checked', false);
			    $('#institution_val').val(instVal);
			    $('#institution').val(instId);
			    $('#fDtPop').val(getDateOneMonthAgo());
			    $('#tDtPop').val(getCurrentDate());
			    $('.charCount span, #injCount, #eviCount, #invCount, #reasonCount, #enterdcmt, #doccmts, #refcmts, #followout_cmt, #followcmt, #completecom, #appcmt').text('0');
			    clearTabulatorValues(supplimentTbl);
			    clearTabulatorValues(dnumTbl);
			    clearTabulatorValues(individualsInvolvedTbl);
			    $('.hsdt').val('');
			    if (typeof injuredTable !== 'undefined') clearTabulatorValues(injuredTable);
			    if (typeof evidenceTable !== 'undefined') clearTabulatorValues(evidenceTable);
			    if (typeof refHistoryTable !== 'undefined') clearTabulatorValues(refHistoryTable);
			    if (typeof assignLeadTable !== 'undefined') clearTabulatorValues(assignLeadTable);
			    if (typeof otherInvestTable !== 'undefined') clearTabulatorValues(otherInvestTable);
			    if (typeof asnMoreRevTbl !== 'undefined') clearTabulatorValues(asnMoreRevTbl);
			    if (typeof auditTable !== 'undefined') clearTabulatorValues(auditTable);
			    if (typeof popUpTable !== 'undefined') clearTabulatorValues(popUpTable);
			    if (typeof cellTable !== 'undefined') clearTabulatorValues(cellTable);
			    if (typeof genInfoTable !== 'undefined') {
			        genInfoTable.setData("fetchIncidentGenInfo?incidentNo=&instNum=" + institution);
			    }
			    if (typeof tblTypForce !== 'undefined') {
			        tblTypForce.setData("fetchTypForce?incidentNo=&instNum=" + institution + "&indSeq=");
			    }
			    if (typeof tblTypRestraint !== 'undefined') {
			        tblTypRestraint.setData("fetchTypRestraint?incidentNo=&instNum=" + institution + "&indSeq=");
			    }
			    if (typeof tblActionTaken !== 'undefined') {
			        tblActionTaken.setData("fetchActionTaken?incidentNo=&instNum=" + institution + "&indSeq=");
			    }
			    if (typeof groupSuppTable !== 'undefined') {
			        groupSuppTable.setData(tabledatagroupSupplementary);
			    }
			    refreshStandardChecklist();
			    if (typeof popUpTable !== 'undefined') $('#srchPop').trigger('click');
			    if (typeof cellTable !== 'undefined') $('#cellSearch').trigger('click');
			    $('.ref_btn').attr('disabled', true);
			    $('.nav-assign').addClass('nav-disable');
			    $('#gen_tab').tab('show');
			}

			// Helper to safely clear multiple tabulators
			function clearTabulatorValuesSafe(tables) {
				tables.forEach(tbl => {
					if (typeof tbl !== 'undefined' && tbl && typeof tbl.clearData === 'function') {
						tbl.clearData();
					}
				});
			}

			// Helper to safely clear title fields
			function clearTitleFields(selectors) {
				selectors.forEach(sel => {
					const el = $(sel);
					if (!el.length) return;

					// Handle Select2 or hidden field
					if (el.hasClass('select2-hidden-accessible')) {
						el.val(null).trigger('change'); // reset properly
					} else if (el.is('input, textarea')) {
						el.val('');
					} else {
						el.text('');
					}

					// Also remove any cached jQuery data for safe reloading
					el.removeData();
				});
			}


			// Function to count rows with values in a specific field
			function countRowsWithValues(tbl, fieldName) {
				// Get all data from the table
				var allData = tbl.getData();
				// Filter the data to find rows where the specified field has a value
				var filteredData = allData.filter(function (row) {
					return row[fieldName] !== undefined && row[fieldName] !== null && row[fieldName] !== "";
				});
				// Return the count of rows with values in the specified field
				return filteredData.length;
			}

			function preChecks() {

				var indCount = countRowsWithValues(individualsInvolvedTbl, 'LI_INDIVIDUAL_NUM');

				if ($('#approve_declared').val() == 'Y') {

					$('#confirm_btn').text('Ok');
					$('#cancel_btn').text('Cancel');
					$('#confirm_btn').attr('data-rule', '');
					$('#cancel_btn').attr('data-rule', '');
					$('.msg_btn').hide();
					$('.normal_alert').show();
					saveArea();

				} else {

					if ($('#approve_given').val() == 'Y') {

						$('#confirm_btn').text('Yes');
						$('#cancel_btn').text('No');
						$('.msg_btn').hide();
						$('.confirm_alert').show();

						if (!$('#defaultInline1').prop('checked')) {

							$('#confirm_btn').attr('data-rule', 'prea');
							$('#cancel_btn').attr('data-rule', 'prea');
							message('alert', 'is this a PREA Incident?', null);

						} else {

							if (indCount == 0) {
								$('#confirm_btn').text('Ok');
								$('#cancel_btn').text('Cancel');
								$('#confirm_btn').attr('data-rule', '');
								$('#cancel_btn').attr('data-rule', '');
								$('.msg_btn').hide();
								$('.normal_alert').show();

								setTimeout(function () {
									$('#ok_info').val('move::ind_tab');
									message('CUW', 'This incident is a PREA Incident, Please enter the Individuals Involved in this Incident.', 0);
								}, 1000);
							} else if ($('#sexAllegation').val() == '') {

								$('#confirm_btn').text('Ok');
								$('#cancel_btn').text('Cancel');
								$('#confirm_btn').attr('data-rule', '');
								$('#cancel_btn').attr('data-rule', '');
								$('.msg_btn').hide();
								$('.normal_alert').show();

								setTimeout(function () {
									$('#ok_info').val('move::sup_tab');
									message('CUW', 'This Incident is marked as PREA incident, Please select Sexual Allegation Type.', 0);
								}, 1000);

							} else if ($('#inv_off').val() == '') {

								$('#confirm_btn').text('Ok');
								$('#cancel_btn').text('Cancel');
								$('#confirm_btn').attr('data-rule', '');
								$('#cancel_btn').attr('data-rule', '');
								$('.msg_btn').hide();
								$('.normal_alert').show();

								setTimeout(function () {
									$('.nav-assign').removeClass('nav-disable');
									$('#ok_info').val('move::asn_tab');
									message('CUW', 'This incident is marked as PREA Incident, Please assign the Lead Investigator.', 0);
								}, 1000);

							} else {
								$('#confirm_btn').attr('data-rule', 'stg');
								$('#cancel_btn').attr('data-rule', 'stg');
								message('alert', 'is this a STG related incident?', null);
							}

						}

					} else {

						$('#confirm_btn').text('Ok');
						$('#cancel_btn').text('Cancel');
						$('#confirm_btn').attr('data-rule', '');
						$('#cancel_btn').attr('data-rule', '');
						$('.msg_btn').hide();
						$('.normal_alert').show();
						saveArea();

					}
				}
			}

			$('#confirm_btn').on('click', function () {

				var indCount = countRowsWithValues(individualsInvolvedTbl, 'LI_INDIVIDUAL_NUM');

				if ($(this).attr('data-rule') == 'prea') {
					$('#defaultInline1').prop('checked', true);
					$('#defaultInline2').prop('checked', true);

					if (indCount == 0) {
						$('#confirm_btn').text('Ok');
						$('#cancel_btn').text('Cancel');
						$('#confirm_btn').attr('data-rule', '');
						$('#cancel_btn').attr('data-rule', '');
						$('.msg_btn').hide();
						$('.normal_alert').show();

						setTimeout(function () {
							$('#ok_info').val('move::ind_tab');
							message('CUW', 'This incident is a PREA Incident, Please enter the Individuals Involved in this Incident.', 0);
						}, 1000);
					} else if ($('#sexAllegation').val() == '') {

						$('#confirm_btn').text('Ok');
						$('#cancel_btn').text('Cancel');
						$('#confirm_btn').attr('data-rule', '');
						$('#cancel_btn').attr('data-rule', '');
						$('.msg_btn').hide();
						$('.normal_alert').show();

						setTimeout(function () {
							$('#ok_info').val('move::sup_tab');
							message('CUW', 'This Incident is marked as PREA incident, Please select Sexual Allegation Type.', 0);
						}, 1000);

					} else if ($('#inv_off').val() == '') {

						$('#confirm_btn').text('Ok');
						$('#cancel_btn').text('Cancel');
						$('#confirm_btn').attr('data-rule', '');
						$('#cancel_btn').attr('data-rule', '');
						$('.msg_btn').hide();
						$('.normal_alert').show();

						setTimeout(function () {
							$('.nav-assign').removeClass('nav-disable');
							$('#ok_info').val('move::asn_tab');
							message('CUW', 'This incident is marked as PREA Incident, Please assign the Lead Investigator.', 0);
						}, 1000);

					} else {

						$('#confirm_btn').attr('data-rule', 'stg');
						$('#cancel_btn').attr('data-rule', 'stg');
						$('#confirm_btn').text('Yes');
						$('#cancel_btn').text('No');
						$('.msg_btn').hide();
						$('.confirm_alert').show();
						setTimeout(function () {
							message('alert', 'is this a STG related incident?', null);
						}, 1000);

					}

				} else if ($(this).attr('data-rule') == 'stg') {

					$('#confirm_btn').text('Ok');
					$('#cancel_btn').text('Cancel');
					$('#confirm_btn').attr('data-rule', '');
					$('#cancel_btn').attr('data-rule', '');
					$('.msg_btn').hide();
					$('.normal_alert').show();

					if (!$('#defaultInlined').prop('checked')) {
						setTimeout(function () {
							message('CUW', 'Please check the STG check box to indicate that this incident is STG related.', 0);
						}, 1000);
					} else {
						saveArea();
					}

				}
			});

			$('#cancel_btn').on('click', function () {

				var indCount = countRowsWithValues(individualsInvolvedTbl, 'LI_INDIVIDUAL_NUM');

				if ($(this).attr('data-rule') == 'prea') {
					$('#confirm_btn').attr('data-rule', 'stg');
					$('#cancel_btn').attr('data-rule', 'stg');
					$('#confirm_btn').text('Yes');
					$('#cancel_btn').text('No');
					$('.msg_btn').hide();
					$('.confirm_alert').show();
					setTimeout(function () {
						message('alert', 'is this a STG related incident?', null);
					}, 1000);
				} else if ($(this).attr('data-rule') == 'stg') {

					$('#confirm_btn').text('Ok');
					$('#cancel_btn').text('Cancel');
					$('#confirm_btn').attr('data-rule', '');
					$('#cancel_btn').attr('data-rule', '');
					$('.msg_btn').hide();
					$('.normal_alert').show();

					if ($('#defaultInlined').prop('checked')) {
						setTimeout(function () {
							message('CUW', 'Please uncheck the STG flag before approving the incident.', 0);
						}, 1000);
					} else {
						saveArea();
					}

				}
			});

			$('#defaultInline1').on('change', function () {
				if ($(this).prop('checked')) {
					$('#defaultInline2').prop('checked', true);
				} else {
					$('#defaultInline2').prop('checked', false);
				}
			});
			
			function getCurrUserTitle(userid) {
				$.ajax({
					method: "POST",
					url: contextPath + 'getNames',
					dataType: "json",
					data: {
						userid: userid
					},
					success: function (response) {
						$('#myTitle').val(response[0]['TITLE']);
					},
					error: function (error) {
						console.error('Error:', error);
						console.log(error.responseText);
					}
				});
			}
			
			getCurrUserTitle(userId);

			function saveArea() {
						//message('CUW', 'Need to enter ID', 0);
						console.log("Here xyz IncidentNo : " + $('#incidentNo').val());

						dataToShow0 = [];
						dataToShow4 = [];
						var dataToShowAssignInvestigator = [];
						var dataToShowOtherInvestigators = [];

						var dataToAsnOfc = [];

						var incidentData = {
							INCIDENT_SEQ_NUM: $('#incidentNo').val(),
							INST_NUM: $('#institution').val(),
							REFERRED_TO_NUM: '',
							USER_ID: userId,
							USER_ID_REPORTED_BY: $('#doc_id').val(),
							USER_ID_SHIFT_COMMANDER: '',
							USER_ID_ENTERED_BY: $('#entered_id').val() != '' ? $('#entered_id').val() : userId,
							COUNT_LOC_CODE: $('#location').val(),
							INCIDENT_DATE: formatDateWithCurrentTime($('#inciDt').val()),
							INCIDENT_TIME: $('#inciTm').val(),
							INCIDENT_DESC: $('#inciDesc').val(),
							INCIDENT_OUTCOME: $('#follow_outcome_cmt').val(),
							INCIDENT_FOLOW_REQ_FLG: '',
							INCIDENT_COMNT: $('#follow_cmt').val(),
							INCIDENT_TP: $('#incident_tp').val(),
							USER_ID_REFERRED: $('#ref_id').val(),
							INCIDENT_FORCE_USD_TP: '',
							INCIDENT_RESTN_USD: '',
							INCIDENT_ACTN_TAKEN_DESC: '',
							CONFIDENTIAL_FLAG: $('#defaultInline2').prop('checked') ? 'Y' : 'N',
							STG_FLAG: $('#defaultInlined').prop('checked') ? 'Y' : 'N',
							PREA_FLAG: $('#defaultInline1').prop('checked') ? 'Y' : 'N',
							REPORTED_DATE: '',
							SUPERVISOR_DATE: '',
							SUPERVISOR_COMMENTS: '',
							SHIFT_COMMANDER_DATE: '',
							SHIFT_COMMANDER_COMMENTS: '',
							REFERRED_TO_DATE: $('#ref_dt').val() != '' ? formatDateWithCurrentTime($('#ref_dt').val()) : getCurrentDateTime(),
							REFERRED_TO_COMMENTS: $('#ref_cmt').val(),
							COMMON_SEQ_NUM: '',
							INCIDENT_DATE_ENTER: $('#entered_dt').val() != '' ? formatDateWithCurrentTime($('#entered_dt').val()) : getCurrentDateTime(),
							incident_date_review: $('#doc_dt').val() != '' ? formatDateWithCurrentTime($('#doc_dt').val()) : getCurrentDateTime(),
							incident_comnt_enter: $('#entered_cmt').val(),
							incident_comnt_reporter: $('#doc_cmt').val(),
							incident_comnt_reviewr: '',
							TITLE_ENTER: $('#entered_title').val() != '' ? $('#entered_title').val() : $('#myTitle').val(),
							TITLE_REFER: $('#ref_title').val(),
							TITLE_REVIEW: '',
							title_reported: $('#doc_title').val(),
							incident_phys_force_flg: '',
							incident_chem_force_flg: '',
							incident_stun_force_flg: '',
							incident_no_force_flg: '',
							ROW_ID: '',
							shift_commander_apr_flag: '',
							incident_location: $('#locationDesc').val(),
							send_notification_flag: $('#entered_inc_comp').prop('checked') ? 'Y' : 'N',
							incident_capstun_force_flg: '',
							report_category: '',
							short_description: $('#shortDesc').val(),
							incident_grp_seq_no: $('#groupNo').val(),
							initial_incident_seq_num: $('#supplimentTo').val(),
							source_type: $('#doc_check').prop('checked') ? 'Y' : 'N',
							reporting_source: '',
							warrant_type: $('#warrentType').val(),
							warrant_number: $('#warrantNumber').val(),
							offender_states_rape: $('#offenderRape').prop('checked') ? 'Y' : 'N',
							sexual_alleg_ref_code: $('#sexAllegation').val(),
							location_category: $('#locationCategory').val(),
							INSERTED_DATE_TIME: getCurrentDateTime(),
							irh_seq_num: ''
						};

						dataToShow0.push(incidentData);

						var approveData = {
							INCIDENT_SEQ_NUM: $('#incidentNo').val(),
							USER_ID: $('#approve_id').val() != '' ? $('#approve_id').val() : userId,
							DATE_REVIEW: $('#approve_dt').val() != '' ? formatDateWithCurrentTime($('#approve_dt').val()) : getCurrentDateTime(),
							TITLE_REVIEW: $('#approve_title').val(),
							INCIDENT_COMNT_REVIEWR: $('#approve_cmt').val(),
							SHIFT_COMMANDER_APR_FLAG: $('#approval_info').val(),
							INCIDENT_FOLOW_REQ_FLG: $('#approve_check').prop('checked') ? 'Y' : 'N',
						};

						dataToShow4.push(approveData);
						if ($('#inv_dt').val() && $('#inv_off_id').val()) {
							var assignInvestigatorData = {
								invg_seq_num: $('#invg_seq_num_hide').val(),
								user_id_invstgr_assigned: $('#inv_off_id').val(),
								invstgr_assigned_date: formatDateWithCurrentTime($('#inv_dt').val()),
								invstgr_assigned_time: $('#inv_tm').val(),
								invstgr_assigned_comment: $('#inv_notes').val(),
								sexual_alleg_ref_code: $('#sexAllegation').val(),
								incident_seq_num: $('#incidentNo').val(),
								inst_num: $('#institution').val(),
								incident_grp_seq_no: $('#groupNo').val()
							};
							dataToShowAssignInvestigator.push(assignInvestigatorData);
						}

						dataToShowOtherInvestigators = otherInvestTable.getData().filter(function (row) {
							return row.assignedTo && !row.invg_forward_seq_num;
						});

						dataToAsnOfc = asnMoreRevTbl.getData().filter(row => row.upd === "Y")
							.map(row => {
								const transformedRow = {...row};
								if (transformedRow.date) {
									transformedRow.date = formatDateWithCurrentTime(transformedRow.date);
								}
								return transformedRow;
							});

						const forwardedByUser = localStorage.getItem('userId');
						dataToShowOtherInvestigators.forEach(function (row) {
							row.date = formatDateTimeFromRow(row.date, row.time);
							row.forwardedByUser = forwardedByUser;
						}); var combinedData = {};
						
						if (dataToShow0.length > 0 || dataToShow1.length > 0 || dataToShow2.length > 0 || dataToShow3.length > 0 || dataToShow4.length > 0 || dataToShow5.length > 0 ||
							dataToAsnOfc.length > 0) {
							
							if (dataToShow0.length > 0) { combinedData.tab0 = dataToShow0; }
							if (dataToShow1.length > 0) { combinedData.tab1 = dataToShow1; }
							if (dataToShow2.length > 0) { combinedData.tab2 = dataToShow2; }
							if (dataToShow3.length > 0) { combinedData.tab3 = dataToShow3; }
							if (dataToShow4.length > 0) { combinedData.tab4 = dataToShow4; }
							if (dataToShow5.length > 0) { combinedData.tab5 = dataToShow5; }
							if (dataToShowAssignInvestigator.length > 0) { combinedData.assignInvestigator = dataToShowAssignInvestigator; }
							if (dataToShowOtherInvestigators.length > 0) { combinedData.otherInvestigators = dataToShowOtherInvestigators; }
							combinedData.genInfo = genInfoTable.getData().filter(row => row.upd === 'Y');
							const reviewerData = asnMoreRevTbl.getData().filter(row => row.refr_user_id);
							if (reviewerData.length > 0) { combinedData.assignMoreReviewers = reviewerData; }
							if (dataToAsnOfc.length > 0) { combinedData.asnOfc = dataToAsnOfc; }
							
							// This AJAX call is updated with error and complete handlers
							$.ajax({
								url: contextPath + "saveIncident",
								type: 'POST',
								contentType: 'application/json',
								data: JSON.stringify(combinedData),
								success: function (response) {
									dataToShow0 = [];
									dataToShow1 = [];
									dataToShow2 = [];
									dataToShow3 = [];
									dataToShow4 = [];
									dataToShow5 = [];
									selData();
									$('#srchPop').trigger('click');
									message('S', 0, 0);
								},
								error: function(jqXHR, textStatus, errorThrown) {
									console.error("Save incident failed:", textStatus, errorThrown);
									message('CER', 'An error occurred while saving the incident.', 0);
								},
								complete: function() {
									isSaving = false;
									$('#save').prop('disabled', false);
								}
							});

						} else {
							console.log("No data available to save.");
							// If there's no data, we should also unlock the button
							isSaving = false;
							$('#save').prop('disabled', false);
						}

					}			$('.tmfld').on('input', function () {
				// Allow only numbers and colon
				this.value = this.value.replace(/[^0-9:]/g, '');
			});
			$('.tmfld').on('blur', function () {
				var timeValue = $(this).val();
				var errorDiv = $('#error');

				if (timeValue.length == 4) {
					var a = timeValue.slice(0, 2);
					var b = timeValue.slice(2, 4);
					$(this).val(a + ':' + b);
					timeValue = a + ':' + b;
				}
				//errorDiv.text(''); // Clear previous error messages
				// Validate the format hh:mm
				const timePattern = /^(?:[01]\d|2[0-3]):[0-5]\d$/;
				if (!timePattern.test(timeValue)) {
					//errorDiv.text('Invalid time format. Please use hh:mm (24-hour format).');
					message('CUW', 'Invalid Time Format', 0);
					$(this).val('');
				}

			});


			// Short Description - max 150 chars
			(function () {
				const shortDescInput = $('#shortDesc');
				const maxLenShortDesc = 150;
				let lastLengthShortDesc = 0;

				shortDescInput.on('input', function () {
					let currentLength = $(this).val().length;

					if (currentLength === maxLenShortDesc && lastLengthShortDesc < maxLenShortDesc) {
						message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
					}

					lastLengthShortDesc = currentLength;

					// Optional: trim if exceeds max
					if (currentLength > maxLenShortDesc) {
						$(this).val($(this).val().substring(0, maxLenShortDesc));
						lastLengthShortDesc = maxLenShortDesc;
					}
				});
			})();

			// Location Description - max 100 chars
			(function () {
				const locationDescInput = $('#locationDesc');
				const maxLenLocation = 100;
				let lastLengthLocation = 0;

				locationDescInput.on('input', function () {
					let currentLength = $(this).val().length;

					if (currentLength === maxLenLocation && lastLengthLocation < maxLenLocation) {
						message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
					}

					lastLengthLocation = currentLength;

					// Optional: trim if exceeds max
					if (currentLength > maxLenLocation) {
						$(this).val($(this).val().substring(0, maxLenLocation));
						lastLengthLocation = maxLenLocation;
					}
				});
			})();




			//Static functions to populate dropdown
			function populateDropdown(data, $dropdown) {

				console.log('call populateDropdown...');

				$dropdown.empty();
				$dropdown.append('<option value="">Location of Occurence</option>');

				myLoc = [];
				myLocNo = [];

				$.each(data, function (index, item) {
					var $option = $('<option></option>').attr('value', item[0]).text(item[1]);

					myLoc.push(item[1]);
					myLocNo.push(item[0] + '--' + item[1]);

					if (item.length > 2 && item[2] !== undefined) {
						$option.attr('data-additional-info', item[2]);
					}

					$dropdown.append($option);
				});
				autocomplete(document.getElementById("location_val"), myLoc);

			}

			function populateDropdown2(data, $dropdown) {

				console.log('call populateDropdown...');

				$dropdown.empty();
				$dropdown.append('<option value="">Location of Occurence</option>');

				$.each(data, function (index, item) {
					var $option = $('<option></option>').attr('value', item[0]).text(item[1]);

					if (item.length > 2 && item[2] !== undefined) {
						$option.attr('data-additional-info', item[2]);
					}

					$dropdown.append($option);
				});

			}

		});

		// Define Test Data
		var tabledatageneralinfo = [
			{
				id: 1,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 2,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 3,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 4,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 5,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 6,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 7,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 8,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: ""
			},
			{
				id: 9,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 10,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 11,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 12,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 13,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 14,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
			{
				id: 15,
				CHECK_BOX_IND: "N",
				INCIDENT_NAME: "",
			},
		];

		//Define Table
		var genInfoTable = new Tabulator("#generalinfo-table", {
			layout: "fitColumns",
			data: tabledatageneralinfo,
			height: '250px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [

				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},

				{
					title: 'rowid',
					visible: false,
					field: "rowid",
				},

				{
					field: "INCIDENT_SEQ_NUM",
					visible: false
				},
				{
					field: "INST_NUM",
					visible: false
				},
				{
					field: "INCIDENT_CODE",
					visible: false
				},
				{
					field: "PREA_FLAG",
					visible: false
				},
				{
					//title: "Select",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Select', 'Select'),
					field: "CHECK_BOX_IND",
					formatter: function (cell) {
						// Create a checkbox element
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						if (cell.getValue() == 'Y') {
							checkbox.checked = true;
						} else {
							checkbox.checked = false;
						}

						checkbox.addEventListener("change", function () {
							// Update the cell value when checkbox is changed
							if (checkbox.checked) {
								cell.setValue('Y');
							} else {
								cell.setValue('N');
							}
							setUpdGen(cell);

						});
						return checkbox; // Return the checkbox element
					},
					width: 100,
				},
				{
					//	title: "Incident Code",
					titleFormatter: (column) => setTitleDesc(column, 'INCIDENT_NAME_tbfld', 'Incident Code'),
					field: "INCIDENT_NAME",
				},
			]
		});

		tabulatorRegistry["generalinfo-table"] = {
			varName: "genInfoTable",
			instance: genInfoTable
		};
		function setUpdGen(cell) {
			const rowData = cell.getRow().getData();

			// Set the 'upd' field to 'Y'
			rowData.upd = "Y";

			// Update the row data
			cell.getRow().update(rowData);
		}


		var dataToShow0 = [];
		var dataToShow1 = [];
		var dataToShow2 = [];
		var dataToShow3 = [];
		var dataToShow4 = [];
		var dataToShow5 = [];
		var delData = [];
		var delInjData = [];

		// Define Test Data
		var tabledataindividualsInvolved = [
			{
				id: 1,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 2,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 3,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 4,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 5,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 6,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 7,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 8,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 9,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 10,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 11,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 12,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 13,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 14,
				checkbox: "t",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
			{
				id: 15,
				INDV_DEL_FLG: "N",
				type: "",
				sbi_no: "",
				NAME_LAST: "",
				NAME_FIRST: "",
				NAME_MIDDLE: "",
				NAME_SUFFIX: "",
				TITLE_PRSN: "",
				SEX: "",
				AGE: "",
				RACE: "",
				INDIVIDUAL_CATEGORY: "",
			},
		];

		//Define Table
		var individualsInvolvedTbl = new Tabulator("#individualsInvolved-table", {
		    layout: "fitColumns",
		    data: tabledataindividualsInvolved,
		    height: '250px',
		    printAsHtml: true,
		    printStyled: true,
		    rowClick: function(e, row){
		        var data = row.getData();
		        if (!data.INDV_SEQ_NUM && data.isNewlyAdded !== true) {
		            return; // Exit the function immediately, preventing highlight and other actions.
		        }
		        highlightTabulatorRow(row);
		        rowIndvClicked(e, row);
		    },
		    columns: [
		        // Hidden technical columns
		        {title: "id", field: "id", visible: false},
		        {title: "upd", visible: false, field: "upd"},
		        {title: "isNewlyAdded", visible: false, field: "isNewlyAdded"}, // Flag for newly added rows
		        {title: "seqno", field: "seqno", visible: false},
		        {title: "rowid", visible: false, field: "rowid"},
		        {title: "INDV_SEQ_NUM", visible: false, field: "INDV_SEQ_NUM"},
		        {title: "COMMIT_NO", visible: false, field: "COMMIT_NO"},

		        // Visible Columns with updated editable logic
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Select1', 'Select'),
		            field: "INDV_DEL_FLG",
		            formatter: function (cell) {
		                var checkbox = document.createElement("input");
		                checkbox.type = "checkbox";
		                checkbox.checked = cell.getValue() == 'Y';
		                var data = cell.getRow().getData();
		                if (!data.INDV_SEQ_NUM && !data.isNewlyAdded) {
		                    checkbox.disabled = true;
		                }
		                checkbox.addEventListener("change", function () {
		                    cell.setValue(checkbox.checked ? 'Y' : 'N');
		                });
		                return checkbox;
		            },
		            width: 100,
		            cellEdited: function (cell) {setUpdIndv(cell);}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Type', 'Type'),
		            field: "LI_INDIVIDUAL_NUM",
		            editor: "list",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            editorParams: {
		                allowEmpty: true,
		                listOnEmpty: true,
		                valuesLookup: true,
		                autocomplete: true,
		                values: {}
		            },
		            cellEdited: function (cell) {
		                setUpdIndv(cell);
		                const row = cell.getRow();
		                const newType = cell.getValue();
		                const idCell = row.getCell("sbi_no");
		                const titlePer = row.getCell("TITLE_PRSN");
		                if (newType === 'STAFF' || newType === 'SUBJECT') {
		                    idCell.setValue("");
		                }
		                if (newType == 'INMATE') {
		                    titlePer.setValue("");
		                }
		            }
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_ID#', 'ID#'),
		            field: "sbi_no",
		            editor: "input",
		            editable: function (cell) {
		                var data = cell.getRow().getData();
		                var type = data.LI_INDIVIDUAL_NUM;
		                var isEditableRow = !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		                return isEditableRow && type === 'INMATE';
		            },
		            cellEdited: function (cell) {
		                checkFunction(cell);
		                const row = cell.getRow();
		                const type = row.getData().LI_INDIVIDUAL_NUM;
		                if (type === "INMATE") {
		                    setTimeout(() => { row.getCell("INDIVIDUAL_CATEGORY").edit(true); }, 10);
		                }
		            }
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_LastName', 'Last Name'),
		            field: "NAME_LAST",
		            editor: "input",
		            editable: function (cell) {
		                var data = cell.getRow().getData();
		                var type = data.LI_INDIVIDUAL_NUM;
		                var isEditableRow = !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		                return isEditableRow && !(type === 'SUBJECT' || type === 'STAFF' || type === 'INMATE');
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {elementAttributes: {maxlength: "20"}}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_FirstName', 'First Name'),
		            field: "NAME_FIRST",
		            editor: "input",
		            editable: function (cell) {
		                var data = cell.getRow().getData();
		                var type = data.LI_INDIVIDUAL_NUM;
		                var isEditableRow = !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		                return isEditableRow && !(type === 'SUBJECT' || type === 'STAFF' || type === 'INMATE');
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {elementAttributes: {maxlength: "15"}}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_MI', 'MI'),
		            field: "NAME_MIDDLE",
		            width: 50,
		            editor: "input",
		            editable: function (cell) {
		                var data = cell.getRow().getData();
		                var type = data.LI_INDIVIDUAL_NUM;
		                var isEditableRow = !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		                return isEditableRow && !(type === 'SUBJECT' || type === 'STAFF' || type === 'INMATE');
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {elementAttributes: {maxlength: "1"}}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Suffix', 'Suffix'),
		            field: "NAME_SUFFIX",
		            width: 100,
		            editor: "input",
		            editable: function (cell) {
		                var data = cell.getRow().getData();
		                var type = data.LI_INDIVIDUAL_NUM;
		                var isEditableRow = !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		                return isEditableRow && !(type === 'SUBJECT' || type === 'STAFF' || type === 'INMATE');
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {elementAttributes: {maxlength: "5"}}
		        },
		        {
		            title: "",
		            field: "",
		            formatter: downloadIcon,
		            width: 20
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Title', 'Title'),
		            field: "TITLE_PRSN",
		            editor: "list",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            editorParams: {
		                allowEmpty: true, listOnEmpty: true, valuesLookup: true, autocomplete: true, values: {}
		            },
		            cellEdited: function (cell) {
		                const type = cell.getRow().getData().LI_INDIVIDUAL_NUM;
		                if (type == 'INMATE') { cell.setValue(""); }
		                setUpdIndv(cell);
		            }
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Sex', 'Sex'),
		            field: "SEX",
		            editor: "list",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {values: {"Male": "Male", "Female": "Female"}}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Age', 'Age'),
		            field: "AGE",
		            width: 100,
		            editor: "input",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);}
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Race', 'Race'),
		            field: "RACE",
		            editor: "list",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {
		                allowEmpty: true, listOnEmpty: true, valuesLookup: true, autocomplete: true, values: {}
		            }
		        },
		        {
		            titleFormatter: (column) => setTitleDesc(column, 'Re_Category', 'Category'),
		            field: "INDIVIDUAL_CATEGORY",
		            editor: "list",
		            editable: function(cell) {
		                var data = cell.getRow().getData();
		                return !!data.INDV_SEQ_NUM || data.isNewlyAdded === true;
		            },
		            cellEdited: function (cell) {setUpdIndv(cell);},
		            editorParams: {
		                allowEmpty: true, listOnEmpty: true, valuesLookup: true, autocomplete: true, values: {}
		            }
		        },
		        {field: "typForceFld", editor: "input", visible: false},
		        {field: "typForceFlag", editor: "input", visible: false},
		        {field: "typRestraintFld", editor: "input", visible: false},
		        {field: "typRestraintFlag", editor: "input", visible: false},
		        {field: "actionTakenFld", editor: "input", visible: false},
		        {field: "actionTakenFlag", editor: "input", visible: false}
		    ]
		});
		
		tabulatorRegistry["individualsInvolved-table"] = {
			varName: "individualsInvolvedTbl",
			instance: individualsInvolvedTbl
		};

		function checkFunction(cell) {
			var row = cell.getRow();
			var rowid = row.getData().id;
			var curr_type = row.getData().LI_INDIVIDUAL_NUM;
			var sbiNo = row.getData().sbi_no;

			if (curr_type.trim() != 'STAFF' && curr_type.trim() != 'SUBJECT') {
				if (sbiNo.length === 8) {
					fetchInmateNames(sbiNo, rowid, cell);
				} else if (sbiNo.length > 0 && sbiNo.length !== 8) {
					message('CUW', 'SBI number must be 8 digits', 0);
					cell.setValue("");
				}
			}
		}



		function changeIdType(cell) {

			var row = cell.getRow();
			var rowid = row.getData().id;
			var curr_type = row.getData().LI_INDIVIDUAL_NUM;

			/*if (curr_type == "STAFF" || curr_type == "SUBJECT") {
				makeCellNonEditable(individualsInvolvedTbl, rowid, 'sbi_no', 'false');
			} else {
				makeCellNonEditable(individualsInvolvedTbl, rowid, 'sbi_no', 'true');
			}*/
			//var sbiNo = row.getData().sbi_no;

			//alert(rowid + ' and ' + curr_type + ' and ' + sbiNo);

			/*alert(curr_type);

			if (curr_type.trim() != 'STAFF' && curr_type.trim() != 'SUBJECT') {
				changeCellEditor(rowid, 'sbi_no', false, cell);
			} else {
				changeCellEditor(rowid, 'sbi_no', "input", cell);
			}*/

		}

		function makeCellNonEditable(tbl, rowId, fieldName, type) {

			//alert(type);
			// Get the row by ID
			var row = tbl.getRow(rowId);
			if (row) {
				// Get the cell by field name
				var cell = row.getCell(fieldName);
				if (cell) {
					// Set the cell to be non-editable
					cell.getElement().setAttribute("contenteditable", type);
				} else {
					console.error("Cell not found for field:", fieldName);
				}
			} else {
				console.error("Row not found for ID:", rowId);
			}
		}

		function changeCellEditor(rowId, fieldName, type, cell) {

			//alert(rowId);
			// Get the cell using row ID and field name
			//var cell = individualsInvolvedTbl.getCell(rowId, fieldName);

			// Check if the cell exists
			if (cell) {
				// Change the editor to 'input'
				//alert(type);
				//alert(typeof type);
				cell.getRow().getTable().getColumn(fieldName).setEditor(type);

				// Optionally, you can start editing the cell immediately
				cell.edit();
			} else {
				console.error("Cell not found for row ID: " + rowId + " and field: " + fieldName);
			}
		}

		function fetchInmateNames(sbiNo, rowid, cell) {
			$.ajax({
				method: "POST",
				url: contextPath + 'getInmateNames',
				dataType: "json",
				data: {
					sbiNo: sbiNo
				},
				success: function (response) {

					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "COMMIT_NO", response[0]['COMMIT_NO']);
					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "NAME_LAST", response[0]['COMMIT_LNAME']);
					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "NAME_FIRST", response[0]['COMMIT_FNAME']);
					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "NAME_MIDDLE", response[0]['COMMIT_MNAME']);
					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "NAME_SUFFIX", response[0]['COMMIT_SNAME']);

					var sex = '';
					if (response[0]['SEX'] == 'M') {
						sex = 'Male';
					}

					if (response[0]['SEX'] == 'F') {
						sex = 'Female';
					}

					setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "SEX", sex);

					if (response[0]['RACE_CODE'] != null) {
						var dynamic_Array3 = JSON.parse($('#race_val').val());
						const selectedOption31 = dynamic_Array3.find(option => option.value === response[0]['RACE_CODE']); // Find the corresponding option
						setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "RACE", selectedOption31.label);
					}

					if (response[0]['PRIMARY_DOB'] != null) {
						var dob = response[0]['PRIMARY_DOB'].split('T')[0];
						setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "AGE", calculateAge(dob));
					}

					setUpdIndv(cell);

					getHousingDtl(response[0]['COMMIT_NO']);
				},
				error: function (error) {
					console.error('Error:', error);
					console.log(error.responseText);
				}
			});
		}

		function calculateAge(dobStr) {
			// Parse the input string "yyyy-mm-dd"
			const [year, month, day] = dobStr.split('-').map(Number);
			// Create a Date object for the birth date
			const birthDate = new Date(year, month - 1, day);
			// Get today's date
			const today = new Date();
			// Calculate age
			let age = today.getFullYear() - birthDate.getFullYear();
			// Adjust if birthday hasn't occurred yet this year
			const hasHadBirthdayThisYear =
				today.getMonth() > birthDate.getMonth() ||
				(today.getMonth() === birthDate.getMonth() && today.getDate() >= birthDate.getDate());
			if (!hasHadBirthdayThisYear) {
				age--;
			}
			return age;
		}



		/*$(document.body).on('change', '.screen_sel', function () {
			var ide = $(this).attr('id');
			ide = ide.split('_')[1];
			alert(ide);
			if($(this).prop('checked')) {
				setValueForRowAndColumn(individualsInvolvedTbl, ide, "Select_val", "Y");	
			} else {
				setValueForRowAndColumn(individualsInvolvedTbl, ide, "Select_val", "N");
			}
			
		});*/

		individualsInvolvedTbl.on("rowClick", function (e, row) {
			rowIndvClicked(e, row);
		});

		function rowIndvClicked(e, row) {
			//alert("Row " + row.getData().user_name + " Clicked!!!!");
			var rowid = row.getData().id;
			$('#current_fld').val(rowid);
			//setDelRow(row);
			if ($('#curr_indv_fld').val() != rowid) {

				$('#curr_indv_fld').val(rowid);

				if (row.getData().typForceFld != '' && row.getData().typForceFld != undefined) {
					//alert('gen from temp');

					parseAndSetTableData(row.getData().typForceFld, tblTypForce, 'F', row.getData().INDV_SEQ_NUM);
					parseAndSetTableData(row.getData().typRestraintFld, tblTypRestraint, 'R', row.getData().INDV_SEQ_NUM);
					parseAndSetTableData(row.getData().actionTakenFld, tblActionTaken, 'A', row.getData().INDV_SEQ_NUM);
				} else {

					if (row.getData().INDV_SEQ_NUM != undefined) {
						//place001
						var typForceStr = "";
						tblTypForce.setData("fetchTypForce?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=" + row.getData().INDV_SEQ_NUM)
							.then(function () {
								var allData = tblTypForce.getData();
								typForceStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.TYPE_OF_FORCE_DESC + ":" + row.TYPE_OF_FORCE;
								}).join(";;");
								console.log(typForceStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typForceFld", typForceStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});

						var typRestraintStr = "";
						tblTypRestraint.setData("fetchTypRestraint?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=" + row.getData().INDV_SEQ_NUM)
							.then(function () {
								var allData = tblTypRestraint.getData();
								typRestraintStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.TYPE_OF_RESTRAINT_DESC + ":" + row.TYPE_OF_RESTRAINT;
								}).join(";;");
								console.log(typRestraintStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typRestraintFld", typRestraintStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});

						var actionTakenStr = "";
						tblActionTaken.setData("fetchActionTaken?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=" + row.getData().INDV_SEQ_NUM)
							.then(function () {
								var allData = tblActionTaken.getData();
								actionTakenStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.ACTION_TAKEN_DESC + ":" + row.ACTION_TAKEN;
								}).join(";;");
								console.log(actionTakenStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "actionTakenFld", actionTakenStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});
					} else {

						var typForceStr = "";
						tblTypForce.setData("fetchTypForce?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=")
							.then(function () {
								var allData = tblTypForce.getData();
								typForceStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.TYPE_OF_FORCE_DESC + ":" + row.TYPE_OF_FORCE;
								}).join(";;");
								console.log(typForceStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typForceFld", typForceStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});

						var typRestraintStr = "";
						tblTypRestraint.setData("fetchTypRestraint?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=")
							.then(function () {
								var allData = tblTypRestraint.getData();
								typRestraintStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.TYPE_OF_RESTRAINT_DESC + ":" + row.TYPE_OF_RESTRAINT;
								}).join(";;");
								console.log(typRestraintStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typRestraintFld", typRestraintStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});

						var actionTakenStr = "";
						tblActionTaken.setData("fetchActionTaken?incidentNo=" + $('#incidentNo').val() + "&instNum=" + $('#institution').val() + "&indSeq=")
							.then(function () {
								var allData = tblActionTaken.getData();
								actionTakenStr = allData.map(function (row) {
									return "N:" + row.CB_SELECT + ":" + row.ACTION_TAKEN_DESC + ":" + row.ACTION_TAKEN;
								}).join(";;");
								console.log(actionTakenStr);
								setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "actionTakenFld", actionTakenStr);
							})
							.catch(function (error) {
								console.error("Error loading data:", error);
							});

					}

				}

				var commit_no = row.getData().COMMIT_NO;

				if (commit_no != '') {
					getHousingDtl(commit_no);
				} else {
					$('#houseDtlInsitution').val('');
					$('#houseDtBuilding').val('');
					$('#houseDtWing').val('');
					$('#houseDtFloor').val('');
					$('#houseDtTier').val('');
					$('#houseDtCell').val('');
					$('#houseDtBed').val('');
				}

			}
		}

		function parseAndSetTableData(inputString, tableInstance, category, indv_seq) {
			var segments = inputString.split(";;");

			var parsedData = segments.map(function (segment) {
				if (!segment || segment.trim() === "") {
					return null;
				}
				var parts = segment.split(":");

				if (parts.length !== 4) {
					console.warn("Malformed segment skipped:", segment);
					return null;
				}

				if (category == 'F') {
					return {
						upd: parts[0].trim(),
						CB_SELECT: parts[1].trim(),  // e.g., "Y"
						TYPE_OF_FORCE_DESC: parts[2].trim(),    // e.g., "Capstun"
						TYPE_OF_FORCE: parts[3].trim(),    // e.g., "04"
						INCIDENT_SEQ_NUM: $('#incidentNo').val(),
						INDV_SEQ_NUM: indv_seq,
						INST_NUM: $('#institution').val(),
					};
				}

				if (category == 'R') {
					return {
						upd: parts[0].trim(),
						CB_SELECT: parts[1].trim(),  // e.g., "Y"
						TYPE_OF_RESTRAINT_DESC: parts[2].trim(),    // e.g., "Capstun"
						TYPE_OF_RESTRAINT: parts[3].trim(),    // e.g., "04"
						INCIDENT_SEQ_NUM: $('#incidentNo').val(),
						INDV_SEQ_NUM: indv_seq,
						INST_NUM: $('#institution').val(),
					};
				}

				if (category == 'A') {
					return {
						upd: parts[0].trim(),
						CB_SELECT: parts[1].trim(),  // e.g., "Y"
						ACTION_TAKEN_DESC: parts[2].trim(),    // e.g., "Capstun"
						ACTION_TAKEN: parts[3].trim(),    // e.g., "04"
						INCIDENT_SEQ_NUM: $('#incidentNo').val(),
						INDV_SEQ_NUM: indv_seq,
						INST_NUM: $('#institution').val(),
					};
				}

			}).filter(function (item) {
				return item !== null;
			});

			console.log("Parsed data array:", parsedData);

			return tableInstance.setData(parsedData)
				.then(function () {
					console.log("Data successfully loaded into table. Row count:", parsedData.length);
					// Optional: Do something after loading, e.g., select rows or trigger events
				})
				.catch(function (error) {
					console.error("Error setting data to table:", error);
				});
		}

		function getHousingDtl(commit_no) {
			$('.hsdt').val('');
			$.ajax({
				method: "POST",
				url: contextPath + 'fetchHousingDtls',
				dataType: "json",
				data: {
					commitNo: commit_no
				},
				success: function (response) {

					$('#houseDtlInsitution').val(response[0]['inst_name']);
					$('#houseDtBuilding').val(response[0]['bld_name']);
					$('#houseDtWing').val(response[0]['unit_desc']);
					$('#houseDtFloor').val(response[0]['floor_desc']);
					$('#houseDtTier').val(response[0]['tier_desc']);
					$('#houseDtCell').val(response[0]['cell_desc']);
					$('#houseDtBed').val(response[0]['bed_desc']);

				},
				error: function (error) {
					console.error('Error:', error);
					console.log(error.responseText);
				}
			});
		}

		injuredTable.on("rowClick", function (e, row) {
			highlightTabulatorRow(row);
			injTblClk(e, row);
		});

		function injTblClk(e, row) {
			var rowid = row.getData().id;
			var desc = row.getData().injuredDesc;
			//alert(desc);
			//alert(rowid);
			$('#curr_vctm_fld').val(rowid);
			//setDelInjRow(row);
			if (desc != undefined && desc != '') {
				$('#InjComments').val(desc);
				$('#injCount').text(desc.length);
			} else {
				$('#InjComments').val('');
				$('#injCount').text('0');
			}

		}

		evidenceTable.on("rowClick", function (e, row) {
			highlightTabulatorRow(row);
			eviTblClk(e, row);
		});

		function eviTblClk(e, row) {
			var rowid = row.getData().id;
			var desc = row.getData().evidenceDesc;
			//alert(rowid);
			$('#curr_eve_fld').val(rowid);
			//setDelInjRow(row);

			if (desc != undefined && desc != '') {
				$('#EveComments').val(desc);
				$('#eviCount').text(desc.length);
			} else {
				$('#EveComments').val('');
				$('#eviCount').text('0');
			}
		}

		$('#InjComments').on('keyup', function () {
			var curr = $('#curr_vctm_fld').val();
			var cmt = $(this).val();
			console.log(curr + ' and ' + cmt);
			setValueForRowAndColumn2(injuredTable, curr, "injuredDesc", cmt.trim());
			setValueForRowAndColumn2(injuredTable, curr, "upd", 'Y');
			var mycell = getCellByFieldAndRowId(injuredTable, "injuredDesc", curr);
			setUpdInj(mycell);
		});

		$('#EveComments').on('keyup', function () {
		    var curr_row_id = $('#curr_eve_fld').val();
		    if (!curr_row_id) return;
		    var comment_text = $(this).val();
		    var row = evidenceTable.getRow(curr_row_id);
		    if (row) {
		        row.update({
		            evidenceDesc: comment_text.trim(),
		            upd: 'Y'
		        });
		        setUpdEve();
		    }
		});

		$('#inciDesc').on('keypress input paste', function () {
			$('#inciCount').text($(this).val().length);
		});

		$('#InjComments').on('keypress input paste', function () {
			$('#injCount').text($(this).val().length);
		});

		$('#EveComments').on('keypress input paste', function () {
			$('#eviCount').text($(this).val().length);
		});

		$('#inv_notes').on('keypress input paste', function () {
			$('#invCount').text($(this).val().length);
		});

		$('#reasonForForwarding').on('keypress input paste', function () {
			$('#reasonCount').text($(this).val().length);
		});

		/*
		$('#entered_cmt').on('keypress input paste', function () {
			$('#enterdcmt').text($(this).val().length);
		});

		$('#doc_cmt').on('keypress input paste', function () {
			$('#doccmts').text($(this).val().length);
		});
		*/

		$('#ref_cmt').on('keypress input paste', function () {
			$('#refcmts').text($(this).val().length);
		});

		$('#follow_outcome_cmt').on('keypress input paste', function () {
			$('#followout_cmt').text($(this).val().length);
		});
		$('#follow_cmt').on('keypress input paste', function () {
			$('#followcmt').text($(this).val().length);
		});

		$('#completedComments').on('keypress input paste', function () {
			$('#completecom').text($(this).val().length);
		});

		$('#approve_cmt').on('keypress input paste', function () {
			$('#appcmt').text($(this).val().length);
		});

		function setNames2(userid, field) {
			$.ajax({
				method: "POST",
				url: contextPath + 'getNames',
				dataType: "json",
				data: {
					userid: userid
				},
				success: function (response) {
					var lname = nullhandlerx(response[0]['USER_LAST_NAME']) + ' ';
					var fname = nullhandlerx(response[0]['USER_FIRST_NAME']) + ' ';
					var mname = nullhandlerx(response[0]['USER_MID_NAME']) + ' ';
					var sname = nullhandlerx(response[0]['USER_SUFFIX_NAME']) + ' ';

					var nam = lname + fname + mname + sname;
					$('#' + field).val(nam);
				},
				error: function (error) {
					console.error('Error:', error);
					console.log(error.responseText);
				}
			});
		}

		standardCheckTbl.on("rowClick", function (e, row) {
			highlightTabulatorRow(row); 
			var rowData = row.getData();
			var rowid = rowData.id;
			var completedByFullName = rowData.completedFullName;
			var initialComment = (rowData.comments || '').toString();
			$('#curr_sup_fld').val(rowid);
			if (completedByFullName) {
				$('#completedBy').val(completedByFullName);
			} else {
				setNames2xx(userId, 'completedBy');
				setTimeout(function () {
					var fetchedName = $('#completedBy').val();
					var targetRow = standardCheckTbl.getRow(rowid);
					if (targetRow) {
						targetRow.update({completedFullName: fetchedName});
					}
				}, 500);
			}
			var maxLen = 500;
			var $textarea = $('#completedComments');
			var $charCounter = $('#completecom');
			var initialValue = initialComment.substring(0, maxLen);
			$textarea.val(initialValue);
			$charCounter.text(initialValue.length);
			$textarea.off('input.completedComments').on('input.completedComments', function () {
				var currentText = $(this).val();
				var currentLength = currentText.length;
				if (currentLength > maxLen) {
					var trimmedText = currentText.substring(0, maxLen);
					$(this).val(trimmedText);
					message('CUW', 'Maximum character limit reached. You cannot paste or type additional text', 0);
					currentLength = maxLen;
				}
				$charCounter.text(currentLength);
				var currentRowId = $('#curr_sup_fld').val();
				var activeRow = standardCheckTbl.getRow(currentRowId);
				if (activeRow) {
					activeRow.update({
						comments: $(this).val(),
						upd: 'Y'
					});
				}
			});
		});

      

		$(document.body).on('click', '.myStaffPopup', function () {
			var idx = $(this).attr('data-idx');
			var ppl_typ = getData(idx, 'LI_INDIVIDUAL_NUM', individualsInvolvedTbl);
			if (ppl_typ == 'STAFF' || ppl_typ == 'SUBJECT') {
				$('#myStaffPop').trigger('click');
			}
		});

		$(document.body).on('click', '.myStaffPopup2', function () {
			var nxt_idx = $(this).attr('data-next');
			var mytitle = $(this).attr('data-title');
			
			$('#staff_title').text('Staff Name');
			
			if(mytitle != undefined && mytitle != '') {
				$('#staff_title').text(mytitle);	
			}
			
			$('#current_fld').val('$fid-' + nxt_idx);
			$('#myStaffPop').trigger('click');
		});

		function getData(rowId, fieldName, tbl) {
			// Get the row by its ID
			var row = tbl.getRow(rowId);
			// Check if the row exists
			if (!row) {
				console.error("Row not found: " + rowId);
				return null;
			}
			// Get the value of the specified field
			var value = row.getData()[fieldName];
			// Return the value
			return value;
		}

		function setDelRow(row) {
			// Get the row data
			const rowData = row.getData();

			// Set the 'upd' field to 'Y'
			//rowData.upd = "Y";

			// Update the row data
			row.update(rowData);
			updatable = true;

			const rows = individualsInvolvedTbl.getRows();
			var data_joint = '';
			dataToShow1 = [];
			//for (let row of rows) {
			const data = row.getData();

			//alert(data.upd);

			//if (data.upd == 'Y') {

			var dynamic_Array = JSON.parse($('#typ_val').val());
			const selectedVal1 = dynamic_Array.find(myval => myval.label === data.LI_INDIVIDUAL_NUM);
			var ind_val = selectedVal1.value;

			var dynamic_Array2 = JSON.parse($('#title_val').val());
			const selectedVal2 = dynamic_Array2.find(myval => myval.label === data.TITLE_PRSN);
			var title_val = selectedVal2.value;

			//alert(ind_val + ' and ' + title_val);

			/*var dynamic_Array = JSON.parse($('#title_val').val());
			const selectedVal2 = dynamic_Array.find(myval => myval.label === data.TITLE_PRSN);*/
			//var title_val = selectedVal2.value;

			//alert(data.INDV_DEL_FLG);

			var indvData = {
				INCIDENT_SEQ_NUM: $('#incidentNo').val(),
				INDV_SEQ_NUM: data.INDV_SEQ_NUM,
				INDIVIDUAL_NUM: ind_val,
				NAME_FIRST: data.NAME_FIRST,
				NAME_LAST: data.NAME_LAST,
				NAME_MIDDLE: data.NAME_MIDDLE,
				NAME_SUFFIX: data.NAME_SUFFIX,
				sex: data.SEX,
				age: data.AGE,
				race: data.RACE,
				COMMIT_NO: data.COMMIT_NO,
				sbi_no: data.sbi_no,
				title_prsn: title_val,
				indv_del_flg: data.INDV_DEL_FLG,
				inst_desc: "",
				user_id: userId,
				inst_num: "03",
				individual_category: data.INDIVIDUAL_CATEGORY,
				ROW_ID: data.rowid
			}

			//!@#$
			delData = [];
			delData.push(indvData); //!@#$%

			//}
			//}
		}
		
		
		function setDelInjRow(row) {
			// Get the row data
			const rowData = row.getData();

			// Set the 'upd' field to 'Y'
			//rowData.upd = "Y";

			// Update the row data
			row.update(rowData);
			updatable = true;

			const rows = injuredTable.getRows();
			var data_joint = '';
			dataToShow1 = [];
			//for (let row of rows) {
			const data = row.getData();

			//alert(data.upd);

			//if (data.upd == 'Y') {
			//alert(ind_val + ' and ' + title_val);

			/*var dynamic_Array = JSON.parse($('#title_val').val());
			const selectedVal2 = dynamic_Array.find(myval => myval.label === data.TITLE_PRSN);*/
			//var title_val = selectedVal2.value;

			//alert(data.INDV_DEL_FLG);

			var VictimData = {
				VICTIM_SEQ_NUM: data.INCD_VCTM_SEQ_NO,
				VCTM_NAME_MIDDLE: "",
				VCTM_NAME_LAST: "",
				VCTM_NAME_SUFFIX: "",
				INCD_VCTM_HSP_FLG: "",
				INCD_VCTM_HSP_LOCN: "",
				inst_num: "03",
				INCIDENT_SEQ_NUM: $('#incidentNo').val(),
				DATE_TIME: getCurrentDateTime(),
				USER: userId,
				COUNT_LOC_CODE: "",
				NATURE_OF_INJURY: "",
				MED_TREATMENT_PROVIDED: ""
			}

			//!@#$
			delInjData = [];
			delInjData.push(VictimData); //!@#$%

			//}
			//}
		}

		function setUpdIndv(cell) {
			// Get the row data and mark it for update
			const rowData = cell.getRow().getData();
			rowData.upd = "Y";
			cell.getRow().update(rowData);

			const rows = individualsInvolvedTbl.getRows();
			dataToShow1 = [];

			for (let row of rows) {
				const data = row.getData();

				if (data.upd == 'Y') {
					// MODIFICATION: Added robust checks to prevent JSON.parse on empty/invalid strings
					var ind_val = "";
					if (data.LI_INDIVIDUAL_NUM && $('#typ_val').val()) {
						try {
							const dynamic_Array = JSON.parse($('#typ_val').val());
							const selectedVal = dynamic_Array.find(myval => myval.label === data.LI_INDIVIDUAL_NUM);
							if (selectedVal) ind_val = selectedVal.value;
						} catch (e) {console.error("Error parsing typ_val JSON:", e);}
					}

					var title_val = "";
					if (data.TITLE_PRSN && $('#title_val').val()) {
						try {
							const dynamic_Array2 = JSON.parse($('#title_val').val());
							const selectedVal2 = dynamic_Array2.find(myval => myval.label === data.TITLE_PRSN);
							if (selectedVal2) title_val = selectedVal2.value;
						} catch (e) {console.error("Error parsing title_val JSON:", e);}
					}

					var race_val = "";
					if (data.RACE && $('#race_val').val()) {
						try {
							const dynamic_Array3 = JSON.parse($('#race_val').val());
							const selectedVal3 = dynamic_Array3.find(myval => myval.label === data.RACE);
							if (selectedVal3) race_val = selectedVal3.value;
						} catch (e) {console.error("Error parsing race_val JSON:", e);}
					}

					var category_val = "";
					if (data.INDIVIDUAL_CATEGORY && $('#category_val').val()) {
						try {
							const dynamic_Array4 = JSON.parse($('#category_val').val());
							const selectedVal4 = dynamic_Array4.find(myval => myval.label === data.INDIVIDUAL_CATEGORY);
							if (selectedVal4) category_val = selectedVal4.value;
						} catch (e) {console.error("Error parsing category_val JSON:", e);}
					}

					var sex = '';
					if (data.SEX === 'Male') {
						sex = 'M';
					} else if (data.SEX === 'Female') {
						sex = 'F';
					}

					var indvData = {
						INCIDENT_SEQ_NUM: $('#incidentNo').val(),
						INDV_SEQ_NUM: data.INDV_SEQ_NUM,
						INDIVIDUAL_NUM: ind_val,
						NAME_FIRST: data.NAME_FIRST,
						NAME_LAST: data.NAME_LAST,
						NAME_MIDDLE: data.NAME_MIDDLE,
						NAME_SUFFIX: data.NAME_SUFFIX,
						sex: sex,
						age: data.AGE,
						race: race_val,
						COMMIT_NO: data.COMMIT_NO,
						sbi_no: data.sbi_no,
						title_prsn: title_val,
						indv_del_flg: data.INDV_DEL_FLG,
						inst_desc: "",
						user_id: userId,
						inst_num: $('#institution').val() || "03", // Use current institution
						individual_category: category_val,
						ROW_ID: data.rowid,
						typForceFlag: data.typForceFlag,
						typForceFld: data.typForceFld,
						typRestraintFlag: data.typRestraintFlag,
						typRestraintFld: data.typRestraintFld,
						actionTakenFlag: data.actionTakenFlag,
						actionTakenFld: data.actionTakenFld
					};

					dataToShow1.push(indvData);
				}
			}
		}		// Define Test Data
		var tabledatatypeforce = [
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
			{
				id: "",
				checkbox: "t",
				typeForce: "",
			},
		];

		function strComposeF(rowid) {
			var typForceStr = "";
			var allData = tblTypForce.getData();
			typForceStr = allData.map(function (row) {
				var updFlag = row.upd;
				if (updFlag == undefined || updFlag == '') {
					updFlag = 'N';
				}
				return updFlag + ":" + row.CB_SELECT + ":" + row.TYPE_OF_FORCE_DESC + ":" + row.TYPE_OF_FORCE;
			}).join(";;");
			console.log(typForceStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typForceFld", typForceStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typForceFlag", "Y");
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "upd", "Y");
			var cell = getCellByRowIdAndColumn23(individualsInvolvedTbl, rowid, "NAME_LAST");
			setUpdIndv(cell);
		}

		function strComposeR(rowid) {
			var typRestraintStr = "";
			var allData = tblTypRestraint.getData();
			typRestraintStr = allData.map(function (row) {
				var updFlag = row.upd;
				if (updFlag == undefined || updFlag == '') {
					updFlag = 'N';
				}
				return updFlag + ":" + row.CB_SELECT + ":" + row.TYPE_OF_RESTRAINT_DESC + ":" + row.TYPE_OF_RESTRAINT;
			}).join(";;");
			console.log(typRestraintStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typRestraintFld", typRestraintStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "typRestraintFlag", "Y");
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "upd", "Y");
			var cell = getCellByRowIdAndColumn23(individualsInvolvedTbl, rowid, "NAME_LAST");
			setUpdIndv(cell);
		}

		function strComposeA(rowid) {
			var actionTakenStr = "";
			var allData = tblActionTaken.getData();
			actionTakenStr = allData.map(function (row) {
				var updFlag = row.upd;
				if (updFlag == undefined || updFlag == '') {
					updFlag = 'N';
				}
				return updFlag + ":" + row.CB_SELECT + ":" + row.ACTION_TAKEN_DESC + ":" + row.ACTION_TAKEN;
			}).join(";;");
			console.log(actionTakenStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "actionTakenFld", actionTakenStr);
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "actionTakenFlag", "Y");
			setValueForRowAndColumn2(individualsInvolvedTbl, rowid, "upd", "Y");
			var cell = getCellByRowIdAndColumn23(individualsInvolvedTbl, rowid, "NAME_LAST");
			setUpdIndv(cell);
		}

		//Define Table
		var tblTypForce = new Tabulator("#typeforce-table", {
			layout: "fitColumns",
			data: tabledatatypeforce,
			height: '155px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [

				{title: "seqno", field: "seqno", visible: false},
				{
					field: "upd",
					visible: false
				},
				{
					field: "INCIDENT_SEQ_NUM",
					visible: false
				},
				{
					field: "INST_NUM",
					visible: false
				},
				{
					field: "INDV_SEQ_NUM",
					visible: false
				},
				{
					field: "TYPE_OF_FORCE",
					visible: false
				},
				{
					title: 'rowid',
					visible: false,
					field: "rowid",
				},
				{
					title: "id",
					field: "id",
					visible: false,
				},
				{
					//title: "Select",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Select2', 'Select'),
					field: "CB_SELECT",
					formatter: function (cell) {
						// Create a checkbox element
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						if (cell.getValue() == 'Y') {
							checkbox.checked = true;
						} else {
							checkbox.checked = false;
						}

						checkbox.addEventListener("change", function () {
							// Update the cell value when checkbox is changed
							if (checkbox.checked) {
								cell.setValue('Y');
							} else {
								cell.setValue('N');
							}

							setUpdGen(cell);
							//alert($('#current_fld').val());
							strComposeF($('#current_fld').val());

							//alert(cell.getRow().getData().INDV_SEQ_NUM);
							//alert(cell.getRow().getData().TYPE_OF_FORCE_DESC);
							//alert($('#current_fld').val());

						});
						return checkbox; // Return the checkbox element
					},
					width: 100,
				},
				{
					//title: "Type of Force",
					titleFormatter: (column) => setTitleDesc(column, 'TYPE_OF_FORCE_DESC_tbfld', 'Type of Force'),
					field: "TYPE_OF_FORCE_DESC",
				},
			]
		});

		tabulatorRegistry["typeforce-table"] = {
			varName: "tblTypForce",
			instance: tblTypForce
		};
		// Define Test Data
		var tabledatatyperestraint = [
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
			{
				id: "",
				checkbox: "t",
				typeRestraint: "",
			},
		];

		//Define Table
		var tblTypRestraint = new Tabulator("#typerestraint-table", {
			layout: "fitColumns",
			data: tabledatatyperestraint,
			height: '155px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					field: "upd",
					visible: false
				},
				{
					field: "INCIDENT_SEQ_NUM",
					visible: false
				},
				{
					field: "INST_NUM",
					visible: false
				},
				{
					field: "INDV_SEQ_NUM",
					visible: false
				},
				{
					field: "TYPE_OF_RESTRAINT",
					visible: false
				},
				{
					//title: "Select",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Select3', 'Select'),
					field: "CB_SELECT",
					formatter: function (cell) {
						// Create a checkbox element
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						if (cell.getValue() == 'Y') {
							checkbox.checked = true;
						} else {
							checkbox.checked = false;
						}

						checkbox.addEventListener("change", function () {
							// Update the cell value when checkbox is changed
							if (checkbox.checked) {
								cell.setValue('Y');
							} else {
								cell.setValue('N');
							}

							setUpdGen(cell);
							strComposeR($('#current_fld').val());

						});
						return checkbox; // Return the checkbox element
					},
					width: 100,
				},
				{
					//	title: "Type of Restraint",
					titleFormatter: (column) => setTitleDesc(column, 'TYPE_OF_RESTRAINT_DESC_tbfld', 'Type of Restraint'),
					field: "TYPE_OF_RESTRAINT_DESC",
				},
			]
		});

		tabulatorRegistry["typerestraint-table"] = {
			varName: "tblTypRestraint",
			instance: tblTypRestraint
		};
		// Define Test Data
		var tabledataactionTaken = [
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
			{
				id: "",
				checkbox: "t",
				actionTaken: "",
			},
		];

		//Define Table
		var tblActionTaken = new Tabulator("#actionTaken-table", {
			layout: "fitColumns",
			data: tabledataactionTaken,
			height: '155px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [

				{title: "id", field: "id", visible: false},

				{title: "seqno", field: "seqno", visible: false},
				{
					field: "upd",
					visible: false
				},
				{
					field: "INCIDENT_SEQ_NUM",
					visible: false
				},
				{
					field: "INST_NUM",
					visible: false
				},
				{
					field: "INDV_SEQ_NUM",
					visible: false
				},
				{
					field: "ACTION_TAKEN",
					visible: false
				},
				{
					//title: "Select",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Select4', 'Select'),
					field: "CB_SELECT",
					formatter: function (cell) {
						// Create a checkbox element
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						if (cell.getValue() == 'Y') {
							checkbox.checked = true;
						} else {
							checkbox.checked = false;
						}

						checkbox.addEventListener("change", function () {
							// Update the cell value when checkbox is changed
							if (checkbox.checked) {
								cell.setValue('Y');
							} else {
								cell.setValue('N');
							}

							setUpdGen(cell);
							strComposeA($('#current_fld').val());

						});
						return checkbox; // Return the checkbox element
					},
					width: 100,
				},
				{
					title: "Action Taken",
					titleFormatter: (column) => setTitleDesc(column, 'ACTION_TAKEN_DESC_tbfld', 'Action Taken'),
					field: "ACTION_TAKEN_DESC",
				},
			]
		});

		tabulatorRegistry["actionTaken-table"] = {
			varName: "tblActionTaken",
			instance: tblActionTaken
		};
		setTimeout(function () {
			genInfoTable.setData("fetchIncidentGenInfo?incidentNo=&instNum=" + $('#institution').val());
			//tblTypForce.setData("getTypeOfForce");
			tblTypForce.setData("fetchTypForce?incidentNo=&instNum=" + $('#institution').val() + "&indSeq=");
			//tblTypRestraint.setData("getTypeOfRestraint");
			tblTypRestraint.setData("fetchTypRestraint?incidentNo=&instNum=" + $('#institution').val() + "&indSeq=");
			//tblActionTaken.setData("getActionTaken");
			tblActionTaken.setData("fetchActionTaken?incidentNo=&instNum=" + $('#institution').val() + "&indSeq=");
		}, 2000);

		// Define Test Data
		var tabledataselectIncident = [
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
			{
				incident: "",
				date: "",
				location: "",
				status: "",
			},
		];

		//Define Table
		var popUpTable = new Tabulator("#selectIncident-table", {
			layout: "fitColumns",
			data: tabledataselectIncident,
			height: '200px',
			printAsHtml: true,
			printStyled: true,
			columns: [

				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					title: "id",
					field: "id",
					visible: false,
				},
				{
					title: "Incident#",
					field: "incident",
				},
				{
					title: "Date",
					field: "date",
				},
				{
					title: "Location",
					field: "location",
				},
				{
					title: "Status",
					field: "status",
				},
			]
		});

		tabulatorRegistry["selectIncident-table"] = {
			varName: "popUpTable",
			instance: popUpTable
		};
		// Define Test Data
		var tabledatagroupSupplementary = [
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
			{
				checkbox: "t",
				incident: "",
				date: "",
				time: "",
				loc: "",
				shortDescription: "",
			},
		];

		//Define Table
		var groupSuppTable = new Tabulator("#groupSupplementary-table", {
			layout: "fitColumns",
			data: tabledatagroupSupplementary,
			height: '200px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					//title: "Select",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Select5', 'Select'),
					field: "checkbox",
					formatter: function (cell) {
						// Create a checkbox element
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						if (cell.getValue() == 'Y') {
							checkbox.checked = true;
						} else {
							checkbox.checked = false;
						}

						checkbox.addEventListener("change", function () {
							// Update the cell value when checkbox is changed
							if (checkbox.checked) {
								cell.setValue('Y');
							} else {
								cell.setValue('N');
							}
							setUpdGen(cell);

						});
						return checkbox; // Return the checkbox element
					},
					width: 90,
					headerSort: false,
				},
				{
					//	title: "Incident#",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Incident#', 'Incident#'),
					field: "incident",
				},
				{
					//	title: "Date",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Date', 'Date'),
					field: "date",
				},
				{
					//	title: "Time",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Time', 'Time'),
					field: "time",
				},
				{
					//	title: "Loc",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Loc', 'Loc'),
					field: "loc",
				},
				{
					//	title: "Short Description",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Description', 'Short Description'),
					field: "shortDescription",
				},
			]
		});

		tabulatorRegistry["groupSupplementary-table"] = {
			varName: "groupSuppTable",
			instance: groupSuppTable
		};

		// Define Test Data
		var tabledataselectCellSearch = [
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
			{
				cellSearch: "",
				reportdate: "",
				searchlocation: "",
				incident: "",
			},
		];

		// Define Test Data
		var tabledatastaffName = [
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
			{
				firstName: "",
				lastName: "",
				mi: "",
				suffix: "",
			},
		];

		//Define Table
		var staffTable = new Tabulator("#staffName-table", {
			layout: "fitColumns",
			//data: tabledatastaffName,
			height: '200px',
			printAsHtml: true,
			printStyled: true,
			columns: [
				{title: "userid", field: "USER_ID", visible: false},
				{title: "title", field: "TITLE", visible: false},
				{title: "Last Name", field: "USER_LAST_NAME"},
				{title: "First Name", field: "USER_FIRST_NAME"},
				{title: "Mi", field: "USER_MID_NAME", width: 50},
				{title: "Suffix", field: "USER_SUFFIX_NAME", width: 100},
			]
		});

		$(document.body).on('keyup', '#srchBar', function (e) {
			if (e.keyCode == 13) {
				$('#searchUser').trigger('click');
			}
		});

		$(document.body).on("click", "#searchUser", function () {
			var value = $('#srchBar').val().toLowerCase();
			setOfficerTab(value);
		});

		function setOfficerTab(srchkey) {
			staffTable.setData('getIncidentStaff?srchkey=' + srchkey);
		}

		function setValueForRowAndColumn2(table, rowNumber, columnField, valueToSet) {
			// Get the row by its index (rowNumber - 1 because rowNumber is 1-based)

			//console.log('Here final check : ' + rowNumber + ' || ' + columnField + ' || ' + valueToSet);

			if (valueToSet == null) {
				valueToSet = '';
			}

			var row = table.getRow(rowNumber);

			// Check if the row exists
			if (row) {
				// Update the specific field in the row
				row.update({[columnField]: valueToSet});
			} else {
				console.error("Row not found");
			}
		}

		function nullhandler2(str) {
			if (str == 'null' || str == null) {
				return '';
			} else {
				return str;
			}
		}

		staffTable.on("rowClick", function (e, row) {
			//alert("Row " + row.getData().user_name + " Clicked!!!!");
			var curr_fld = $('#current_fld').val();

			//$('#current_fld').val('');
			$('.modal-backdrop').hide();
			//$('#cancelOfcrPopup').trigger('click');
			document.getElementById("cancelOfcrPopup").click() ;

			if (curr_fld.search('fid-') != -1) {

				var fid = curr_fld.split('$fid-')[1];

				$('#' + fid).val(row.getData().USER_ID);

				var staff_nm = nullhandler2(row.getData().USER_LAST_NAME) + ' ';
				staff_nm += nullhandler2(row.getData().USER_FIRST_NAME) + ' ';
				staff_nm += nullhandler2(row.getData().USER_MID_NAME) + ' ';
				staff_nm += nullhandler2(row.getData().USER_SUFFIX_NAME) + ' ';

				var nm_id = fid.split('_')[0] + '_name';
				var tit_id = fid.split('_')[0] + '_title';
				$('#' + nm_id).val(staff_nm.trim());

				if (row.getData().TITLE != null && row.getData().TITLE != '') {
					$('#' + tit_id).val(row.getData().TITLE);
				}

			} else {

				var id = row.getData().USER_ID;

				//alert(row.getData().TITLE);
				//!@#$

				if (row.getData().TITLE != null && row.getData().TITLE != '') {
					var dynamic_Array2 = JSON.parse($('#title_val').val());
					const selectedOption21 = dynamic_Array2.find(option => option.value === row.getData().TITLE); // Find the corresponding option
					setValueForRowAndColumn2(individualsInvolvedTbl, curr_fld, "TITLE_PRSN", selectedOption21.label);
				}

				setValueForRowAndColumn2(individualsInvolvedTbl, curr_fld, "NAME_LAST", nullhandler2(row.getData().USER_LAST_NAME));
				setValueForRowAndColumn2(individualsInvolvedTbl, curr_fld, "NAME_FIRST", nullhandler2(row.getData().USER_FIRST_NAME));
				setValueForRowAndColumn2(individualsInvolvedTbl, curr_fld, "NAME_MIDDLE", nullhandler2(row.getData().USER_MID_NAME));
				setValueForRowAndColumn2(individualsInvolvedTbl, curr_fld, "NAME_SUFFIX", nullhandler2(row.getData().USER_SUFFIX_NAME));

				//var cell = row.getCell();
				//var cellElement = e.target.closest(".tabulator-cell");

				var cell = getCellByRowIdAndColumn23(individualsInvolvedTbl, curr_fld, "NAME_LAST");

				setUpdIndv(cell);


			}




		});

		function getCellByRowIdAndColumn23(table, rowId, columnName) {
			// Get the row component by row ID
			var row = table.getRow(rowId);
			if (!row) {
				console.warn("Row not found for ID:", rowId);
				return null;
			}
			// Get the cell component by column field name
			var cell = row.getCell(columnName);
			if (!cell) {
				console.warn("Cell not found for column:", columnName);
				return null;
			}
			return cell;
		}


		var assignLead = [
			{
				id: 0,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 1,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 2,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 3,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 4,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 5,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 6,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 7,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 8,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
			{
				id: 9,
				incident: "",
				date: "",
				time: "",
				shortDescription: "",
			},
		];

		var assignLeadTable = new Tabulator("#assignLead-table", {
			layout: "fitColumns",
			data: assignLead,
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},

				{
					//	title: "Incident#",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Incident#2', 'Incident#'),
					field: "incident",
					width: 100,
				},
				{
					//	title: "Date",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Date1', 'Date'),
					field: "date",
					width: 100,
				},
				{
					//	title: "Time",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Incident#1', 'Time'),
					field: "time",
					width: 100,
				},
				{
					//	title: "Short Description",
					titleFormatter: (column) => setTitleDesc(column, 'Re_Incident#2', 'Incident#'),
					field: "shortDescription",
				},
			]
		});

		tabulatorRegistry["assignLead-table"] = {
			varName: "assignLeadTable",
			instance: assignLeadTable
		};

		var otherInvest = [
			{id: 0, assignedTo: "", date: "", time: "", reasonForForward: ""},
			{id: 1, assignedTo: "", date: "", time: "", reasonForForward: ""},
			{id: 2, assignedTo: "", date: "", time: "", reasonForForward: ""},
			{id: 3, assignedTo: "", date: "", time: "", reasonForForward: ""},
			{id: 4, assignedTo: "", date: "", time: "", reasonForForward: ""},
		];

		var otherInvestTable = new Tabulator("#otherInvest-table", {
			layout: "fitColumns",
			data: otherInvest,
			printAsHtml: true,
			printStyled: true,
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{field: "reasonForForward", visible: false},
				{field: "invg_forward_seq_num", visible: false},
				{field: "user_id", visible: false},
				{
					//title: "Assigned To",
					titleFormatter: (column) => setTitleDesc(column, 'OI_assignedTo_tbfld', 'Assigned To'),
					field: "assignedTo",
				},
				{
					title: "",
					field: "selectBtn",
					formatter: mgcUserIcon,
					width: 40,
					headerSort: false,
					cellClick: function (e, cell) {
						e.preventDefault();
						var rowId = cell.getRow().getData().id;
						$('#investigatorModal').data('row-id', rowId);
						$('#investigatorModal').modal('show');
					}
				},
				{
					//	title: "Date",
					titleFormatter: (column) => setTitleDesc(column, 'OI_date_tbfld', 'Date'),
					field: "date",
					width: 100,
				},
				{
					// title: "Time",
					titleFormatter: (column) => setTitleDesc(column, 'OI_time_tbfld', 'Time'),
					field: "time",
					width: 80,
				},
			]
		});

		tabulatorRegistry["otherInvest-table"] = {
			varName: "otherInvestTable",
			instance: otherInvestTable
		};

		var investigatorDetailsTable = new Tabulator("#investigatorModal-table", {
			layout: "fitColumns",
			height: '200px',
			selectable: 1,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "User ID", field: "USER_ID", visible: false},
				{title: "Last Name", field: "USER_LAST_NAME"},
				{title: "First Name", field: "USER_FIRST_NAME"},
				{title: "MI", field: "USER_MID_NAME", width: 80},
				{title: "Suffix", field: "USER_SUFFIX_NAME", width: 100},
			]
		});

		var investigatorStaffTable = new Tabulator("#investigatorTableModal-table", {
			layout: "fitColumns",
			data: [], // Start with empty data
			height: '200px',
			selectable: 1, // Allow single row selection
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "User ID", field: "USER_ID", visible: false},
				{title: "Last Name", field: "USER_LAST_NAME"},
				{title: "First Name", field: "USER_FIRST_NAME"},
				{title: "MI", field: "USER_MID_NAME", width: 80},
				{title: "Suffix", field: "USER_SUFFIX_NAME", width: 100},
			]
		});

		function mgcUserIcon(cell) {
			return `<a href="#" class="ml-2" data-toggle="tooltip" data-placement="top" data-original-title="Assigned To">					
				                <i class="fa fa-users" text-primary></i>
				            </a>
				    `;
		}

		// Define Test Data
		var tabledataincidentHeader = [
			{
				id: "0",
				supplementary: "",
			},
			{
				id: "1",
				supplementary: "",
			},
			{
				id: "2",
				supplementary: "",
			},
			{
				id: "3",
				supplementary: "",
			},
			{
				id: "4",
				supplementary: "",
			},
			{
				id: "5",
				supplementary: "",
			},
			{
				id: "6",
				supplementary: "",
			},
			{
				id: "7",
				supplementary: "",
			},
			{
				id: "8",
				supplementary: "",
			},
		];

		//Define Table
		var supplimentTbl = new Tabulator("#incidentHeader-table", {
			layout: "fitColumns",
			data: tabledataincidentHeader,
			height: '115px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					//	title: "Supplementary #",
					titleFormatter: (column) => setTitleDesc(column, 'IH_supplementary_tbfld', 'Supplementary #'),
					field: "supplementary",
					headerTooltip: "Supplementary",
				},
			]
		});

		tabulatorRegistry["incidentHeader-table"] = {
			varName: "supplimentTbl",
			instance: supplimentTbl
		};
		// Define Test Data
		var incidentHeadernum = [
			{
				id: "0",
				dReportNum: "",
			},
			{
				id: "1",
				dReportNum: "",
			},
			{
				id: "2",
				dReportNum: "",
			},
			{
				id: "3",
				dReportNum: "",
			},
			{
				id: "4",
				dReportNum: "",
			},
			{
				id: "5",
				dReportNum: "",
			},
			{
				id: "6",
				dReportNum: "",
			},
			{
				id: "7",
				dReportNum: "",
			},
			{
				id: "8",
				dReportNum: "",
			},
		];

		//Define Table 
		var dnumTbl = new Tabulator("#incidentHeadernum-table", {
			layout: "fitColumns",
			data: incidentHeadernum,
			height: '115px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					title: "D Report Num",
					field: "dReportNum",
					headerTooltip: "D Report Num",
				},
			]
		});
		tabulatorRegistry["incidentHeadernum-table"] = {
			varName: "dnumTbl",
			instance: dnumTbl
		};
		// Define Test Data
		var inciReferredHistory = [
			{
				id: "0",
				referredUser: "",
				modifiedBy: "",
				modifiedDate: "",
			},
			{
				id: "1",
				referredUser: "",
				modifiedBy: "",
				modifiedDate: "",
			},
			{
				id: "2",
				referredUser: "",
				modifiedBy: "",
				modifiedDate: "",
			},
			{
				id: "3",
				referredUser: "",
				modifiedBy: "",
				modifiedDate: "",
			},
			{
				id: "4",
				referredUser: "",
				modifiedBy: "",
				modifiedDate: "",
			},
		];

		//Define Table
		var refHistoryTable = new Tabulator("#inciReferredHistory-table", {
			layout: "fitColumns",
			data: inciReferredHistory,
			height: '140px',
			printAsHtml: true,
			printStyled: true,
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{title: "id", field: "id", visible: false},
				{title: "upd", field: "upd", visible: false},
				{title: "seqno", field: "seqno", visible: false},
				{
					//	title: "Referred User",
					titleFormatter: (column) => setTitleDesc(column, 'IRH_referredUser_tbfld', 'Referred User'),
					field: "referredUser",
				},
				{
					//	title: "Modified By",
					titleFormatter: (column) => setTitleDesc(column, 'IRH_modifiedBy_tbfld', 'Modified By'),
					field: "modifiedBy",
				},
				{
					//	title: "Modified Date",
					titleFormatter: (column) => setTitleDesc(column, 'IRH_modifiedDate_tbfld', 'Modified Date'),
					field: "modifiedDate",
					width: 120,
				},
			]
		});

		tabulatorRegistry["inciReferredHistory-table"] = {
			varName: "refHistoryTable",
			instance: refHistoryTable
		};
		// Define Test Data
		var assignMoreReviewers = [
			{id: "0", checkbox: false, lastname: "", firstname: "", mi: "", suffix: "", date: "", time: ""},
			{id: "1", checkbox: false, lastname: "", firstname: "", mi: "", suffix: "", date: "", time: ""},
			{id: "2", checkbox: false, lastname: "", firstname: "", mi: "", suffix: "", date: "", time: ""},
			{id: "3", checkbox: false, lastname: "", firstname: "", mi: "", suffix: "", date: "", time: ""},
			{id: "4", checkbox: false, lastname: "", mi: "", suffix: "", date: "", time: ""},
		];

		var asnMoreRevTbl = new Tabulator("#assignMoreReviewers-table", {
			layout: "fitColumns",
			data: assignMoreReviewers,
			height: '140px',
			rowClick: function(e, row){ highlightTabulatorRow(row); },
			columns: [
				{
					field: "upd", visible: false
				},
				{
					title: "Notify?",
					field: "notify_flg",
					hozAlign: "center",
					width: 100,
					formatter: function (cell, formatterParams, onRendered) {
						var checkbox = document.createElement("input");
						checkbox.type = "checkbox";
						checkbox.checked = cell.getValue() === 'Y';
						checkbox.addEventListener("change", function () {
							cell.setValue(this.checked ? 'Y' : 'N');
						});
						return checkbox;
					}
				},
				{field: "id", visible: false},
				{field: "refr_user_id", visible: false},
				{field: "is_new", visible: false},
				{title: "Last Name", field: "lastname"},
				{title: "First Name", field: "firstname"},
				{title: "MI", field: "mi", width: 80},
				{title: "Suffix", field: "suffix", width: 100},
				{
					title: "",
					field: "selectBtn",
					width: 40,
					hozAlign: "center",
					headerSort: false,
					formatter: function (cell) {
						return '<i class="fa fa-download text-primary" style="cursor:pointer;" title="Select Officer"></i>';
					},
					cellClick: function (e, cell) {
						e.preventDefault();
						var rowId = cell.getRow().getData().id;
						//alert(rowId);
						$('#asn_curr_id').val(rowId);
						$('#officeInformation').data('target-row-id', rowId);
						$('#officeInformation').modal('show');
					}
				},
				{title: "Date", field: "date", width: 100},
				{title: "Time", field: "time", width: 80},
			]
		});

		/*officerInfoModalTable.on("rowClick", function (e, row) {
			var selectedUser = row.getData();
			var targetRowId = $('#officeInformation').data('target-row-id');
			if (targetRowId !== undefined) {
				var targetRow = asnMoreRevTbl.getRow(targetRowId);
				const currentDate = getCurrentDate();
				const now = new Date();
				const currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
				if (targetRow) {
					const isNew = !targetRow.getData().refr_user_id;
					targetRow.update({
						lastname: nullhandler(selectedUser.USER_LAST_NAME),
						firstname: nullhandler(selectedUser.USER_FIRST_NAME),
						mi: nullhandler(selectedUser.USER_MID_NAME),
						suffix: nullhandler(selectedUser.USER_SUFFIX_NAME),
						date: currentDate,
						time: currentTime,
						refr_user_id: selectedUser.USER_ID,
						is_new: isNew
					});
				}
			}
			$('#officeInformation').modal('hide');
		});*/

		$('#officeInformation .modal-footer button:contains("Ok")').on('click', function () {
			var selectedRows = officerInfoModalTable.getSelectedRows();
			if (selectedRows.length > 0) {
				selectedRows[0].select();
				officerInfoModalTable.trigger("rowClick", selectedRows[0]);
			} else {
				$('#officeInformation').modal('hide');
			}
		}); $(tabledatageneralinfo[0].checkbox).html("<input type='checkbox'>");
		$(tabledatatypeforce[0].checkbox).html("<input type='checkbox'>");
		$(tabledatatyperestraint[0].checkbox).html("<input type='checkbox'>");
		$(tabledataactionTaken[0].checkbox).html("<input type='checkbox'>");
		$(tabledatagroupSupplementary[0].checkbox).html("<input type='checkbox'>");
		$(tabledataselectCellSearch[0].checkbox).html("<input type='checkbox'>");
		$(assignMoreReviewers[0].checkbox).html("<input type='checkbox'>");

		function downloadIcon(cell) {
			var myid = cell.getRow().getData().id;
			return `<a href="#" title="Select to Staff & Subject" class="ml-2 myStaffPopup" data-idx="` + myid + `" data-toggle="tooltip" data-placement="top" data-original-title="Entered By" data-class="nav-function-hidden">					
						<i class="fa fa-user" text-primary></i>
					</a>`; // HTML with the icon and the age
		}

		function refferdownloadIcon(cell) {
			return `<span data-toggle="modal" data-target="#officeInformation">
							<a href="#" class="ml-2" data-toggle="tooltip" data-placement="top" data-original-title="namefromListModal">					
								<i class="fa fa-download" text-primary></i>
							</a>
						</span>
					`; // HTML with the icon and the age
		}

		setTimeout(function () {
			$('#ref_tab').attr('href', '#IncidentInfoRefferals_Tab');
			$('#asn_tab').attr('href', '#assignInvestigator_Tab');
		}, 2000);

		$('#gen_tab').trigger('click');

		tabulatorRegistry["generalinfo-table"] = {
			varName: "genInfoTable",
			instance: genInfoTable
		};


		individualsInvolvedTbl["individualsInvolved-table"] = {
			varName: "individualsInvolvedTbl",
			instance: individualsInvolvedTbl
		};




		tblTypForce["#typeforce-table"] = {
			varName: "table",
			instance: table
		};




		tabulatorRegistry["printstatus-table"] = {
			varName: "table",
			instance: table
		};

		//function displayInmateFullname(...parts) {
		// return parts.filter(Boolean).join(", ");
		//}
		
		individualsInvolvedTbl.on("rowClick", function (e, row) {
		            highlightTabulatorRow(row); 
		            rowIndvClicked(e, row);
		        });
		        genInfoTable.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        tblTypForce.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        tblTypRestraint.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        tblActionTaken.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        groupSuppTable.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        assignLeadTable.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        supplimentTbl.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        dnumTbl.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        refHistoryTable.on("rowClick", function(e, row){ highlightTabulatorRow(row); });
		        asnMoreRevTbl.on("rowClick", function(e, row){ highlightTabulatorRow(row); });

	</script>
	<script>
		const inelementleftArrow = document.getElementById("innavleftArrow");
		const inelementRightArrow = document.getElementById("innavRightArrow");
		const inelementNavMain = document.querySelector(".tabsBlock");

		inelementleftArrow.addEventListener("click", function () {
			inelementNavMain.classList.add('leftSide');
			inelementNavMain.classList.remove('rightSide');
			inelementNavMain.scrollBy({
				left: -200,
				behavior: 'smooth'
			});
		});

		inelementRightArrow.addEventListener("click", function () {
			inelementNavMain.classList.add('rightSide');
			inelementNavMain.classList.remove('leftSide');
			inelementNavMain.scrollBy({
				left: 200,
				behavior: 'smooth'
			});
		});
		
		
		
	</script>
	<!--<script src="js/../script.js"></script>
	<script>
		$(document).ready(function () {
			
		});
	</script>-->
	<script type="text/javascript">
		$('#js-page-content').smartPanel();
	</script>
	
	
	
</body>
<!-- BEGIN Page Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/msgBox :: msgBox}"></div>
<!-- END Page Footer -->

</html>